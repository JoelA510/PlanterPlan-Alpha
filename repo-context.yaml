# repo-context.yaml
# PlanterPlan Task Management System
# Generated from codebase analysis
# Last Updated: 2026-02-18 (Post-Refactoring Cycle 5)
# Specification: spec.md

# ==========================================
# 1. SEMANTIC DEPENDENCY GRAPH
# ==========================================
modules:
  # CORE STATE MANAGEMENT
  TasksDomain:
    purpose: "Manages the hierarchical task list, drag-and-drop, and selection state"
    capabilities:
      - "Recursive rendering via TaskTree -> TaskRow"
      - "Drag-and-drop with cycle detection via @dnd-kit"
      - "Task selection for details panel"
      - "Optimistic updates for mutations"
      - "Data fetching via React Query hooks"
    dependencies:
      strong: [useTaskTree, useTaskTreeDnD, useTaskDetails, useTaskMutations]
      weak: [useProjectSelection]
    exports:
      state:
        - tree: "TaskNode[] - Hierarchical task structure"
        - flatTasks: "Task[] - Flat list of tasks"
        - selectedTaskId: "string | null - Currently selected task"
      actions:
        - onSelectTask: "(taskId) -> void"
        - onToggleExpand: "(taskId) -> void"
        - onMoveTask: "(dragged, target) -> void"
    health:
      change_frequency: moderate
      complexity: "Recursive component structure + DnD logic"
      known_issues:
        - "Large trees may require virtualization (future optimization)"

  AuthContext:
    purpose: "Authentication state and user session management"
    capabilities:
      - "Supabase auth integration"
      - "User profile fetching from users table"
      - "Role-based permission checking (Owner, Editor, Coach, Viewer)"
      - "Timeout-guarded admin checks"
    dependencies:
      strong: [supabaseClient, planterClient]
    exports:
      state:
        - user: "User | null - Current authenticated user"
        - session: "Session | null - Supabase session"
        - isAdmin: "boolean - cached admin status"
      actions:
        - login: "(email, password) -> Promise<void>"
        - logout: "() -> Promise<void>"

  ProjectViewLogic:
    purpose: "Project-level data and state managed via hooks"
    capabilities:
      - "Fetches project details and members"
      - "Manages layout logic (sidebar, details panel)"
    dependencies:
      strong: [useProject, useProjectMembers]

  # BUSINESS LOGIC HOOKS
  TaskHooks:
    purpose: "Modular task logic"
    modules:
      useTaskTree:
        capabilities: ["Fetches tasks", "Builds tree structure", "Handles skeleton loading"]
        provides: "tree, isLoading, error"
      useTaskTreeDnD:
        capabilities: ["Manages drag state", "Cycle detection", "Optimistic updates"]
        provides: "dndContextProps, overlay, activeId"
      useTaskMutations:
        capabilities: ["CRUD operations", "Optimistic state updates", "Toast notifications"]
        provides: "createTask, updateTask, deleteTask"
      useTaskDetails:
        capabilities: ["Fetches single task details", "Resource management"]
        provides: "task, isLoading, updateTask"
      useCycleDetection:
        capabilities: ["Graph traversal to prevent circular parent-child relationships"]
        provides: "validateMove(draggedId, newParentId)"

  # UI COMPONENTS
  TaskComponents:
    purpose: "Atomic task interface"
    components:
      TaskTree:
        capabilities: ["Root container", "DndContext provider", "SortableContext"]
        dependencies: [useTaskTreeDnD]
      TaskRow:
        capabilities: ["Recursive rendering", "Sortable item", "Selection handler"]
        dependencies: [TaskRowUI, TaskActions]
      TaskRowUI:
        capabilities: ["Presentational layer", "Indentation", "Status toggling"]
      TaskActions:
        capabilities: ["Action menu", "Add subtask", "Delete task"]
      TaskDetails:
        capabilities: ["Side panel view", "Attribute editing", "Resource attachment"]
        dependencies: [useTaskDetails]

  # SERVICE LAYER
  APIServices:
    purpose: "Supabase data access via planterClient"
    modules:
      taskService:
        capabilities: ["CRUD with RLS", "Tree fetching", "Batch updates"]
        tables: ['tasks', 'task_relationships']
      projectService:
        capabilities: ["Project CRUD", "Member management", "Cloning logic"]
        tables: ['projects', 'project_members']
      resourceService:
        capabilities: ["File/Link attachment"]
        tables: ['task_resources']

# ==========================================
# 2. BEHAVIOR SPECIFICATIONS
# ==========================================
behaviors:
  TaskDragDrop:
    trigger: "User drags task row"
    
    drag_start:
      validates: "user.canEdit"
      stores: "activeId in DnD state"
      shows: "DragOverlay with TaskRow clone"
      
    drag_over:
      calculates: "Potential parent based on indent level (if implemented) or target"
      
    drop:
      validates: "!detectCycle(activeId, overId)"
      actions:
        - "Optimistic update of tree structure"
        - "API call to update parent_task_id and position"
        - "Toast on error (rollback)"
        
    cycle_detection:
      logic: "Traverse up from newParentId; if activeId is encountered, block move."
      
  TaskSelection:
    trigger: "User clicks task title"
    flow:
      - "ProjectView state updates selectedTaskId"
      - "TaskDetails panel slides in/renders"
      - "useTaskDetails fetches full task data (if not in cache)"
      
  TaskCreation:
    trigger: "User clicks 'Add Task' or 'Add Subtask'"
    flow:
      - "Optimistic addition to list/tree"
      - "API call to create task"
      - "Invalidate queries on success"

# ==========================================
# 3. SYSTEM HEALTH INDICATORS
# ==========================================
health_metrics:
  technical_debt:
    low:
      - "Some legacy CSS classes might remain"
      - "Console logs cleaned up in refactoring"
    medium:
      - "Virtualization needed for 1000+ tasks"
      
  test_coverage:
    high: ["E2E (Golden Path)", "Auth Integration", "Security Boundary (XSS, RLS, AuthContext fallback)"]
    moderate: ["Task Tree Logic", "DnD Interactions"]
    
  performance:
    optimizations:
      - "Atomic TaskRow components"
      - "React Query caching (2min staleTime)"
      - "Optimistic updates for DnD"