const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Reports-D6C0vpPD.js","assets/vendor-react-DX4Lmrvn.js","assets/vendor-cookie-CqkleIqs.js","assets/vendor-tanstack-9CpNAsg6.js","assets/icons-BEbz6qOW.js","assets/charts-K6ic3D2m.js","assets/vendor-react-dom-iPqxPKvx.js","assets/vendor-scheduler-7OC5HNn7.js","assets/vendor-clsx-B-dksMZM.js","assets/vendor-es-toolkit-mKl5r5TH.js","assets/vendor-reselect-Cg9BXdu5.js","assets/vendor-react-is-6X3Tk9W0.js","assets/vendor-tiny-invariant-BaFNuDhB.js","assets/vendor-d3-shape-D615ovhT.js","assets/vendor-d3-path-CimkQT29.js","assets/vendor-reduxjs-DBDgQSyU.js","assets/vendor-redux-BXkGT1VS.js","assets/vendor-redux-thunk-ClJT1hhx.js","assets/vendor-react-redux-DFMTQxz_.js","assets/vendor-use-sync-external-store-WPKLZnYO.js","assets/vendor-immer-B82CE1ke.js","assets/vendor-victory-vendor-BJmk5oAg.js","assets/vendor-d3-scale-D4oPfGQv.js","assets/vendor-internmap-BkD7Hj8s.js","assets/vendor-d3-array-g_qRI3rN.js","assets/vendor-d3-time-format-Dzsv3U5k.js","assets/vendor-d3-time-CD8iKzkK.js","assets/vendor-d3-interpolate-BPXZzoDY.js","assets/vendor-d3-color-9lF95FHy.js","assets/vendor-d3-format-CzD4bSOQ.js","assets/vendor-decimal.js-light-DQE-3iDJ.js","assets/vendor-eventemitter3-Cpu8i4ki.js","assets/motion-DvU5AUZF.js","assets/vendor-motion-dom-CcLe_LtT.js","assets/vendor-motion-utils-CYU-yiCP.js","assets/vendor-react-router-ntvFPmC_.js","assets/vendor-react-error-boundary-DeOyvB-M.js","assets/vendor-prop-types-XtUpdism.js","assets/supabase-BEF00O_b.js","assets/vendor-iceberg-js-tWD4K6Lg.js","assets/vendor-tslib-eMSY344_.js","assets/vendor-dnd-kit-C3P6AmvV.js","assets/ui-DuZtC1Lg.js","assets/vendor-react-remove-scroll-B50KC6RJ.js","assets/vendor-react-remove-scroll-bar-C0UMJRvB.js","assets/vendor-react-style-singleton-BBFmicJf.js","assets/vendor-get-nonce-C-Z93AgS.js","assets/vendor-use-sidecar-B4uuF6YV.js","assets/vendor-use-callback-ref-BFr-fhwT.js","assets/vendor-aria-hidden-DvXkyWUv.js","assets/vendor-floating-ui-CXK3Chmc.js","assets/vendor-class-variance-authority-5VPnzWs2.js","assets/vendor-tailwind-merge-COJ8Fh6m.js","assets/vendor-cmdk-DA2qgqDK.js","assets/vendor-date-fns-BhSCcb1h.js","assets/vendor-react-virtuoso-Co0KQAY-.js","assets/vendor-dompurify-HRjpPm7y.js","assets/vendor-react-day-picker-BIIO-C1e.js","assets/vendor-zod-DtU_CG7Y.js","assets/Settings-BTojFgnO.js"])))=>i.map(i=>d[i]);
import{j as e,r as u,a as Xs}from"./vendor-react-DX4Lmrvn.js";import{f as rn,r as er,R as an}from"./vendor-react-dom-iPqxPKvx.js";import{m as ds}from"./vendor-react-error-boundary-DeOyvB-M.js";import{P as b}from"./vendor-prop-types-XtUpdism.js";import{c as nn}from"./supabase-BEF00O_b.js";import{A as yt,m as J}from"./motion-DvU5AUZF.js";import{u as we,L as he,a as tr,b as cs,c as on,R as ln,d as ue,N as dt,B as dn}from"./vendor-react-router-ntvFPmC_.js";import{L as ie,X as vt,C as us,a as cn,b as ht,P as Re,S as un,F as ms,E as mn,c as xn,T as xs,d as hs,e as hn,f as sr,g as rr,h as pn,i as fn,j as Mt,G as ps,B as fs,R as pt,A as ar,D as gn,k as bn,U as Me,M as nr,l as Ie,m as jn,n as ss,o as rs,p as or,q as ir,r as yn,s as vn,t as ze,u as gs,v as Nn,w as wn,x as Ue,y as kn,z as _n,H as lr,I as Cn,J as Tn,K as Sn,N as Pn,O as dr,Q as En,V as Dt,W as Dn,Y as Mn,Z as cr,_ as bs,$ as Rn,a0 as In,a1 as An,a2 as Ln,a3 as ur,a4 as mr,a5 as On,a6 as $n}from"./icons-BEbz6qOW.js";import{u as xr,a as Xe,S as js,v as ys,b as hr,C as pr,c as Rt,d as Je,s as fr,K as gr,P as It,D as At,e as Lt,f as br}from"./vendor-dnd-kit-C3P6AmvV.js";import{S as qn,O as jr,a as Fn,C as yr,b as Un,T as vr,D as Nr,R as Bn,d as wr,e as kr,I as Vn,f as _r,g as Cr,h as zn,i as Tr,V as Kn,L as Sr,j as Pr,k as Hn,l as Wn,m as Er,n as Gn,o as Qn,p as Jn,q as Dr,r as Yn,s as Zn,t as Mr,v as Xn,w as Rr,x as Ir,y as eo,z as Ar,A as Lr,B as Or,E as $r,F as qr,G as Fr,H as Ur,J as to,K as so,M as Br,N as Vr,Q as zr,U as Kr,W as Hr,X as ro}from"./ui-DuZtC1Lg.js";import{c as vs}from"./vendor-class-variance-authority-5VPnzWs2.js";import{c as ao}from"./vendor-clsx-B-dksMZM.js";import{t as no}from"./vendor-tailwind-merge-COJ8Fh6m.js";import{_ as le}from"./vendor-cmdk-DA2qgqDK.js";import{u as Te,a as de,b as oe,Q as oo,c as io}from"./vendor-tanstack-9CpNAsg6.js";import{f as Ne,H as lo,I as As,J as Ge,K as Qe,g as Wr,a as Gr}from"./vendor-date-fns-BhSCcb1h.js";import{Y as co}from"./vendor-react-virtuoso-Co0KQAY-.js";import{p as Qr}from"./vendor-dompurify-HRjpPm7y.js";import{R as uo,T as mo,L as xo,P as ho,a as po,C as fo}from"./charts-K6ic3D2m.js";import{D as go}from"./vendor-react-day-picker-BIIO-C1e.js";import{o as bo,s as lt,d as jo,Z as yo}from"./vendor-zod-DtU_CG7Y.js";import"./vendor-cookie-CqkleIqs.js";import"./vendor-scheduler-7OC5HNn7.js";import"./vendor-iceberg-js-tWD4K6Lg.js";import"./vendor-tslib-eMSY344_.js";import"./vendor-motion-dom-CcLe_LtT.js";import"./vendor-motion-utils-CYU-yiCP.js";import"./vendor-react-remove-scroll-B50KC6RJ.js";import"./vendor-react-remove-scroll-bar-C0UMJRvB.js";import"./vendor-react-style-singleton-BBFmicJf.js";import"./vendor-get-nonce-C-Z93AgS.js";import"./vendor-use-sidecar-B4uuF6YV.js";import"./vendor-use-callback-ref-BFr-fhwT.js";import"./vendor-aria-hidden-DvXkyWUv.js";import"./vendor-floating-ui-CXK3Chmc.js";import"./vendor-use-sync-external-store-WPKLZnYO.js";import"./vendor-es-toolkit-mKl5r5TH.js";import"./vendor-reselect-Cg9BXdu5.js";import"./vendor-react-is-6X3Tk9W0.js";import"./vendor-tiny-invariant-BaFNuDhB.js";import"./vendor-d3-shape-D615ovhT.js";import"./vendor-d3-path-CimkQT29.js";import"./vendor-reduxjs-DBDgQSyU.js";import"./vendor-redux-BXkGT1VS.js";import"./vendor-redux-thunk-ClJT1hhx.js";import"./vendor-react-redux-DFMTQxz_.js";import"./vendor-immer-B82CE1ke.js";import"./vendor-victory-vendor-BJmk5oAg.js";import"./vendor-d3-scale-D4oPfGQv.js";import"./vendor-internmap-BkD7Hj8s.js";import"./vendor-d3-array-g_qRI3rN.js";import"./vendor-d3-time-format-Dzsv3U5k.js";import"./vendor-d3-time-CD8iKzkK.js";import"./vendor-d3-interpolate-BPXZzoDY.js";import"./vendor-d3-color-9lF95FHy.js";import"./vendor-d3-format-CzD4bSOQ.js";import"./vendor-decimal.js-light-DQE-3iDJ.js";import"./vendor-eventemitter3-Cpu8i4ki.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=r(n);fetch(n.href,i)}})();const vo="modulepreload",No=function(t){return"/"+t},Ls={},Jr=function(s,r,a){let n=Promise.resolve();if(r&&r.length>0){let d=function(c){return Promise.all(c.map(x=>Promise.resolve(x).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),o=l?.nonce||l?.getAttribute("nonce");n=d(r.map(c=>{if(c=No(c),c in Ls)return;Ls[c]=!0;const x=c.endsWith(".css"),p=x?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const h=document.createElement("link");if(h.rel=x?"stylesheet":vo,x||(h.as="script"),h.crossOrigin="",h.href=c,o&&h.setAttribute("nonce",o),document.head.appendChild(h),x)return new Promise((m,f)=>{h.addEventListener("load",m),h.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(l){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=l,window.dispatchEvent(o),!o.defaultPrevented)throw l}return n.then(l=>{for(const o of l||[])o.status==="rejected"&&i(o.reason);return s().catch(i)})},Ns=({icon:t,title:s,description:r,children:a,actions:n,className:i="",variant:l="neutral"})=>{const o={neutral:"bg-card text-card-foreground",error:"bg-card text-card-foreground",success:"bg-emerald-50 dark:bg-emerald-900/10"},d={neutral:"text-card-foreground",error:"text-rose-600 dark:text-rose-400",success:"text-emerald-800 dark:text-emerald-400"};return e.jsxs("div",{className:`flex flex-col items-center justify-center p-8 text-center rounded-xl shadow-sm border border-slate-200 dark:border-border ${o[l]} ${i}`,children:[t&&e.jsx("div",{className:"w-16 h-16 mb-6 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-slate-400 dark:text-slate-500",children:t}),e.jsx("h3",{className:`text-xl font-semibold mb-2 ${d[l]}`,children:s}),r&&e.jsx("p",{className:"text-slate-500 dark:text-slate-400 max-w-md mb-6 leading-relaxed",children:r}),a,n&&e.jsx("div",{className:"flex items-center gap-4 mt-6",children:n})]})};Ns.propTypes={icon:b.node,title:b.string.isRequired,description:b.string,children:b.node,actions:b.node,className:b.string,variant:b.oneOf(["neutral","error","success"])};const ws=({error:t,resetErrorBoundary:s})=>e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4",children:e.jsxs(Ns,{title:"Something went wrong",variant:"error",actions:e.jsx("button",{onClick:s,className:"btn-primary",children:"Try Again"}),children:[e.jsx("div",{className:"text-left bg-slate-100 p-4 rounded mb-6 overflow-auto max-h-40 text-sm font-mono text-slate-700 w-full",children:t.message}),e.jsx("p",{className:"text-slate-600 mb-6",children:"We apologize for the inconvenience. Please try reloading the application."})]})}),wo="https://zqgoeblsbbtlbcvweisr.supabase.co",ko="sb_publishable_ibOO0jwtV0N_N0sdFOm2xQ_2ZHU7reM",Q=nn(wo,ko),Yr=u.createContext({}),ce=()=>{const t=u.useContext(Yr);if(!t)throw new Error("useAuth must be used within an AuthProvider");return t};function _o({children:t}){console.log("AuthContext loaded v2 - TIMEOUT 2000ms");const[s,r]=u.useState(null),[a,n]=u.useState(!0);u.useEffect(()=>{let c=0,x=!0;const p=async m=>{const f=++c;if(!m?.user){if(!x||f!==c)return;r(null),n(!1);return}r(j=>{const N=j?.id===m.user.id?j.role:m.user.role||null;return{...m.user,role:N}});try{console.log("AuthContext: checking admin status for",m.user.id);const j=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",N=(y,k=1e4)=>Promise.race([y,new Promise((D,T)=>setTimeout(()=>{T(new Error(`RPC Timeout after ${k}ms`))},k))]);if(j){console.log("[AuthContext] E2E Mode: Setting User immediately, RPC in background"),r(y=>({...y,role:y.role||"owner"})),n(!1),Q.rpc("is_admin",{p_user_id:m.user.id}).then(({data:y})=>{!x||f!==c||y&&r(k=>({...k,role:"admin"}))}).catch(y=>console.warn("Background RPC failed",y));return}const{data:g,error:v}=await N(Q.rpc("is_admin",{p_user_id:m.user.id}),3e4).catch(y=>(console.error("AuthContext: RPC Timed out or crashed",y),{error:y}));if(!x||f!==c)return;v?(console.error("AuthContext: RPC error",v),r(y=>({...m.user,role:y?.role||m.user.role||"viewer"}))):(console.log("[AuthContext] Setting User (Admin/Owner)"),r({...m.user,role:g?"admin":"owner"}))}catch(j){console.error("AuthContext: RPC crashed",j),x&&f===c&&r(N=>({...m.user,role:N?.role||m.user.role||"viewer"}))}finally{x&&f===c&&(console.log("[AuthContext] setLoading(false)"),n(!1))}},{data:{subscription:h}}=Q.auth.onAuthStateChange(async(m,f)=>{m==="SIGNED_OUT"?(c++,r(null),n(!1)):m==="SIGNED_IN"||m==="TOKEN_REFRESHED"||m==="INITIAL_SESSION"?await p(f):f&&await p(f)});return()=>{x=!1,h.unsubscribe()}},[]);const i=async(c,x,p={})=>{try{const{data:h,error:m}=await Q.auth.signUp({email:c,password:x,options:{data:p}});if(m)throw m;return{data:h,error:null}}catch(h){return{data:null,error:h}}},l=async(c,x)=>{try{const{data:p,error:h}=await Q.auth.signInWithPassword({email:c,password:x});if(h)throw h;return{data:p,error:null}}catch(p){return{data:null,error:p}}},o=async()=>{try{const{error:c}=await Q.auth.signOut();if(c)throw c}catch(c){console.error("Error signing out:",c)}},d=u.useMemo(()=>({user:s,loading:a,signUp:i,signIn:l,signOut:o}),[s,a]);return e.jsx(Yr.Provider,{value:d,children:t})}const Zr=u.createContext(),Co=()=>{const t=u.useContext(Zr);if(!t)throw new Error("useToast must be used within a ToastProvider");return t},To=({children:t})=>{const[s,r]=u.useState([]),a=u.useCallback((i,l="info")=>{const o=Date.now();r(d=>[...d,{id:o,message:i,type:l}]),setTimeout(()=>{r(d=>d.filter(c=>c.id!==o))},3e3)},[]),n=u.useCallback(i=>{r(l=>l.filter(o=>o.id!==i))},[]);return e.jsxs(Zr.Provider,{value:{addToast:a,removeToast:n},children:[t,e.jsx("div",{className:"fixed bottom-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none",children:e.jsx(yt,{children:s.map(i=>e.jsx(J.div,{initial:{opacity:0,y:50,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,scale:.9,transition:{duration:.2}},layout:!0,onClick:()=>n(i.id),className:`
                pointer-events-auto cursor-pointer rounded-lg px-4 py-3 shadow-md text-sm font-medium
                transform transition-all duration-300 hover:scale-105 active:scale-95
                ${i.type==="success"?"bg-green-500 text-white":i.type==="error"?"bg-red-500 text-white":"bg-slate-800 text-white"}
              `,children:e.jsxs("div",{className:"flex items-center gap-2",children:[i.type==="success"&&e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})}),i.type==="error"&&e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})}),i.message]})},i.id))})})]})},Xr=u.createContext(void 0),Os="planterplan-theme";function So({children:t}){const[s,r]=u.useState(()=>typeof window<"u"&&localStorage.getItem(Os)||"system"),[a,n]=u.useState(()=>typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),i=u.useMemo(()=>s==="system"?a:s,[s,a]);u.useEffect(()=>{const d=document.documentElement;i==="dark"?d.classList.add("dark"):d.classList.remove("dark")},[i]),u.useEffect(()=>{if(typeof window>"u")return;const d=window.matchMedia("(prefers-color-scheme: dark)"),c=x=>{n(x.matches?"dark":"light")};return d.addEventListener("change",c),()=>d.removeEventListener("change",c)},[]);const l=u.useCallback(d=>{r(d),localStorage.setItem(Os,d)},[]),o=u.useCallback(()=>{l(i==="light"?"dark":"light")},[i,l]);return e.jsx(Xr.Provider,{value:{theme:s,resolvedTheme:i,setTheme:l,toggleTheme:o},children:t})}function Po(){const t=u.useContext(Xr);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}const $={OWNER:"owner",EDITOR:"editor",COACH:"coach",VIEWER:"viewer",LIMITED:"limited",ADMIN:"admin"},R={TODO:"todo",IN_PROGRESS:"in_progress",BLOCKED:"blocked",COMPLETED:"completed",OVERDUE:"overdue"},W={PLANNING:"planning",IN_PROGRESS:"in_progress",LAUNCHED:"launched",PAUSED:"paused"},ea=1e4,ta=u.createContext(void 0),Eo=[$.ADMIN,$.OWNER],$s=[{value:$.ADMIN,label:"Admin"},{value:$.OWNER,label:"Owner"},{value:$.EDITOR,label:"Editor"},{value:$.COACH,label:"Coach"},{value:$.LIMITED,label:"Limited"},{value:$.VIEWER,label:"Viewer"}];function Do({children:t,userRole:s=$.VIEWER}){const[r,a]=u.useState(null),n=u.useMemo(()=>Eo.includes(s),[s]),i=u.useMemo(()=>r&&n?r:s,[r,n,s]),l=u.useMemo(()=>n?s===$.ADMIN?$s:s===$.OWNER?$s.filter(x=>x.value!==$.ADMIN):[]:[],[n,s]),o=u.useCallback(x=>{n&&a(x)},[n]),d=u.useCallback(()=>{a(null)},[]),c=u.useMemo(()=>({actualRole:s,viewingAs:r,effectiveRole:i,canViewAs:n,availableRoles:l,setViewingAs:o,resetViewAs:d}),[s,r,i,n,l,o,d]);return e.jsx(ta.Provider,{value:c,children:t})}function Mo(){const t=u.useContext(ta);if(t===void 0)throw new Error("useViewAs must be used within a ViewAsProvider");return t}function Ro(t){return t?t.role===$.ADMIN?$.ADMIN:$.OWNER:$.VIEWER}function Io({children:t}){const{user:s}=ce(),r=Ro(s);return e.jsx(Do,{userRole:r,children:t})}const sa=()=>e.jsxs("div",{className:"animate-pulse px-3 py-4 space-y-4","data-testid":"sidebar-skeleton",children:[e.jsx("div",{className:"h-4 bg-slate-200 rounded w-3/4 mb-6"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-full"}),e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-5/6"}),e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-full"}),e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-4/5"})]}),e.jsx("div",{className:"h-px bg-slate-200 my-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-full"}),e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-2/3"}),e.jsx("div",{className:"h-8 bg-slate-100 rounded-md w-5/6"})]})]}),Ao=20,Lo=1e6,_e={ADD_TOAST:"ADD_TOAST",UPDATE_TOAST:"UPDATE_TOAST",DISMISS_TOAST:"DISMISS_TOAST",REMOVE_TOAST:"REMOVE_TOAST"};let Jt=0;function Oo(){return Jt=(Jt+1)%Number.MAX_VALUE,Jt.toString()}const Yt=new Map,qs=t=>{if(Yt.has(t))return;const s=setTimeout(()=>{Yt.delete(t),ut({type:_e.REMOVE_TOAST,toastId:t})},Lo);Yt.set(t,s)},$o=(t,s)=>{switch(s.type){case _e.ADD_TOAST:return{...t,toasts:[s.toast,...t.toasts].slice(0,Ao)};case _e.UPDATE_TOAST:return{...t,toasts:t.toasts.map(r=>r.id===s.toast.id?{...r,...s.toast}:r)};case _e.DISMISS_TOAST:{const{toastId:r}=s;return r?qs(r):t.toasts.forEach(a=>{qs(a.id)}),{...t,toasts:t.toasts.map(a=>a.id===r||r===void 0?{...a,open:!1}:a)}}case _e.REMOVE_TOAST:return s.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(r=>r.id!==s.toastId)}}},St=[];let Pt={toasts:[]};function ut(t){Pt=$o(Pt,t),St.forEach(s=>{s(Pt)})}function as({...t}){const s=Oo(),r=n=>ut({type:_e.UPDATE_TOAST,toast:{...n,id:s}}),a=()=>ut({type:_e.DISMISS_TOAST,toastId:s});return ut({type:_e.ADD_TOAST,toast:{...t,id:s,open:!0,onOpenChange:n=>{n||a()}}}),{id:s,dismiss:a,update:r}}function Nt(){const[t,s]=u.useState(Pt);return u.useEffect(()=>(St.push(s),()=>{const r=St.indexOf(s);r>-1&&St.splice(r,1)}),[t]),{...t,toast:as,dismiss:r=>ut({type:_e.DISMISS_TOAST,toastId:r})}}const qo=()=>{const[t,s]=u.useState(""),[r,a]=u.useState(""),[n,i]=u.useState(!1),[l,o]=u.useState(!1),{signIn:d,signUp:c}=ce(),x=we(),{toast:p}=Nt(),h=async m=>{m.preventDefault(),o(!0);try{let f;if(n?f=await c(t,r):f=await d(t,r),f.error)throw f.error;x("/dashboard")}catch(f){p({title:n?"Sign up failed":"Login failed",description:f.message||"An unexpected error occurred",variant:"destructive"})}finally{o(!1)}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-slate-50 dark:bg-background",children:e.jsxs("div",{className:"max-w-md w-full space-y-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"mt-6 text-center text-3xl font-extrabold text-brand-600",children:"PlanterPlan"}),e.jsx("p",{className:"mt-2 text-center text-sm text-slate-600 dark:text-muted-foreground",children:n?"Create your account":"Sign in to your account"})]}),e.jsx("form",{className:"bg-white dark:bg-card py-8 px-4 shadow sm:rounded-lg sm:px-10",onSubmit:h,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-slate-700 dark:text-foreground",children:"Email address"}),e.jsx("input",{id:"email",name:"email",type:"email",required:!0,className:"mt-1 appearance-none relative block w-full px-3 py-2 border border-slate-300 dark:border-input placeholder-slate-400 dark:bg-background dark:text-foreground rounded focus:outline-none focus:ring-brand-500 focus:border-brand-500",placeholder:"Enter your email",value:t,onChange:m=>s(m.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-slate-700 dark:text-foreground",children:"Password"}),e.jsx("input",{id:"password",name:"password",type:"password",required:!0,className:"mt-1 appearance-none relative block w-full px-3 py-2 border border-slate-300 dark:border-input placeholder-slate-400 dark:bg-background dark:text-foreground rounded focus:outline-none focus:ring-brand-500 focus:border-brand-500",placeholder:"Enter your password",value:r,onChange:m=>a(m.target.value)})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:l,className:"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500/20 disabled:opacity-50 transition-colors shadow-sm",children:l?e.jsx(ie,{className:"w-5 h-5 animate-spin"}):n?"Sign Up":"Sign In"})}),e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",className:"text-sm text-brand-600 hover:text-brand-500 font-medium",onClick:()=>i(!n),children:n?"Already have an account? Sign in":"Need an account? Sign up"})})]})})]})})},ks=(t,s)=>{const[r,a]=u.useState(t),[n,i]=u.useState({}),[l,o]=u.useState(!1),[d,c]=u.useState(!1),[x,p]=u.useState(""),h=u.useCallback(g=>{const{name:v,value:y}=g.target;a(k=>({...k,[v]:y})),i(k=>{if(!k[v])return k;const D={...k};return delete D[v],D})},[]),m=u.useCallback(g=>{a(v=>{const y={...v,title:g.title??v.title,description:g.description??v.description,notes:g.notes??v.notes,purpose:g.purpose??v.purpose,actions:g.actions??v.actions,resources:g.resources??v.resources,templateId:g.id};return(Object.prototype.hasOwnProperty.call(v,"days_from_start")||g.days_from_start!==void 0)&&g.days_from_start!==null&&g.days_from_start!==void 0&&(y.days_from_start=String(g.days_from_start)),g.start_date&&(y.start_date=g.start_date.split("T")[0]),g.due_date&&(y.due_date=g.due_date.split("T")[0]),y}),p(g.title||"")},[]),f=u.useCallback(()=>{c(!0)},[]),j=u.useCallback(()=>{c(!1)},[]);return{formData:r,setFormData:a,errors:n,setErrors:i,isSubmitting:l,showResourceCreator:d,lastAppliedTaskTitle:x,handleChange:h,handleApplyFromLibrary:m,handleCreateResource:f,dismissResourceCreator:j,handleSubmit:async(g,v,y)=>{if(g.preventDefault(),s){const k=s(r);if(Object.keys(k).length>0){i(k);return}}o(!0);try{await v(r),y&&y(),p(""),c(!1)}catch(k){i(D=>({...D,submit:k.message||"Failed to save"}))}finally{o(!1)}}}},Fo=(t,s=300)=>{const[r,a]=u.useState(t);return u.useEffect(()=>{const n=setTimeout(()=>{a(t)},s);return()=>{clearTimeout(n)}},[t,s]),r},Uo="tasks_with_primary_resource",Fs=20,Bo=["id","title","origin"],Vo=(t,s)=>Number.isFinite(t)?Math.max(0,Math.floor(t)):s,zo=t=>typeof t!="object"||t===null?!1:Bo.every(s=>s==="id"?typeof t[s]=="string"||typeof t[s]=="number":typeof t[s]=="string"&&t[s].trim().length>0),Ko=t=>t.replace(/[\\%_]/g,s=>`\\${s}`),Ho=async({query:t,limit:s=Fs,resourceType:r=null,signal:a}={},n=Q)=>{const i=typeof t=="string"?t.trim().slice(0,100):"";if(!i)return[];const l=Math.max(1,Vo(s,Fs)),o=`"%${Ko(i)}%"`;let d=n.from(Uo).select("*").eq("origin","template").or(`title.ilike.${o},description.ilike.${o}`).order("title",{ascending:!0}).limit(l);r&&r!=="all"&&(d=d.eq("resource_type",r)),a&&(d=d.abortSignal(a));try{const{data:c,error:x}=await d;if(a?.aborted)throw new DOMException("Request aborted","AbortError");if(x)throw x;return Array.isArray(c)?{data:c.filter(h=>{const m=zo(h);return m||console.warn("[taskMasterLibraryService.searchMasterLibraryTasks] Dropping malformed task record:",h),m}),error:null}:(console.warn("[taskMasterLibraryService.searchMasterLibraryTasks] Unexpected payload shape:",c),[])}catch(c){if(c?.name==="AbortError")throw c;return console.error("[taskMasterLibraryService.searchMasterLibraryTasks] Fatal error:",c),{data:null,error:c}}},Wo=15,Zt={results:[],isLoading:!1,error:null},Go=({query:t,limit:s=Wo,resourceType:r=null,enabled:a=!0,debounceMs:n=300}={})=>{const[i,l]=u.useState(Zt),o=Fo(t,n),d=u.useRef(null),c=u.useRef(0),x=u.useRef({}),p=u.useCallback(async(h,m)=>{if(x.current[h]){l({results:x.current[h],isLoading:!1,error:null});return}d.current&&d.current!==m&&d.current.abort(),d.current=m;const f=Date.now();c.current=f,l(j=>({...j,isLoading:!0,error:null}));try{const{data:j,error:N}=await Ho({query:h,limit:s,resourceType:r,signal:m.signal});if(c.current!==f)return;if(N)throw N;x.current[h]=j||[],l({results:j||[],isLoading:!1,error:null}),d.current===m&&(d.current=null)}catch(j){if(j?.name==="AbortError"||c.current!==f)return;l({results:[],isLoading:!1,error:j}),d.current===m&&(d.current=null)}},[s,r]);return u.useEffect(()=>{if(!a){d.current&&(d.current.abort(),d.current=null),l(Zt);return}const h=typeof o=="string"?o.trim():"";if(!h){d.current&&(d.current.abort(),d.current=null),l(Zt);return}const m=new AbortController;return p(h,m),()=>{d.current===m?(d.current.abort(),d.current=null):m.abort()}},[o,a,p]),{...i,hasResults:i.results.length>0}},Qo=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Jo=(t,s)=>{const r=typeof t=="string"?t:"",a=typeof s=="string"?s.trim():"";if(!a)return[{text:r,isMatch:!1}];const n=new RegExp(Qo(a),"ig"),i=[];let l=0,o;for(;(o=n.exec(r))!==null;){const d=o.index;d>l&&i.push({text:r.slice(l,d),isMatch:!1}),i.push({text:o[0],isMatch:!0}),l=d+o[0].length}return i.length===0?[{text:r,isMatch:!1}]:(l<r.length&&i.push({text:r.slice(l),isMatch:!1}),i)},Xt=2,Yo=300,ra=({onSelect:t,onCreateResource:s,mode:r="copy",label:a="Search & pick from Master Library",placeholder:n="Search by title or descriptionâ€¦"})=>{const[i,l]=u.useState(""),[o,d]=u.useState(-1),c=u.useId(),x=u.useRef(null),p=i.trim().length>=Xt,{results:h,isLoading:m,error:f,hasResults:j}=Go({query:i,limit:15,debounceMs:Yo,enabled:p}),N=u.useCallback(T=>{const A=T.target.value;l(A),A.trim().length<Xt&&d(-1)},[]),g=u.useMemo(()=>{if(!(o<0||o>=h.length))return`${c}-item-${h[o].id}`},[o,c,h]),v=u.useCallback(T=>{t&&t(T),l(T.title??""),d(-1)},[t]),y=u.useCallback(T=>{j&&(T.key==="ArrowDown"?(T.preventDefault(),d(A=>{const S=A+1;return S>=(h?.length||0)?0:S})):T.key==="ArrowUp"?(T.preventDefault(),d(A=>{const S=A-1;return S<0?h.length-1:S})):T.key==="Enter"&&o>=0&&o<h.length?(T.preventDefault(),v(h[o])):T.key==="Escape"&&d(-1))},[j,h,o,v]),k=u.useMemo(()=>r==="view"?"View task":"Copy to form",[r]),D=T=>T==null?null:p?Jo(T,i).map((S,O)=>S.isMatch?e.jsx("mark",{className:"rounded bg-amber-200 px-0.5 text-slate-900",children:S.text},`${S.text}-${O}`):e.jsx(u.Fragment,{children:S.text},`${S.text}-${O}`)):T;return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600",htmlFor:`master-library-search-${c}`,children:a}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{ref:x,id:`master-library-search-${c}`,type:"search",className:"form-input",placeholder:n,value:i,onChange:N,onKeyDown:y,"aria-autocomplete":"list","aria-controls":j?c:void 0,"aria-activedescendant":g,"aria-expanded":j,role:"combobox","aria-haspopup":"listbox"}),i.length>0&&!m&&e.jsx("button",{type:"button",onClick:()=>{l(""),x.current?.focus()},className:"absolute inset-y-0 right-3 flex items-center text-slate-400 hover:text-slate-600","aria-label":"Clear search",children:e.jsx(vt,{className:"w-4 h-4"})}),m&&e.jsx("div",{className:"absolute inset-y-0 right-3 flex items-center",children:e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-brand-500 border-t-transparent"})})]}),e.jsxs("div",{id:c,role:"listbox","aria-label":"Master library search results",className:"max-h-64 overflow-y-auto rounded-md border border-slate-200 bg-white shadow-sm",children:[!p&&!m?e.jsxs("div",{className:"px-4 py-3 text-sm text-slate-500",children:["Start typing at least ",Xt," characters to search the master library."]}):null,f?e.jsx("div",{className:"px-4 py-3 text-sm text-rose-600",children:"Failed to load results. Please try again."}):null,p&&!m&&!f&&h.length===0?e.jsx("div",{className:"px-4 py-3 text-sm text-slate-500",children:"No tasks found. You can create a new resource below."}):null,Array.isArray(h)&&h.map((T,A)=>{const S=A===o;return e.jsxs("button",{type:"button",id:`${c}-item-${T.id}`,role:"option","aria-selected":S,onMouseDown:O=>O.preventDefault(),onClick:()=>v(T),className:`w-full text-left px-4 py-3 border-b border-slate-100 last:border-b-0 focus:outline-none ${S||j&&g===`${c}-item-${T.id}`?"bg-brand-50":"bg-white"}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-slate-900",children:D(T.title)}),T.description?e.jsx("p",{className:"mt-1 text-sm text-slate-600",children:D(T.description)}):e.jsx("p",{className:"mt-1 text-sm text-slate-400 italic",children:"No description provided."})]}),e.jsx("span",{className:"ml-3 shrink-0 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium uppercase tracking-wide text-slate-600",children:T.origin||"library"})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("span",{className:"text-xs font-medium text-brand-600",children:k})})]},T.id)})]}),s?e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-dashed border-slate-300 px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-700",children:"Need something new?"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Create a resource directly from this form."})]}),e.jsx("button",{type:"button",onClick:s,className:"inline-flex items-center rounded-md bg-brand-600 px-3 py-2 text-sm font-medium text-white hover:bg-brand-700",children:"Create new resource"})]}):null]})},Us={title:"",description:"",purpose:"",actions:"",notes:"",start_date:"",templateId:null},Zo=({onSubmit:t,onCancel:s})=>{const r=u.useCallback(h=>{const m={};return h.title?.trim()||(m.title="Project title is required"),h.start_date||(m.start_date="Start date is required"),m},[]),{formData:a,setFormData:n,errors:i,isSubmitting:l,lastAppliedTaskTitle:o,handleChange:d,handleApplyFromLibrary:c,handleSubmit:x}=ks(Us,r),p=h=>{x(h,t,()=>{n(Us)})};return e.jsxs("form",{onSubmit:p,className:"project-form",children:[e.jsx("div",{className:"form-group",children:e.jsx(ra,{mode:"copy",onSelect:c,label:"Search master library",placeholder:"Search tasks to prefill this project"})}),o&&e.jsxs("div",{className:"mb-4 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700",children:["Copied details from ",e.jsx("span",{className:"font-semibold",children:o}),"."]}),i.submit&&e.jsx("div",{className:"form-error-banner",children:i.submit}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"title",className:"form-label",children:["Project Title ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"title",name:"title",value:a.title,onChange:d,className:`form-input ${i.title?"error":""}`,placeholder:"Enter project title",autoFocus:!0}),i.title&&e.jsx("span",{className:"form-error",children:i.title})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:a.description,onChange:d,className:"form-textarea",placeholder:"Describe this project...",rows:"4"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"purpose",className:"form-label",children:"Purpose"}),e.jsx("textarea",{id:"purpose",name:"purpose",value:a.purpose,onChange:d,className:"form-textarea",placeholder:"Why is this project being created?",rows:"3"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"start_date",className:"form-label",children:["Start Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",id:"start_date",name:"start_date",value:a.start_date,onChange:d,className:`form-input ${i.start_date?"error":""}`}),i.start_date&&e.jsx("span",{className:"form-error",children:i.start_date})]}),e.jsxs("div",{className:"form-actions mt-6 flex justify-end space-x-3 border-t border-slate-100 pt-4",children:[e.jsx("button",{type:"button",onClick:s,className:"btn-secondary",disabled:l,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:l,children:"Create Project"})]})]})},aa=({formData:t,errors:s,handleChange:r,origin:a,renderExtraFields:n})=>e.jsxs(e.Fragment,{children:[s.submit&&e.jsx("div",{className:"form-error-banner",children:s.submit}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"title",className:"form-label",children:["Task Title ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"title",name:"title",value:t.title,onChange:r,className:`form-input ${s.title?"error":""}`,placeholder:"Enter task title",autoFocus:!0}),s.title&&e.jsx("span",{className:"form-error",children:s.title})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:t.description,onChange:r,className:"form-textarea",placeholder:"Describe the task...",rows:"3"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"notes",className:"form-label",children:"Notes / Context"}),e.jsx("textarea",{id:"notes",name:"notes",value:t.notes,onChange:r,className:"form-textarea",placeholder:"Internal notes, hints, or context...",rows:"2"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"purpose",className:"form-label",children:"Purpose"}),e.jsx("textarea",{id:"purpose",name:"purpose",value:t.purpose??"",onChange:r,className:"form-textarea",placeholder:"Why is this task needed?",rows:"2"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"actions",className:"form-label",children:"Actions"}),e.jsx("textarea",{id:"actions",name:"actions",value:t.actions??"",onChange:r,className:"form-textarea",placeholder:"Specific actions to take...",rows:"2"})]}),a==="instance"&&e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"days_from_start",className:"form-label",children:"Days from Start"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",id:"days_from_start",name:"days_from_start",value:t.days_from_start,onChange:r,className:`form-input pl-10 ${s.days_from_start?"error":""}`,placeholder:"0",min:"0"}),e.jsx("div",{className:"pointer-events-none absolute left-0 top-0 flex h-full w-10 items-center justify-center text-slate-400",children:e.jsx("span",{className:"text-sm font-medium",children:"T+"})})]}),s.days_from_start&&e.jsx("span",{className:"form-error",children:s.days_from_start}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Auto-calculates dates based on project start"})]}),e.jsx("div",{className:"form-group"})]}),n&&n(),a==="instance"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-4 border-t border-slate-100 pt-4",children:[e.jsx("h4",{className:"mb-3 text-sm font-medium text-slate-700",children:"Manual Schedule Overrides"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"start_date",className:"form-label",children:"Start Date"}),e.jsx("input",{type:"date",id:"start_date",name:"start_date",value:t.start_date,onChange:r,className:"form-input"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"due_date",className:"form-label",children:"Due Date"}),e.jsx("input",{type:"date",id:"due_date",name:"due_date",value:t.due_date,onChange:r,className:`form-input ${s.due_date?"error":""}`}),s.due_date&&e.jsx("span",{className:"form-error",children:s.due_date})]})]})]})})]}),Xo=({formData:t,errors:s,isSubmitting:r,lastAppliedTaskTitle:a,handleChange:n,handleApplyFromLibrary:i,handleSubmit:l,onCancel:o,origin:d="instance",submitLabel:c="Add New Task",enableLibrarySearch:x=!0,parentTask:p})=>e.jsxs("form",{onSubmit:l,className:"project-form",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500",children:d==="template"?"Template Task":"Project Task"}),x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"form-group",children:e.jsx(ra,{mode:"copy",onSelect:i,label:"Search master library",placeholder:"Start typing to copy an existing template task"})}),a&&e.jsxs("div",{className:"mb-4 rounded-md border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700",children:["Copied details from ",e.jsx("span",{className:"font-semibold",children:a}),"."]})]}),p&&e.jsxs("div",{className:"mb-4 flex items-center gap-2 rounded-md bg-slate-100 px-3 py-2 text-sm text-slate-700",children:[e.jsx("span",{className:"font-semibold text-slate-500",children:"Adding to:"}),e.jsx("span",{className:"font-medium",children:p.title})]}),e.jsx(aa,{formData:t,errors:s,handleChange:n,origin:d}),e.jsxs("div",{className:"form-actions mt-6 flex justify-end space-x-3 border-t border-slate-100 pt-4",children:[e.jsx("button",{type:"button",onClick:o,className:"btn-secondary",disabled:r,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:r,children:r?"Saving...":c})]})]}),ei=({formData:t,errors:s,isSubmitting:r,handleChange:a,handleSubmit:n,onCancel:i,origin:l="instance",submitLabel:o="Save Changes",parentTask:d})=>e.jsxs("form",{onSubmit:n,className:"project-form",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500",children:l==="template"?"Editing Template Task":"Editing Project Task"}),d&&e.jsxs("div",{className:"mb-4 flex items-center gap-2 rounded-md bg-slate-100 px-3 py-2 text-sm text-slate-700",children:[e.jsx("span",{className:"font-semibold text-slate-500",children:"Parent Task:"}),e.jsx("span",{className:"font-medium",children:d.title})]}),e.jsx(aa,{formData:t,errors:s,handleChange:a,origin:l}),e.jsxs("div",{className:"form-actions mt-6 flex justify-end space-x-3 border-t border-slate-100 pt-4",children:[e.jsx("button",{type:"button",onClick:i,className:"btn-secondary",disabled:r,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:r,children:r?"Saving...":o})]})]}),Bs=t=>t?t.slice(0,10):"",es=t=>({title:t?.title??"",description:t?.description??"",notes:t?.notes??"",purpose:t?.purpose??"",actions:t?.actions??"",days_from_start:t?.days_from_start!==null&&t?.days_from_start!==void 0?String(t.days_from_start):"",start_date:Bs(t?.start_date),due_date:Bs(t?.due_date),templateId:null}),ti=({onSubmit:t,onCancel:s,parentTask:r,initialTask:a=null,origin:n="instance",submitLabel:i="Add New Task",enableLibrarySearch:l=!0})=>{const o=!!a,d=u.useCallback(v=>{const y={};if(v.title?.trim()||(y.title="Task title is required"),v.days_from_start!==""&&v.days_from_start!==void 0&&v.days_from_start!==null){const k=Number(v.days_from_start);(Number.isNaN(k)||k<0)&&(y.days_from_start="Days from start must be zero or greater")}if(n==="instance"&&v.start_date&&v.due_date){const k=new Date(`${v.start_date}T00:00:00.000Z`),D=new Date(`${v.due_date}T00:00:00.000Z`);!Number.isNaN(k.getTime())&&!Number.isNaN(D.getTime())&&D<k&&(y.due_date="Due date cannot be before start date")}return y},[n]),{formData:c,setFormData:x,errors:p,isSubmitting:h,lastAppliedTaskTitle:m,handleChange:f,handleApplyFromLibrary:j,handleSubmit:N}=ks(es(a),d);u.useEffect(()=>{x(es(a))},[a,x]);const g=v=>{N(v,t,()=>{o||x(es(null))})};return o?e.jsx(ei,{formData:c,errors:p,isSubmitting:h,handleChange:f,handleSubmit:g,onCancel:s,origin:n,submitLabel:i,parentTask:r}):e.jsx(Xo,{formData:c,errors:p,isSubmitting:h,lastAppliedTaskTitle:m,handleChange:f,handleApplyFromLibrary:j,handleSubmit:g,onCancel:s,origin:n,submitLabel:i,enableLibrarySearch:l,parentTask:r})};function w(...t){return no(ao(t))}const Ce=t=>t?t.startsWith("/")?t:`/${t}`:"/",Et=vs("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),P=u.forwardRef(({className:t,variant:s,size:r,asChild:a=!1,...n},i)=>{const l=a?qn:"button";return e.jsx(l,{className:w(Et({variant:s,size:r,className:t})),ref:i,...n})});P.displayName="Button";P.propTypes={className:b.string,variant:b.oneOf(["default","destructive","outline","secondary","ghost","link"]),size:b.oneOf(["default","sm","lg","icon"]),asChild:b.bool};const ke=Bn,si=Fn,_s=u.forwardRef(({className:t,...s},r)=>e.jsx(jr,{ref:r,className:w("fixed inset-0 z-50 bg-slate-900/50 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s}));_s.displayName=jr.displayName;const fe=u.forwardRef(({className:t,children:s,hideClose:r,...a},n)=>e.jsxs(si,{children:[e.jsx(_s,{}),e.jsxs(yr,{ref:n,className:w("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-card text-card-foreground p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...a,children:[s,!r&&e.jsxs(Un,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(vt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));fe.displayName=yr.displayName;const je=({className:t,...s})=>e.jsx("div",{className:w("flex flex-col space-y-1.5 text-center sm:text-left",t),...s});je.displayName="DialogHeader";const Ot=({className:t,...s})=>e.jsx("div",{className:w("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});Ot.displayName="DialogFooter";const ye=u.forwardRef(({className:t,...s},r)=>e.jsx(vr,{ref:r,className:w("text-lg font-semibold leading-none tracking-tight",t),...s}));ye.displayName=vr.displayName;const et=u.forwardRef(({className:t,...s},r)=>e.jsx(Nr,{ref:r,className:w("text-sm text-muted-foreground",t),...s}));et.displayName=Nr.displayName;const tt={className:b.string,children:b.node};_s.propTypes=tt;fe.propTypes=tt;je.propTypes=tt;Ot.propTypes=tt;ye.propTypes=tt;et.propTypes=tt;const Y=u.forwardRef(({className:t,type:s,...r},a)=>e.jsx("input",{type:s,className:w("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",t),ref:a,...r}));Y.displayName="Input";Y.propTypes={className:b.string,type:b.string};const Ae=u.forwardRef(({className:t,...s},r)=>e.jsx("textarea",{className:w("flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",t),ref:r,...s}));Ae.displayName="Textarea";Ae.propTypes={className:b.string};const ri=vs("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),V=u.forwardRef(({className:t,...s},r)=>e.jsx(wr,{ref:r,className:w(ri(),t),...s}));V.displayName=wr.displayName;const ft=Gn,gt=Qn,Be=u.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(kr,{ref:a,className:w("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...r,children:[s,e.jsx(Vn,{asChild:!0,children:e.jsx(us,{className:"h-4 w-4 opacity-50"})})]}));Be.displayName=kr.displayName;const Cs=u.forwardRef(({className:t,...s},r)=>e.jsx(_r,{ref:r,className:w("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(cn,{className:"h-4 w-4"})}));Cs.displayName=_r.displayName;const Ts=u.forwardRef(({className:t,...s},r)=>e.jsx(Cr,{ref:r,className:w("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(us,{className:"h-4 w-4"})}));Ts.displayName=Cr.displayName;const Ve=u.forwardRef(({className:t,children:s,position:r="popper",...a},n)=>e.jsx(zn,{children:e.jsxs(Tr,{ref:n,className:w("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:r,...a,children:[e.jsx(Cs,{}),e.jsx(Kn,{className:w("p-1",r==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),e.jsx(Ts,{})]})}));Ve.displayName=Tr.displayName;const na=u.forwardRef(({className:t,...s},r)=>e.jsx(Sr,{ref:r,className:w("px-2 py-1.5 text-sm font-semibold",t),...s}));na.displayName=Sr.displayName;const xe=u.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(Pr,{ref:a,className:w("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[e.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Hn,{children:e.jsx(ht,{className:"h-4 w-4"})})}),e.jsx(Wn,{children:s})]}));xe.displayName=Pr.displayName;const oa=u.forwardRef(({className:t,...s},r)=>e.jsx(Er,{ref:r,className:w("-mx-1 my-1 h-px bg-muted",t),...s}));oa.displayName=Er.displayName;const st={className:b.string,children:b.node};Be.propTypes=st;Cs.propTypes=st;Ts.propTypes=st;Ve.propTypes={...st,position:b.oneOf(["item-aligned","popper"])};na.propTypes=st;xe.propTypes=st;oa.propTypes={className:b.string};async function ne(t,s={}){const{retries:r=3,minTimeout:a=1e3,factor:n=2}=s;let i;for(let l=0;l<=r;l++)try{return await t()}catch(o){if(i=o,!(o.name==="AbortError"||o.code==="20"||o.status===503||o.message?.includes("Network request failed")))throw o;if(l<r){const c=a*Math.pow(n,l);await new Promise(x=>setTimeout(x,c))}}throw i}const Vs={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_SUPABASE_ANON_KEY:"sb_publishable_ibOO0jwtV0N_N0sdFOm2xQ_2ZHU7reM",VITE_SUPABASE_URL:"https://zqgoeblsbbtlbcvweisr.supabase.co"};var zs={};const ia=t=>{let s;return typeof import.meta<"u"&&Vs&&(s=Vs[t]),!s&&typeof process<"u"&&zs&&(s=zs[t]),s||""},la=ia("VITE_SUPABASE_URL"),da=ia("VITE_SUPABASE_ANON_KEY"),$e=(t,s="*")=>({list:async()=>ne(async()=>{const r=`${t}?select=${s}`;return await re(r,{method:"GET"})||[]}),get:async r=>ne(async()=>{const a=`${t}?select=${s}&id=eq.${r}`;return(await re(a,{method:"GET"}))?.[0]||null}),create:async r=>ne(async()=>{console.log(`[PlanterClient] Creating ${t} (Raw Fetch):`,r);const a=await re(`${t}?select=${s}`,{method:"POST",body:JSON.stringify(r),headers:{Prefer:"return=representation"}});return a?.[0]||a}),update:async(r,a)=>ne(async()=>{const n=await re(`${t}?select=${s}&id=eq.${r}`,{method:"PATCH",body:JSON.stringify(a),headers:{Prefer:"return=representation"}});return n?.[0]||n}),delete:async r=>ne(async()=>(await re(`${t}?id=eq.${r}`,{method:"DELETE"}),!0)),filter:async r=>ne(async()=>{let a=[`select=${s}`];Object.keys(r).forEach(l=>{const o=r[l];o===null?a.push(`${l}=is.null`):a.push(`${l}=eq.${o}`)});const n=a.join("&");return await re(`${t}?${n}`,{method:"GET"})||[]}),upsert:async(r,a={})=>ne(async()=>{const n=a.onConflict||"id",i=["return=representation"];a.ignoreDuplicates?i.push("resolution=ignore-duplicates"):i.push("resolution=merge-duplicates");const l=i.join(",");return{data:await re(`${t}?select=${s}&on_conflict=${n}`,{method:"POST",body:JSON.stringify(r),headers:{Prefer:l}}),error:null}})}),ca=async()=>{try{const{data:{session:t}}=await Q.auth.getSession();if(t?.access_token)return t.access_token}catch(t){console.warn("[PlanterClient] getSession() failed, falling back to localStorage",t)}if(typeof window>"u")return null;try{const t="https://zqgoeblsbbtlbcvweisr.supabase.co";if(t){const a=`sb-${new URL(t).hostname.split(".")[0]}-auth-token`,n=localStorage.getItem(a);if(n)return JSON.parse(n)?.access_token}}catch{}return null},re=async(t,s={},r=null)=>{const a=r||await ca();if(!a)throw new Error("No auth token available for raw fetch");const n=`${la}/rest/v1/${t}`,i={apikey:da,Authorization:`Bearer ${a}`,"Content-Type":"application/json",Prefer:"return=representation",...s.headers},l=await fetch(n,{...s,headers:i});if(!l.ok){const o=await l.text();throw new Error(`Supabase Raw Error (${l.status}): ${o}`)}return l.status===204?null:await l.json()},I={auth:{me:async()=>{const t=await ca();if(!t)return null;try{const s=new AbortController,r=setTimeout(()=>s.abort(),5e3),a=await fetch(`${la}/auth/v1/user`,{headers:{apikey:da,Authorization:`Bearer ${t}`},signal:s.signal});return clearTimeout(r),a.ok?await a.json():null}catch{return console.warn("[PlanterClient] auth.me() timed out"),null}},signOut:async()=>Promise.resolve(),updateProfile:async t=>ne(async()=>{const{data:s,error:r}=await Q.auth.updateUser({data:t});if(r)throw r;return s})},entities:{Project:{...$e("tasks","*,name:title,launch_date:due_date,owner_id:creator"),list:async()=>ne(async()=>{try{return await re("tasks?select=*,name:title,launch_date:due_date,owner_id:creator&parent_task_id=is.null&origin=eq.instance&order=created_at.desc",{method:"GET"})}catch(t){throw console.error("[PlanterClient] Raw Fetch List failed:",t),t}}),create:async t=>ne(async()=>{const s=t.creator,r=t._token,a={...t};delete a._token;const n={title:a.title||a.name,description:a.description,due_date:a.launch_date,origin:"instance",parent_task_id:null,root_id:null,status:a.status||"planning",creator:s},i=await re("tasks?select=*,name:title,launch_date:due_date,owner_id:creator",{method:"POST",headers:{Prefer:"return=representation,headers=off"},body:JSON.stringify(n)},r);return i?.[0]||i}),listByCreator:async(t,s=1,r=20)=>ne(async()=>{const a=(s-1)*r,n=a+r-1;try{const i=`tasks?select=*,project_id:root_id,name:title,launch_date:due_date,owner_id:creator&creator=eq.${encodeURIComponent(t)}&parent_task_id=is.null&origin=eq.instance&order=created_at.desc`;return await re(i,{method:"GET",headers:{Range:`${a}-${n}`}})||[]}catch(i){throw console.error("[PlanterClient] listByCreator failed:",i),i}}),listJoined:async t=>ne(async()=>{try{const s=`project_members?select=project:tasks(*,name:title,launch_date:due_date,owner_id:creator)&user_id=eq.${t}`;return(await re(s,{method:"GET"})||[]).map(a=>a.project).filter(a=>a!==null)}catch(s){return console.error("[PlanterClient] listJoined failed:",s),[]}}),filter:async t=>ne(async()=>{let s=["select=*,name:title,launch_date:due_date,owner_id:creator","parent_task_id=is.null","origin=eq.instance"];Object.keys(t).forEach(n=>{const i=t[n];i===null?s.push(`${n}=is.null`):s.push(`${n}=eq.${i}`)});const r=s.join("&");return await re(`tasks?${r}`,{method:"GET"})||[]}),addMember:async(t,s,r)=>({data:(await re("project_members?select=*",{method:"POST",body:JSON.stringify({project_id:t,user_id:s,role:r}),headers:{Prefer:"return=representation"}}))?.[0],error:null}),addMemberByEmail:async(t,s,r)=>({data:await re("rpc/invite_user_to_project",{method:"POST",body:JSON.stringify({p_project_id:t,p_email:s,p_role:r})}),error:null})},Task:$e("tasks"),Phase:$e("tasks"),Milestone:$e("tasks"),TaskWithResources:$e("tasks_with_primary_resource"),TaskResource:$e("task_resources"),TeamMember:$e("project_members")},rpc:async(t,s)=>ne(async()=>{try{return{data:await re(`rpc/${t}`,{method:"POST",body:JSON.stringify(s),headers:{Prefer:"return=representation"}}),error:null}}catch(r){return{data:null,error:r}}})},ai=async t=>await I.entities.TaskResource.filter({task_id:t}),ni=async(t,{type:s,url:r,text_content:a,storage_path:n})=>{if(!s)throw new Error("Resource type is required");if(s==="url"&&!r)throw new Error("URL is required for url type");if(s==="text"&&!a)throw new Error("Content is required for text type");if(s==="pdf"&&!n)throw new Error("Storage path is required for pdf type");return await I.entities.TaskResource.create({task_id:t,resource_type:s,resource_url:s==="url"?r:null,resource_text:s==="text"?a:null,storage_path:s==="pdf"?n:null})},oi=async t=>{await I.entities.TaskResource.delete(t)},ii=async(t,s)=>{await I.entities.Task.update(t,{primary_resource_id:s})},li={url:mn,pdf:ms,text:un},di={url:"External Link",pdf:"Document",text:"Note"};function ci({taskId:t,primaryResourceId:s,onUpdate:r}){const[a,n]=u.useState(!1),[i,l]=u.useState({type:"url",resource_url:"",resource_text:"",storage_path:""}),o=Te(),{data:d=[]}=de({queryKey:["resources",t],queryFn:()=>ai(t),enabled:!!t}),c=oe({mutationFn:m=>ni(t,{type:m.type,url:m.resource_url,text_content:m.resource_text,storage_path:m.storage_path}),onSuccess:()=>{o.invalidateQueries({queryKey:["resources",t]}),n(!1),l({type:"url",resource_url:"",resource_text:"",storage_path:""}),r&&r()}}),x=oe({mutationFn:m=>oi(m),onSuccess:()=>{o.invalidateQueries({queryKey:["resources",t]}),r&&r()}}),p=oe({mutationFn:m=>ii(t,m===s?null:m),onSuccess:()=>{r&&r()}}),h=m=>{m.preventDefault(),c.mutate(i)};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"text-sm font-semibold text-card-foreground uppercase tracking-wider",children:"Resources"}),e.jsxs(P,{size:"sm",onClick:()=>n(!0),className:"bg-brand-500 hover:bg-brand-600 text-white",children:[e.jsx(Re,{className:"w-4 h-4 mr-1"}),"Add Resource"]})]}),e.jsx("div",{className:"space-y-2",children:d.length===0?e.jsx("p",{className:"text-sm text-muted-foreground py-4 text-center",children:"No resources yet"}):d.map(m=>{const f=m.resource_type||m.type,j=li[f]||ms,N=s===m.id;return e.jsxs("div",{className:w("flex items-center justify-between p-3 rounded-lg border transition-all",N?"bg-brand-50 dark:bg-brand-900/30 border-brand-300 dark:border-brand-700":"bg-card border-border hover:border-brand-300"),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:w("w-9 h-9 rounded-lg flex items-center justify-center",N?"bg-brand-500":"bg-muted/50"),children:e.jsx(j,{className:w("w-4 h-4",N?"text-white":"text-muted-foreground")})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-card-foreground truncate",children:di[f]||f}),f==="url"&&m.resource_url&&e.jsx("a",{href:m.resource_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-brand-600 hover:underline truncate block",children:m.resource_url}),f==="text"&&m.resource_text&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[m.resource_text.substring(0,50),"..."]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{size:"icon",variant:"ghost",onClick:()=>p.mutate(m.id),className:w("h-8 w-8",N&&"text-brand-600 hover:text-brand-700"),children:e.jsx(xn,{className:w("w-4 h-4",N&&"fill-brand-600")})}),e.jsx(P,{size:"icon",variant:"ghost",onClick:()=>x.mutate(m.id),className:"h-8 w-8 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-950/30",children:e.jsx(xs,{className:"w-4 h-4"})})]})]},m.id)})}),e.jsx(ke,{open:a,onOpenChange:n,children:e.jsxs(fe,{className:"sm:max-w-md bg-card text-card-foreground",children:[e.jsx(je,{children:e.jsx(ye,{children:"Add Resource"})}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(V,{children:"Resource Type"}),e.jsxs(ft,{value:i.type,onValueChange:m=>l({...i,type:m}),children:[e.jsx(Be,{children:e.jsx(gt,{})}),e.jsxs(Ve,{children:[e.jsx(xe,{value:"url",children:"External Link"}),e.jsx(xe,{value:"text",children:"Note"}),e.jsx(xe,{value:"pdf",children:"Document"})]})]})]}),i.type==="url"&&e.jsxs("div",{children:[e.jsx(V,{children:"URL"}),e.jsx(Y,{type:"url",value:i.resource_url,onChange:m=>l({...i,resource_url:m.target.value}),placeholder:"https://example.com",required:!0})]}),i.type==="text"&&e.jsxs("div",{children:[e.jsx(V,{children:"Content"}),e.jsx(Ae,{value:i.resource_text,onChange:m=>l({...i,resource_text:m.target.value}),placeholder:"Enter your note...",rows:4,required:!0})]}),i.type==="pdf"&&e.jsxs("div",{children:[e.jsx(V,{children:"Storage Path"}),e.jsx(Y,{value:i.storage_path,onChange:m=>l({...i,storage_path:m.target.value}),placeholder:"path/to/document.pdf",required:!0})]}),e.jsxs("div",{className:"flex gap-2 justify-end pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:()=>n(!1),children:"Cancel"}),e.jsx(P,{type:"submit",className:"bg-brand-500 hover:bg-brand-600 text-white",children:"Add Resource"})]})]})]})})]})}const Ks=(t,s)=>s==null?null:t.find(r=>r.id===s)||null,ts=(t,s,r)=>{if(s==null)return{};if(r==null)return{};const a=Ks(t,s);if(!a)return{};let n=a;const i=new Set;for(;n?.parent_task_id&&!i.has(n.parent_task_id);){i.add(n.parent_task_id);const x=Ks(t,n.parent_task_id);if(!x)break;n=x}const l=n?.start_date||a.start_date;if(!l)return{};const o=l.includes("T")?l:`${l}T00:00:00.000Z`,d=new Date(o);if(Number.isNaN(d.getTime()))return{};d.setUTCHours(0,0,0,0),d.setUTCDate(d.getUTCDate()+r);const c=d.toISOString();return{start_date:c.split("T")[0],due_date:c.split("T")[0]}},ge=t=>{if(!t)return null;if(t instanceof Date)return t.toISOString().split("T")[0];if(typeof t=="string"){if(t.match(/^\d{4}-\d{2}-\d{2}$/))return t;const s=t.includes("T")?t:`${t}T00:00:00.000Z`,r=new Date(s);return Number.isNaN(r.getTime())?null:(r.setUTCHours(0,0,0,0),r.toISOString().split("T")[0])}return null},Fe=t=>{if(!t)return"Not set";let s;if(t.includes("T"))s=new Date(t);else{const[r,a,n]=t.split("-");s=new Date(Date.UTC(r,a-1,n))}return isNaN(s.getTime())?"Invalid Date":s.toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",timeZone:t.includes("T")?void 0:"UTC"})},ui=t=>{if(!t||t.length===0)return{start_date:null,due_date:null};let s=null,r=null;return t.forEach(a=>{if(a.start_date){const n=ge(a.start_date);n&&(!s||n<s)&&(s=n)}if(a.due_date){const n=ge(a.due_date);n&&(!r||n>r)&&(r=n)}}),{start_date:s,due_date:r}},mi=(t,s,r)=>{if(!t||!s||!r)return[];const a=new Date(ge(r)),n=new Date(ge(s));if(isNaN(a.getTime())||isNaN(n.getTime()))return[];const i=n.getTime()-a.getTime(),l=Math.round(i/(1e3*60*60*24));if(l===0)return[];const o=[];return t.forEach(d=>{if(d.is_complete||!d.start_date)return;const c=new Date(ge(d.start_date));let x=d.due_date?new Date(ge(d.due_date)):null;if(isNaN(c.getTime()))return;c.setUTCDate(c.getUTCDate()+l);const p=c.toISOString();let h=null;x&&!isNaN(x.getTime())&&(x.setUTCDate(x.getUTCDate()+l),h=x.toISOString()),o.push({id:d.id,start_date:p,due_date:h||null,updated_at:new Date().toISOString()})}),o},ua=async(t,s,r,a,n={},i=Q)=>{try{const l={p_template_id:t,p_new_parent_id:s,p_new_origin:r,p_user_id:a};n.title!==void 0&&(l.p_title=n.title),n.description!==void 0&&(l.p_description=n.description),n.start_date!==void 0&&(l.p_start_date=n.start_date),n.due_date!==void 0&&(l.p_due_date=n.due_date);const{data:o,error:d}=await i.rpc("clone_project_template",l);if(d)throw d;return{data:o,error:null}}catch(l){return console.error("[taskCloneService.deepCloneTask] RPC Error:",l),{data:null,error:l}}},Hs=async t=>{try{const s=await I.entities.TaskWithResources.get(t);if(!s)throw new Error("Task not found");const r=s.root_id||s.id,a=await I.entities.TaskWithResources.filter({root_id:r}),n=[],i=[t],l=new Set([t]),o=a.find(d=>d.id===t);for(o&&n.push(o);i.length>0;){const d=i.shift();a.filter(x=>x.parent_task_id===d).forEach(x=>{l.has(x.id)||(l.add(x.id),n.push(x),i.push(x.id))})}return{data:n,error:null}}catch(s){return console.error("[taskService.fetchTaskChildren] Error:",s),{data:null,error:s}}},xi=async t=>{try{return await I.entities.Task.delete(t),{error:null}}catch(s){return console.error("[taskService.deleteTask] Error:",s),{error:s}}},hi=async t=>{try{return{data:await I.rpc("get_task_relationships",{p_task_id:t}),error:null}}catch(s){return console.error("[taskService.getTaskRelationships] Error:",s),{data:null,error:s}}},pi=async({fromId:t,toId:s,type:r="relates_to",projectId:a})=>{try{return{data:await I.entities.TaskWithResources.create({project_id:a,from_task_id:t,to_task_id:s,type:r},"task_relationships"),error:null}}catch(n){return console.error("[taskService.addRelationship] Error:",n),{data:null,error:n}}},fi=async t=>{try{return await I.entities.TaskWithResources.delete(t,"task_relationships"),{error:null}}catch(s){return console.error("[taskService.removeRelationship] Error:",s),{error:s}}},qe=async t=>{if(t)try{const s=await I.entities.Task.filter({parent_task_id:t}),{start_date:r,due_date:a}=ui(s),n=await I.entities.Task.update(t,{start_date:r,due_date:a,updated_at:new Date().toISOString()});n&&n.parent_task_id&&await qe(n.parent_task_id)}catch(s){console.error("[taskService.updateParentDates] Error:",s)}},Ss=u.forwardRef(({className:t,...s},r)=>e.jsx(le,{ref:r,className:w("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...s}));Ss.displayName=le.displayName;const gi=({children:t,...s})=>e.jsx(ke,{...s,children:e.jsx(fe,{className:"overflow-hidden p-0",children:e.jsx(Ss,{className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[data-cmdk-input-wrapper]_svg]:h-5 [&_[data-cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:t})})}),Ps=u.forwardRef(({className:t,...s},r)=>e.jsxs("div",{className:"flex items-center border-b px-3","data-cmdk-input-wrapper":"",children:[e.jsx(hs,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(le.Input,{ref:r,className:w("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...s})]}));Ps.displayName=le.Input.displayName;const Es=u.forwardRef(({className:t,...s},r)=>e.jsx(le.List,{ref:r,className:w("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...s}));Es.displayName=le.List.displayName;const Ds=u.forwardRef((t,s)=>e.jsx(le.Empty,{ref:s,className:"py-6 text-center text-sm",...t}));Ds.displayName=le.Empty.displayName;const mt=u.forwardRef(({className:t,...s},r)=>e.jsx(le.Group,{ref:r,className:w("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...s}));mt.displayName=le.Group.displayName;const ns=u.forwardRef(({className:t,...s},r)=>e.jsx(le.Separator,{ref:r,className:w("-mx-1 h-px bg-border",t),...s}));ns.displayName=le.Separator.displayName;const He=u.forwardRef(({className:t,...s},r)=>e.jsx(le.Item,{ref:r,className:w("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",t),...s}));He.displayName=le.Item.displayName;const ma=({className:t,...s})=>e.jsx("span",{className:w("ml-auto text-xs tracking-widest text-muted-foreground",t),...s});ma.displayName="CommandShortcut";const $t=Yn,qt=Zn,wt=u.forwardRef(({className:t,align:s="center",sideOffset:r=4,...a},n)=>e.jsx(Jn,{children:e.jsx(Dr,{ref:n,align:s,sideOffset:r,className:w("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a})}));wt.displayName=Dr.displayName;function bi({task:t,allProjectTasks:s}){const r=Te(),[a,n]=u.useState(!1),[i,l]=u.useState("relates_to"),{data:o=[]}=de({queryKey:["taskRelationships",t.id],queryFn:async()=>{const{data:m}=await hi(t.id);return m||[]}}),d=oe({mutationFn:async m=>await pi({fromId:t.id,toId:m,projectId:t.root_id,type:i}),onSuccess:()=>{r.invalidateQueries({queryKey:["taskRelationships",t.id]}),n(!1)}}),c=oe({mutationFn:fi,onSuccess:()=>{r.invalidateQueries({queryKey:["taskRelationships",t.id]})}}),x=Array.isArray(o)?o:[],p=new Set(x.flatMap(m=>[m.from_task_id,m.to_task_id])),h=(s||[]).filter(m=>m.id!==t.id&&!p.has(m.id));return e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("h3",{className:"text-sm font-bold text-slate-900 uppercase tracking-wide",children:"Related Tasks"})}),e.jsxs("div",{className:"space-y-2 mb-3",children:[x.length===0&&e.jsx("p",{className:"text-sm text-slate-500 italic",children:"No dependencies linked."}),x.map(m=>{const f=m.from_task_id===t.id,j=f?m.to_task:m.from_task;return j?e.jsxs("div",{className:"flex items-center justify-between p-2 bg-slate-50 border border-slate-200 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("span",{className:`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${m.type==="blocks"?"bg-rose-100 text-rose-700":"bg-blue-100 text-blue-700"}`,children:m.type==="blocks"?f?"Blocks":"Blocked By":"Relates"}),e.jsx("span",{className:"text-sm text-slate-700 truncate",children:j.title})]}),e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>c.mutate(m.id),className:"h-6 w-6 p-0 text-slate-400 hover:text-rose-500",children:e.jsx(xs,{className:"w-3 h-3"})})]},m.id):null})]}),e.jsxs($t,{open:a,onOpenChange:n,children:[e.jsx(qt,{asChild:!0,children:e.jsxs(P,{variant:"outline",size:"sm",className:"w-full border-dashed text-slate-500 hover:text-brand-600 hover:border-brand-300",children:[e.jsx(hn,{className:"w-3 h-3 mr-2"}),"Add Dependency"]})}),e.jsx(wt,{className:"p-0 w-[300px]",align:"start",children:e.jsxs(Ss,{children:[e.jsx(Ps,{placeholder:"Search tasks..."}),e.jsxs(Es,{children:[e.jsx(Ds,{children:"No tasks found."}),e.jsx(mt,{heading:"Available Tasks",children:h.map(m=>e.jsxs(He,{value:m.title,onSelect:()=>d.mutate(m.id),children:[e.jsx(ht,{className:w("mr-2 h-4 w-4 opacity-0")}),e.jsx("span",{className:"truncate",children:m.title})]},m.id))})]})]})})]})]})}const xa=({task:t,onAddChildTask:s,onEditTask:r,onDeleteTask:a,onTaskUpdated:n,canEdit:i=!0,...l})=>{const{user:o}=ce();if(!t)return e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Select a task to view details"});const x=(t.parent_task_id?1:0)<3,p=o?.subscription_status==="active"||o?.subscription_status==="trialing",h=t.is_premium&&!p;return e.jsxs("div",{className:"task-details px-4 pb-10",children:[" ",e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{type:"button",onClick:()=>{const m=encodeURIComponent(`Task: ${t.title}`),f=encodeURIComponent(`Status: ${t.status}
Due: ${Fe(t.due_date)}

${t.description||""}

Actions:
${t.actions||""}`);window.location.href=`mailto:?subject=${m}&body=${f}`},className:"flex-1 py-3 px-4 bg-card border border-border text-card-foreground rounded-lg shadow-sm hover:bg-muted hover:shadow-md transition-all font-medium text-sm",children:"Email Task"}),r&&i&&e.jsx("button",{type:"button",onClick:()=>r(t),className:"flex-1 py-3 px-4 bg-card border border-brand-200 dark:border-brand-900 text-brand-600 rounded-lg shadow-sm hover:bg-brand-50 dark:hover:bg-brand-950/30 hover:shadow-md transition-all font-medium text-sm",children:"Edit Task"}),a&&i&&e.jsx("button",{type:"button",onClick:()=>a(t),className:"flex-1 py-3 px-4 bg-card border border-rose-200 dark:border-rose-900 text-rose-600 rounded-lg shadow-sm hover:bg-rose-50 dark:hover:bg-rose-950/30 hover:shadow-md transition-all font-medium text-sm",children:"Delete Task"})]}),e.jsx("div",{className:"detail-section mb-6 mt-6",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider",children:"Type"}),e.jsx("span",{className:`task-type-badge inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold border ${t.origin==="instance"?"bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 border-brand-100 dark:border-brand-800":"bg-muted text-muted-foreground border-border"}`,children:t.origin==="instance"?"Project Task":"Template"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider",children:"Status"}),t.is_complete?e.jsxs("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold border bg-emerald-50 text-emerald-700 border-emerald-100",children:[e.jsx("svg",{width:"12",height:"12",fill:"currentColor",className:"mr-1.5",children:e.jsx("path",{d:"M10 3L4.5 8.5L2 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),"Complete"]}):e.jsxs("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold border bg-amber-50 text-amber-700 border-amber-100",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-400 mr-2"}),"Incomplete"]})]}),t.is_premium&&e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider",children:"Access"}),e.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold border bg-purple-50 text-purple-700 border-purple-100",children:"Premium"})]})]})}),e.jsx("div",{className:"h-px bg-slate-100 my-4"}),h?e.jsxs("div",{className:"p-8 text-center bg-muted/30 border-2 border-dashed border-border rounded-xl my-6",children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-6 h-6 text-purple-600 dark:text-purple-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}),e.jsx("h3",{className:"text-lg font-bold text-card-foreground mb-2",children:"Premium Content Locked"}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-sm mx-auto",children:"This content is part of the Premium PlanterPlan curriculum. Upgrade to unlock full access to detailed guides, resources, and templates."}),e.jsx("button",{className:"px-5 py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-sm transition-colors",children:"Upgrade to Premium"})]}):e.jsxs(e.Fragment,{children:[t.description&&e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-2 uppercase tracking-wide",children:"Overview"}),e.jsx("p",{className:"text-slate-600 dark:text-muted-foreground leading-relaxed text-sm",children:t.description})]}),t.purpose&&e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-2 uppercase tracking-wide",children:"Purpose (The Why)"}),e.jsx("div",{className:"p-4 bg-indigo-50 dark:bg-indigo-950/30 border border-indigo-200 dark:border-indigo-900 text-slate-700 dark:text-indigo-200 leading-relaxed text-sm",children:t.purpose})]}),t.actions&&e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-2 uppercase tracking-wide",children:"Action Steps (The What)"}),e.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-900 text-slate-700 dark:text-green-200 leading-relaxed text-sm whitespace-pre-wrap",children:t.actions})]}),t.notes&&e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-2 uppercase tracking-wide",children:"Notes"}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950/30 border border-amber-100 dark:border-amber-900 text-slate-700 dark:text-amber-200 text-sm italic",children:t.notes})]}),e.jsx("div",{className:"mb-6 pt-4 border-t border-slate-100",children:e.jsx(ci,{taskId:t.id,primaryResourceId:t.primary_resource_id,onUpdate:n})})]}),e.jsx("div",{className:"h-px bg-slate-100 my-4"}),e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-3 uppercase tracking-wide",children:"Schedule"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-4 bg-card border border-border rounded-lg shadow-sm flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wide",children:"Start Date"}),e.jsx("span",{className:"text-sm font-bold text-card-foreground tracking-tight",children:Fe(t.start_date)})]}),e.jsxs("div",{className:"p-4 bg-card border border-border rounded-lg shadow-sm flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wide",children:"Due Date"}),e.jsx("span",{className:"text-sm font-bold text-card-foreground tracking-tight",children:Fe(t.due_date)})]})]})]}),e.jsx("div",{className:"h-px bg-slate-100 my-4"}),e.jsx(bi,{task:t,allProjectTasks:l.allProjectTasks||[]}),t.children&&t.children.length>0&&e.jsxs("div",{className:"detail-section mb-6",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-900 dark:text-foreground mb-3 uppercase tracking-wide",children:"Subtasks"}),e.jsx("div",{className:"space-y-2",children:t.children.map(m=>e.jsx("div",{className:"p-3 bg-card border border-border rounded-lg shadow-sm flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${m.is_complete?"bg-emerald-500":"bg-amber-400"}`}),e.jsx("span",{className:`text-sm font-medium ${m.is_complete?"text-muted-foreground line-through":"text-card-foreground"}`,children:m.title})]})},m.id))})]})," ",s&&x&&i&&e.jsx("div",{className:"detail-section mb-8",children:e.jsx("button",{type:"button",onClick:()=>s(t),className:"w-full py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 shadow-md transition-all font-medium",children:"+ Add Child Task"})}),e.jsxs("div",{className:"pt-6 border-t border-slate-100 text-xs text-slate-400 flex flex-col gap-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Created"}),e.jsx("span",{className:"font-mono text-slate-500",children:Fe(t.created_at)})]}),t.updated_at&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Updated"}),e.jsx("span",{className:"font-mono text-slate-500",children:Fe(t.updated_at)})]}),e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsx("span",{children:"ID"}),e.jsxs("span",{className:"font-mono opacity-50",children:[t.id.slice(0,8),"..."]})]})]})]})};async function ha(t,s,r){try{return await I.entities.Project.addMember(t,s,r)}catch(a){throw a.code==="42501"||a.message&&a.message.includes("policy")?new Error("Access denied: You must be an Owner to manage members."):a}}async function ji(t,s,r){try{return await I.entities.Project.addMemberByEmail(t,s,r)}catch(a){throw a.code==="42501"||a.message&&a.message.includes("policy")?new Error("Access denied: You must be an Owner to manage members."):a}}async function pa(t,s=1,r=20){try{return{data:await I.entities.Project.listByCreator(t,s,r),error:null}}catch(a){return console.error("getUserProjects failed:",a),{data:[],error:a}}}async function fa(t){try{return{data:await I.entities.Project.listJoined(t),error:null}}catch(s){return console.error("getJoinedProjects failed:",s),{data:[],error:s}}}async function yi(t){const s=await I.entities.Task.get(t);if(!s)throw new Error("Project not found");const r=await I.entities.Task.filter({root_id:t}),a=r.length,n=r.filter(i=>i.is_complete).length;return{data:{...s,children:r||[],stats:{totalTasks:a||0,completedTasks:n||0,progress:a?Math.round(n/a*100):0}},error:null}}async function vi(t,s){try{return{data:await I.entities.Project.update(t,{status:s}),error:null}}catch(r){throw console.error("updateProjectStatus failed:",r),r}}async function Ni(t){return await ga(t)}async function ga(t){let s=t.creator,r=t._token;if(s||(s=(await I.auth.me())?.id),!s)throw new Error("User must be logged in to create a project");const a=await I.entities.Project.create({...t,launch_date:(()=>{if(!t.launch_date)return null;const i=new Date(t.launch_date);if(isNaN(i.getTime()))throw new Error("Invalid launch_date provided");return i.toISOString().split("T")[0]})(),creator:s,_token:r});if(!a?.id)throw new Error("Project creation failed: no ID returned from database.");const{error:n}=await I.rpc("initialize_default_project",{p_project_id:a.id,p_creator_id:s});if(n){console.error("[ProjectService] RPC Error:",n);try{await I.entities.Project.delete(a.id)}catch(i){console.error("CRITICAL: Failed to rollback project creation:",i)}throw new Error("Project initialization failed. Please try again.")}return a}const ba=({project:t,onClose:s,onInviteSuccess:r})=>{const[a,n]=u.useState(""),[i,l]=u.useState($.VIEWER),[o,d]=u.useState(!1),[c,x]=u.useState(null),[p,h]=u.useState(!1),m=async f=>{if(f.preventDefault(),!a.trim()){console.warn("[InviteMemberModal] User ID empty");return}const j=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,N=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;if(!j.test(a)&&!N.test(a)){x("Please enter a valid Email Address or UUID.");return}const g=a.includes("@");d(!0),x(null);let v;try{g?v=await ji(t.id,a,i):v=await ha(t.id,a,i)}catch(k){console.error("[InviteMemberModal] Exception during invite:",k),v={error:k}}const{error:y}=v;if(y){const k=y.message||(typeof y=="string"?y:JSON.stringify(y));console.error("[InviteMemberModal] Invite Failed:",k),x(k||"Failed to invite member (Unknown Error)"),d(!1)}else d(!1),h(!0),r&&r(),setTimeout(()=>{s()},1500)};return rn.createPortal(e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity",onClick:s}),e.jsxs("div",{className:"relative w-full max-w-md rounded-lg bg-white p-6 shadow-xl transform transition-all",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Invite Member"}),e.jsxs("p",{className:"mt-1 text-sm text-slate-500",children:["Invite a user to ",e.jsx("strong",{children:t.title})]}),c&&e.jsx("div",{className:"mt-4 rounded-md bg-rose-50 p-3 text-sm text-rose-600",children:c}),p&&e.jsx("div",{className:"mt-4 rounded-md bg-emerald-50 p-3 text-sm text-emerald-600",children:"Invitation sent successfully!"}),e.jsxs("form",{onSubmit:m,className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"userId",className:"block text-sm font-medium text-slate-700",children:"User Email or UUID"}),e.jsx("input",{type:"text",id:"userId",value:a,onChange:f=>n(f.target.value),className:"mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 sm:text-sm form-input p-2 border",placeholder:"user@example.com or UUID",required:!0}),e.jsx("p",{className:"mt-1 text-xs text-slate-400",children:"Enter the email of an existing user."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"role",className:"block text-sm font-medium text-slate-700",children:"Role"}),e.jsxs("select",{id:"role",value:i,onChange:f=>l(f.target.value),className:"mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm form-select p-2 border",children:[e.jsx("option",{value:$.VIEWER,children:"Viewer (Read-only)"}),e.jsx("option",{value:$.COACH,children:"Coach (Comment & Review)"}),e.jsx("option",{value:$.EDITOR,children:"Editor (Can edit tasks)"}),e.jsx("option",{value:$.LIMITED,children:"Limited (Assigned tasks only)"})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:s,className:"rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2",disabled:o,children:"Cancel"}),e.jsxs("button",{type:"submit",className:"rounded-md border border-transparent bg-brand-600 px-4 py-2 text-sm font-medium text-white hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 flex items-center",disabled:o,children:[o&&e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),o?"Inviting...":"Send Invite"]})]})]})]})]}),document.body)},Ee={[R.TODO]:"var(--color-slate-400)",[R.IN_PROGRESS]:"var(--color-amber-500)",[R.BLOCKED]:"var(--color-rose-500)",[R.COMPLETED]:"var(--color-emerald-500)"},me={[W.PLANNING]:{bg:"bg-white dark:bg-slate-950",border:"border-2 border-blue-600 dark:border-blue-400",text:"text-blue-700 dark:text-blue-300",gradient:"from-blue-100/60 to-transparent dark:from-blue-900/40 dark:to-transparent",accent:"border-blue-500 dark:border-blue-400",headerBg:"bg-blue-600 dark:bg-blue-600",headerContent:"text-white dark:text-slate-100"},[W.IN_PROGRESS]:{bg:"bg-white dark:bg-slate-950",border:"border-2 border-orange-600 dark:border-orange-400",text:"text-orange-700 dark:text-orange-300",gradient:"from-orange-100/60 to-transparent dark:from-orange-900/40 dark:to-transparent",accent:"border-orange-500 dark:border-orange-400",headerBg:"bg-orange-600 dark:bg-orange-600",headerContent:"text-white dark:text-slate-100"},[W.LAUNCHED]:{bg:"bg-white dark:bg-slate-950",border:"border-2 border-emerald-600 dark:border-emerald-400",text:"text-emerald-700 dark:text-emerald-300",gradient:"from-emerald-100/60 to-transparent dark:from-emerald-900/40 dark:to-transparent",accent:"border-emerald-500 dark:border-emerald-400",headerBg:"bg-emerald-600 dark:bg-emerald-600",headerContent:"text-white dark:text-slate-100"},[W.PAUSED]:{bg:"bg-white dark:bg-slate-950",border:"border-2 border-amber-500 dark:border-amber-400",text:"text-amber-700 dark:text-amber-300",icon:"text-slate-900 dark:text-white",indicator:"bg-amber-500",gradient:"from-amber-100/60 to-transparent dark:from-amber-900/40 dark:to-transparent",accent:"border-amber-500 dark:border-amber-400",headerBg:"bg-amber-500 dark:bg-amber-600",headerContent:"text-white dark:text-slate-100"}},ja=({tasks:t,selectedTaskId:s,handleTaskClick:r,hasMore:a,isFetchingMore:n,onLoadMore:i})=>e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 mb-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500",children:"My Projects"})}),e.jsx("span",{className:"bg-brand-50 text-brand-600 dark:bg-slate-800 dark:text-slate-400 text-xs font-bold px-2 py-0.5 rounded-full min-w-[1.25rem] text-center",children:t.length})]}),t.length>0?e.jsxs(e.Fragment,{children:[t.map(l=>{const o=s===l.id;return e.jsxs("div",{onClick:()=>r(l),className:`
                  group relative p-3 rounded-lg border transition-all duration-200 cursor-pointer w-full text-left
                  ${o?"bg-brand-50 dark:bg-slate-800/80 border-brand-200 dark:border-slate-700 shadow-sm":"bg-card border-border hover:border-brand-300 dark:hover:border-slate-700 hover:shadow-md"}
                `,role:"button",tabIndex:0,onKeyDown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),r(l))},children:[e.jsxs("div",{className:"flex justify-between items-start mb-2 w-full",children:[e.jsx("h3",{className:`font-semibold text-sm line-clamp-1 break-all ${o?"text-brand-700 dark:text-brand-300":"text-foreground"}`,children:l.title}),e.jsx("button",{className:`opacity-0 group-hover:opacity-100 p-1 rounded-md transition-all ${o?"text-brand-600 hover:bg-brand-100":"text-muted-foreground hover:bg-accent hover:text-foreground"}`,onClick:d=>{d.stopPropagation()},title:"Project Settings",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:e.jsx("div",{className:`
                    text-[10px] px-2 py-0.5 rounded-full font-medium border uppercase tracking-wide
                    ${(me[l.status]||me[W.PLANNING]).bg}
                    ${(me[l.status]||me[W.PLANNING]).text}
                    ${(me[l.status]||me[W.PLANNING]).border}
                  `,children:l.status?l.status.replace("_"," "):"Planning"})})]},l.id)}),a&&e.jsx("button",{onClick:i,disabled:n,className:"w-full py-2 text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 hover:underline disabled:opacity-50 text-center mt-2",children:n?"Loading...":"Load More Projects"})]}):!n&&e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 text-center cursor-pointer hover:bg-muted/50 rounded-lg m-2 transition-colors border border-dashed border-border group",onClick:i,children:[e.jsx(sr,{className:"w-8 h-8 text-muted-foreground mb-2 group-hover:text-brand-500 transition-colors"}),e.jsx("p",{className:"text-sm font-medium text-foreground",children:"No Projects"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Create your first project to get started."})]})]});ja.propTypes={tasks:b.array.isRequired,selectedTaskId:b.string,handleTaskClick:b.func.isRequired,hasMore:b.bool,isFetchingMore:b.bool,onLoadMore:b.func};const Ms=({role:t})=>{const s=t?t.toLowerCase():$.VIEWER,r={[$.OWNER]:"bg-brand-50 text-brand-700 border-brand-200",[$.ADMIN]:"bg-purple-50 text-purple-700 border-purple-200",[$.EDITOR]:"bg-sky-50 text-sky-700 border-sky-200",[$.COACH]:"bg-indigo-50 text-indigo-700 border-indigo-200",[$.VIEWER]:"bg-slate-50 text-slate-700 border-slate-200",[$.LIMITED]:"bg-amber-50 text-amber-700 border-amber-200",default:"bg-slate-50 text-slate-700 border-slate-200"},a=r[s]||r.default,n=s.charAt(0).toUpperCase()+s.slice(1);return e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border capitalize ${a}`,"aria-label":`Role: ${n}`,children:n})},wi=({task:t,isSelected:s,onClick:r,showRole:a=!1,to:n})=>{const i=()=>{r&&r(t)},l=t.status?`status-dot ${t.status}`:`status-dot ${R.TODO}`,o=`sidebar-nav-item group flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer ${s?"bg-gradient-to-r from-orange-100 to-white border-l-4 border-l-orange-500 border-y border-r border-y-orange-100 border-r-transparent dark:from-slate-800 dark:to-slate-800/50 dark:border-l-orange-500 dark:border-y-transparent dark:border-r-transparent text-slate-900 dark:text-white shadow-sm dark:shadow-none font-semibold":"text-muted-foreground hover:bg-gradient-to-r hover:from-orange-50 hover:to-transparent hover:border-orange-100/50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white"}`,d=e.jsxs(e.Fragment,{children:[e.jsx("div",{className:l}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center justify-between",children:[e.jsx("span",{className:"sidebar-nav-item-title truncate",children:t.title}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-muted rounded text-muted-foreground hover:text-brand-600 dark:hover:text-brand-400 transition-all mr-2",onClick:c=>{c.preventDefault(),c.stopPropagation()},title:"Clone Template",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 01-2-2V5a2 2 0 012-2h4.586"})})}),a&&t.membership_role&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Ms,{role:t.membership_role})})]})]})]});return n?e.jsx(he,{to:n,className:o,onClick:i,title:t.title,"aria-current":s?"page":void 0,children:d}):e.jsx("div",{className:o,onClick:c=>{c.preventDefault(),i()},role:"button",tabIndex:0,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),i())},title:t.title,children:d})},ya=u.memo(wi),va=({projects:t,error:s,handleTaskClick:r,selectedTaskId:a})=>e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 mb-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500",children:"Joined Projects"}),e.jsx("span",{className:"bg-brand-50 text-brand-600 dark:bg-slate-800 dark:text-slate-300 text-xs font-bold px-2 py-0.5 rounded-full min-w-[1.25rem] text-center",children:t.length})]}),s?e.jsx("div",{className:"text-sm text-rose-400 px-3 py-4",children:s}):t.length>0?e.jsx("div",{className:"space-y-1",children:t.map(n=>e.jsx(ya,{task:n,isSelected:a===n.id,onClick:r,showRole:!0,to:`/ project / ${n.id} `},n.id))}):e.jsx("div",{className:"text-sm text-muted-foreground px-3 py-4",children:"You haven't joined any projects yet."})]});va.propTypes={projects:b.array.isRequired,error:b.string,handleTaskClick:b.func.isRequired,selectedTaskId:b.string};const Na=({tasks:t,selectedTaskId:s,handleTaskClick:r})=>e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 mb-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Templates"}),e.jsx("span",{className:"bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300 text-xs font-bold px-2 py-0.5 rounded-full min-w-[1.25rem] text-center",children:t.length})]}),t.length>0?e.jsx("div",{className:"space-y-1",children:t.map(a=>e.jsx(ya,{task:a,isSelected:s===a.id,onClick:r,to:`/project/${a.id}`},a.id))}):e.jsx("div",{className:"text-sm text-slate-400 px-3 py-4",children:'No templates yet. Click "New Template" to start building.'})]});Na.propTypes={tasks:b.array.isRequired,selectedTaskId:b.string,handleTaskClick:b.func.isRequired};const ct=({isActive:t,onClick:s,label:r,icon:a})=>e.jsxs("div",{className:`sidebar-nav-item group flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer ${t?"bg-gradient-to-r from-orange-100 to-white border-l-4 border-l-orange-500 border-y border-r border-y-orange-100 border-r-transparent dark:from-slate-800 dark:to-slate-800/50 dark:border-l-orange-500 dark:border-y-transparent dark:border-r-transparent text-slate-900 dark:text-white shadow-sm dark:shadow-none font-semibold":"text-muted-foreground hover:bg-gradient-to-r hover:from-orange-50 hover:to-transparent hover:border-orange-100/50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white"}`,onClick:s,role:"button",tabIndex:0,children:[e.jsx("div",{className:`flex-shrink-0 transition-colors ${t?"text-slate-900 dark:text-white":"text-slate-400 dark:text-slate-500 group-hover:text-slate-900 dark:group-hover:text-white"}`,children:a}),e.jsx("span",{className:`sidebar-nav-item-title font-medium whitespace-nowrap overflow-hidden text-ellipsis ${t?"text-slate-900 dark:text-white":""}`,children:r})]});ct.propTypes={isActive:b.bool.isRequired,onClick:b.func.isRequired,label:b.string.isRequired,icon:b.element.isRequired};const Ft=({joinedProjects:t,instanceTasks:s,templateTasks:r,joinedError:a,handleSelectProject:n,selectedTaskId:i,onNewProjectClick:l,onNewTemplateClick:o,loading:d=!1,error:c=null,onNavClick:x,hasMore:p,isFetchingMore:h,onLoadMore:m})=>{const{user:f,signOut:j}=ce(),N=tr(),g=we(),v=f?.role===$.ADMIN||f?.role===$.OWNER,y=S=>{n(S),x&&x()},k=()=>{l(),x&&x()},D=()=>{o(),x&&x()},T=S=>{g(S),x&&x()};if(d)return e.jsx("div",{className:"flex flex-col h-full bg-card",children:e.jsx(sa,{})});const A=f?.email?f.email[0].toUpperCase():"?";return e.jsxs("div",{className:"flex flex-col h-full bg-card text-card-foreground border-r border-border shadow-sm",children:[e.jsxs("div",{className:"px-4 py-4 space-y-1",children:[e.jsx(ct,{label:"Dashboard",isActive:N.pathname==="/dashboard",onClick:()=>T("/dashboard"),icon:e.jsx(rr,{className:"w-5 h-5"})}),e.jsx(ct,{label:"My Tasks",isActive:N.pathname==="/tasks",onClick:()=>T("/tasks"),icon:e.jsx(pn,{className:"w-5 h-5"})}),e.jsx(ct,{label:"Reports",isActive:N.pathname==="/reports",onClick:()=>T(i?`/reports?project=${i}`:"/reports"),icon:e.jsx(fn,{className:"w-5 h-5"})}),e.jsx(ct,{label:"Settings",isActive:N.pathname==="/settings",onClick:()=>T("/settings"),icon:e.jsx(Mt,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"h-px bg-border mx-4"}),e.jsxs("div",{className:"px-4 py-4 space-y-2 border-b border-border",children:[e.jsxs("button",{onClick:k,"data-testid":"sidebar-new-project-btn",className:"flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-white bg-brand-600 rounded-lg hover:bg-brand-700 transition-colors shadow-sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v16m8-8H4"})}),"New Project"]}),v&&e.jsxs("button",{onClick:D,"data-testid":"sidebar-new-template-btn",className:"flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-white bg-brand-600 rounded-lg hover:bg-brand-700 transition-colors shadow-sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v16m8-8H4"})}),"New Template"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-4 space-y-6 custom-scrollbar","data-testid":"project-switcher",children:[c&&e.jsxs("div",{className:"p-3 mb-2 text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded-lg",children:["âš ï¸ ",c]}),e.jsx(ja,{tasks:s,selectedTaskId:i,handleTaskClick:y,hasMore:p,isFetchingMore:h,onLoadMore:m}),e.jsx("div",{className:"h-px bg-border"}),e.jsx(va,{projects:t,error:a,handleTaskClick:y,selectedTaskId:i}),e.jsx("div",{className:"h-px bg-border"}),e.jsx(Na,{tasks:r,selectedTaskId:i,handleTaskClick:y})]}),e.jsx("div",{className:"border-t border-border p-4 bg-muted/20",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-50 dark:bg-brand-900/40 flex items-center justify-center text-brand-600 dark:text-brand-300 font-bold border border-brand-200 dark:border-brand-800",children:A}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-card-foreground truncate",children:f?.email||"Unknown User"}),e.jsx("button",{onClick:j,className:"text-xs text-muted-foreground hover:text-rose-600 hover:underline transition-colors flex items-center mt-0.5",children:"Sign Out"})]})]})})]})};Ft.propTypes={joinedProjects:b.array.isRequired,instanceTasks:b.array.isRequired,templateTasks:b.array.isRequired,joinedError:b.string,error:b.string,handleSelectProject:b.func.isRequired,selectedTaskId:b.string,onNewProjectClick:b.func.isRequired,onNewTemplateClick:b.func.isRequired,loading:b.bool,onNavClick:b.func,hasMore:b.bool,isFetchingMore:b.bool,onLoadMore:b.func};const ki=vs("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function Ye({className:t,variant:s,...r}){return e.jsx("div",{className:w(ki({variant:s}),t),...r})}Ye.propTypes={className:b.string,variant:b.oneOf(["default","secondary","destructive","outline"])};const rt=u.forwardRef(({className:t,value:s,...r},a)=>e.jsx(Mr,{ref:a,className:w("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",t),...r,children:e.jsx(Xn,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(s||0)}%)`}})}));rt.displayName=Mr.displayName;const wa=({tasks:t,fetchTasks:s})=>{const r=Te(),a=u.useCallback(async l=>{try{const{data:{user:o}}=await Q.auth.getUser();if(!o)throw new Error("User not authenticated");const d=t.filter(h=>h.origin==="instance"&&!h.parent_task_id),c=d.length>0?Math.max(...d.map(h=>h.position??0)):0,x=ge(l.start_date);if(!x)throw new Error("A valid project start date is required");let p;if(l.templateId){const{data:h,error:m}=await ua(l.templateId,null,"instance",o.id,{title:l.title,description:l.description,start_date:x,due_date:x});if(m)throw m;p=h}else p=await Ni({title:l.title,start_date:x,creator:o.id});return await s(),r.invalidateQueries(["userProjects"]),p}catch(o){throw console.error("Error creating project:",o),o}},[t,s,r]),n=u.useCallback(async(l,o,d)=>{try{const{start_date:c}=o,x={title:o.title,description:o.description,due_date:o.launch_date,start_date:o.start_date,updated_at:new Date().toISOString(),location:o.location};let p=[];if(c&&d&&c!==d){const{data:m}=await Q.from("tasks").select("*").eq("root_id",l);p=mi(m||[],c,d)}const{error:h}=await Q.from("tasks").update(x).eq("id",l);if(h)throw h;if(p.length>0){const{error:m}=await Q.from("tasks").upsert(p);m&&console.error("Date recalc error",m)}return await s(),r.invalidateQueries(["userProjects"]),!0}catch(c){throw console.error("Error updating project:",c),c}},[s,r]),i=u.useCallback(async l=>{try{const{error:o}=await xi(l);if(o)throw o;return await s(),r.invalidateQueries(["userProjects"]),!0}catch(o){throw console.error("Error deleting project:",o),o}},[s,r]);return{createProject:a,updateProject:n,deleteProject:i}};function _i({project:t,isOpen:s,onClose:r}){const[a,n]=u.useState(!1),{updateProject:i,deleteProject:l}=wa({tasks:[],fetchTasks:()=>{}}),o=t.settings||{},d={title:t.title||t.name||"",description:t.description||"",start_date:ge(t.start_date||t.created_at),location:t.location||"",due_soon_threshold:o.due_soon_threshold||"3"},c=u.useCallback(N=>{const g={};return N.title?.trim()||(g.title="Title is required"),N.start_date||(g.start_date="Start date is required"),g},[]),{formData:x,errors:p,isSubmitting:h,handleChange:m,handleSubmit:f}=ks(d,c),j=async N=>{try{const g=ge(t.start_date||t.created_at),{due_soon_threshold:v,...y}=N,k={...y,settings:{...o,due_soon_threshold:parseInt(v,10)||3}};await i(t.id,k,g),r()}catch(g){console.error("[EditProjectModal] Failed to update project:",g)}};return e.jsx(ke,{open:s,onOpenChange:r,children:e.jsxs(fe,{className:"sm:max-w-[500px]",children:[e.jsx(je,{children:e.jsx(ye,{children:"Project Settings"})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(V,{className:"text-sm font-semibold text-slate-500 uppercase tracking-wider",children:"General"}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(V,{htmlFor:"title",children:"Project Title"}),e.jsx(Y,{id:"title",name:"title",value:x.title,onChange:m,className:p.title?"border-red-500":""}),p.title&&e.jsx("p",{className:"text-sm text-red-500",children:p.title})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(V,{htmlFor:"description",children:"Description"}),e.jsx(Ae,{id:"description",name:"description",value:x.description,onChange:m,rows:2})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(V,{htmlFor:"location",children:"Location"}),e.jsx(Y,{id:"location",name:"location",value:x.location,onChange:m,placeholder:"e.g. Seattle, WA"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(V,{className:"text-sm font-semibold text-slate-500 uppercase tracking-wider",children:"Configuration"}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(V,{htmlFor:"due_soon_threshold",children:'"Due Soon" Threshold (Days)'}),e.jsx(Y,{type:"number",id:"due_soon_threshold",name:"due_soon_threshold",value:x.due_soon_threshold,onChange:m,min:"1",max:"30"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Tasks due within this many days will be flagged."})]})]}),e.jsxs("div",{className:"bg-amber-50 p-4 rounded-lg border border-amber-200",children:[e.jsx(V,{htmlFor:"start_date",className:"block mb-1 font-semibold text-amber-800",children:"Launch Date Correction"}),e.jsx("p",{className:"text-xs text-amber-700 mb-2",children:"Changing this will shift ALL incomplete tasks in the timeline."}),e.jsx(Y,{type:"date",id:"start_date",name:"start_date",value:x.start_date,onChange:m})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(P,{variant:"outline",onClick:r,type:"button",children:"Cancel"}),e.jsx(P,{onClick:N=>f(N,j),disabled:h,children:h?"Saving...":"Save Changes"})]}),e.jsxs("div",{className:"relative py-4",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t border-slate-200"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-white px-2 text-slate-500",children:"Danger Zone"})})]}),e.jsx("div",{className:"bg-red-50 p-4 rounded-lg border border-red-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(V,{className:"block mb-1 font-semibold text-red-800",children:"Delete Project"}),e.jsx("p",{className:"text-xs text-red-700",children:"Permanently remove this project and all its tasks."})]}),a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-red-700 font-medium",children:"Are you sure?"}),e.jsx(P,{variant:"outline",size:"xs",className:"h-8 text-slate-600 bg-white hover:bg-slate-50 border-red-200",onClick:()=>n(!1),children:"Cancel"}),e.jsx(P,{variant:"destructive",size:"xs",className:"h-8",onClick:async()=>{await l(t.id),window.location.href="/dashboard"},children:"Yes, Delete"})]}):e.jsx(P,{variant:"destructive",size:"sm",onClick:()=>n(!0),children:"Delete Project"})]})})]})]})})}const Ci=(t,s)=>{if(!s||s.length===0)return;const r=["ID","Title","Type","Status","Start Date","Due Date","Description","Assignee"],a=s.map(d=>[d.id,`"${(d.title||"").replace(/"/g,'""')}"`,d.parent_task_id?"Subtask":d.root_id===d.id?"Project Root":"Phase/Milestone",d.status,Fe(d.start_date),Fe(d.due_date),`"${(d.description||"").replace(/"/g,'""')}"`,d.assignee_id||"Unassigned"]),n=[r.join(","),...a.map(d=>d.join(","))].join(`
`),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(i),o=document.createElement("a");o.setAttribute("href",l),o.setAttribute("download",`${t.name.replace(/\s+/g,"_")}_export.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)},Ti={launch_large:pt,multisite:fs,multiplication:ps},Si={[W.PLANNING]:"bg-indigo-100 text-indigo-700",[W.IN_PROGRESS]:"bg-brand-100 text-brand-700",[W.LAUNCHED]:"bg-emerald-100 text-emerald-700",[W.PAUSED]:"bg-slate-100 text-slate-700"};function Ut({project:t,tasks:s=[],teamMembers:r=[],onInviteMember:a,canInvite:n=!1,canManageSettings:i=!1}){const[l,o]=u.useState(!1),d=Ti[t.template]||pt,c=s.filter(h=>h.status===R.COMPLETED).length,x=s.length,p=x>0?Math.round(c/x*100):0;return e.jsxs(J.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-card border-b border-border sticky top-16 z-40 transition-all shadow-sm",children:[e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx(he,{to:Ce("dashboard"),children:e.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",children:e.jsx(ar,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx("div",{className:"w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-md shadow-orange-500/20",children:e.jsx(d,{className:"w-7 h-7 text-white"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-bold text-card-foreground",children:t.name||t.title}),e.jsx(Ye,{className:Si[t.status],children:t.status?.replace("_"," ")})]}),t.description&&e.jsx("p",{className:"text-muted-foreground mt-1",children:t.description})]})]}),e.jsxs("div",{className:"hidden md:flex items-center gap-2",children:[e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>document.dispatchEvent(new KeyboardEvent("keydown",{key:"k",metaKey:!0})),children:[e.jsx(hs,{className:"w-4 h-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"lg:hidden",children:"Search"}),e.jsx("span",{className:"hidden lg:inline text-muted-foreground text-xs",children:"âŒ˜K"})]}),i&&e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>o(!0),children:[e.jsx(Mt,{className:"w-4 h-4 mr-2"}),"Settings"]}),e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>Ci(t,s),children:[e.jsx(gn,{className:"w-4 h-4 mr-2"}),"Export"]}),e.jsx(he,{to:Ce(`reports?project=${t.id}`),children:e.jsxs(P,{variant:"outline",size:"sm",children:[e.jsx(bn,{className:"w-4 h-4 mr-2"}),"Reports"]})}),e.jsx(he,{to:Ce(`team?project=${t.id}`),children:e.jsxs(P,{variant:"outline",size:"sm",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Team"]})}),n&&e.jsxs(P,{variant:"default",size:"sm",onClick:a,className:"ml-2 bg-brand-500 hover:bg-brand-600 text-white",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Invite"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-6",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-slate-600",children:[t.location&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(nr,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{children:t.location})]}),t.launch_date&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ie,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:["Launch: ",Ne(new Date(t.launch_date),"MMM d, yyyy")]})]}),e.jsx(Me,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:[r.length," team member",r.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center -space-x-2 overflow-hidden py-1 pl-1",children:[r.slice(0,5).map(h=>e.jsx(ka,{member:h},h.id)),r.length>5&&e.jsxs("div",{className:"flex items-center justify-center w-8 h-8 rounded-full border-2 border-white bg-slate-100 text-xs font-medium text-slate-500 z-0",children:["+",r.length-5]})]}),e.jsxs("div",{className:"flex-1 flex items-center gap-3 min-w-52 max-w-md ml-auto",children:[e.jsx(rt,{value:p,className:"h-2 flex-1 bg-muted"}),e.jsxs("span",{className:"text-sm font-medium text-card-foreground whitespace-nowrap",children:[p,"% complete"]})]})]})]}),l&&e.jsx(_i,{project:t,isOpen:l,onClose:()=>o(!1)})]})}Ut.propTypes={project:b.shape({id:b.string.isRequired,name:b.string.isRequired,status:b.string.isRequired,description:b.string,template:b.string,location:b.string,launch_date:b.string}).isRequired,tasks:b.arrayOf(b.object),teamMembers:b.arrayOf(b.object),onInviteMember:b.func};function ka({member:t}){const{attributes:s,listeners:r,setNodeRef:a,transform:n,isDragging:i}=xr({id:`member-${t.id}`,data:{type:"User",member:t}}),l=n?{transform:`translate3d(${n.x}px, ${n.y}px, 0)`}:void 0,o=(t.first_name?.[0]||"")+(t.last_name?.[0]||"")||"?",d=t.first_name?`${t.first_name} ${t.last_name}`:t.email;return e.jsx("div",{ref:a,style:l,...r,...s,className:`relative inline-flex items-center justify-center w-8 h-8 rounded-full border-2 border-background bg-muted text-xs font-medium text-muted-foreground cursor-grab active:cursor-grabbing hover:z-10 transition-transform ${i?"opacity-50 z-50":""}`,title:`Drag to assign ${d}`,children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:d,className:"w-full h-full rounded-full object-cover"}):e.jsx("span",{children:o})})}ka.propTypes={member:b.shape({id:b.string.isRequired,first_name:b.string,last_name:b.string,email:b.string,avatar_url:b.string}).isRequired};Qr.addHook("afterSanitizeAttributes",t=>{t?.getAttribute&&t.getAttribute("target")==="_blank"&&t.setAttribute("rel","noopener noreferrer")});const xt=t=>t?Qr.sanitize(t,{USE_PROFILES:{html:!0},ADD_ATTR:["target","rel"]}):"",Pi=t=>{switch(t){case R.COMPLETED:return"status-badge-complete";case R.IN_PROGRESS:return"status-badge-progress";case R.BLOCKED:return"status-badge-blocked";case R.TODO:default:return"status-badge-todo"}};function Ei({status:t,taskId:s,onStatusChange:r}){const a=u.useCallback(n=>{n.stopPropagation(),r&&r(s,n.target.value)},[r,s]);return e.jsx("div",{className:"relative group",children:e.jsxs("select",{className:`appearance-none cursor-pointer pl-4 pr-9 py-1.5 text-xs font-semibold rounded-full border transition-all ${Pi(t)} focus:ring-2 focus:ring-offset-1 focus:ring-brand-500 focus:outline-none`,value:t||R.TODO,onClick:n=>n.stopPropagation(),onChange:a,children:[e.jsx("option",{value:R.TODO,children:"To Do"}),e.jsx("option",{value:R.IN_PROGRESS,children:"In Progress"}),e.jsx("option",{value:R.BLOCKED,children:"Blocked"}),e.jsx("option",{value:R.COMPLETED,children:"Complete"})]})})}function Di({task:t,onEdit:s,onAddChild:r,onInvite:a,onDelete:n,canHaveChildren:i}){const l=u.useCallback(x=>{x.stopPropagation(),s&&s(t)},[s,t]),o=u.useCallback(x=>{x.stopPropagation(),r&&r(t)},[r,t]),d=u.useCallback(x=>{x.stopPropagation(),a&&a(t)},[a,t]),c=u.useCallback(x=>{x.stopPropagation(),n&&n(t.id)},[n,t]);return e.jsxs(e.Fragment,{children:[s&&e.jsx("button",{className:"action-btn",onClick:l,title:"Edit Task",children:e.jsx(jn,{className:"w-3.5 h-3.5"})}),i&&r&&e.jsx("button",{className:"action-btn",onClick:o,title:"Add Subtask",children:e.jsx(Re,{className:"w-3.5 h-3.5"})}),a&&e.jsx("button",{className:"action-btn",onClick:d,title:"Invite Member",children:e.jsx(ss,{className:"w-3.5 h-3.5"})}),n&&e.jsx("button",{className:"action-btn delete",onClick:c,title:"Delete Task",children:e.jsx(xs,{className:"w-3.5 h-3.5"})})]})}const _a=({onCommit:t,onCancel:s,loading:r=!1,level:a=0})=>{const[n,i]=u.useState(""),l=u.useRef(null);u.useEffect(()=>{l.current&&l.current.focus()},[]);const o=x=>{r||(x.key==="Enter"?(x.preventDefault(),n.trim()&&(t(n.trim()),i(""))):x.key==="Escape"&&(x.preventDefault(),s()))},d=x=>{!n.trim()&&!r&&s()},c=(a+1)*20;return e.jsxs("div",{className:"flex items-center gap-3 py-3 px-4 mb-2 rounded-xl border border-dashed border-brand-300 bg-brand-50/50 animate-in fade-in duration-200",style:{marginLeft:`${c}px`},children:[e.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-brand-200 flex-shrink-0"}),e.jsx("input",{ref:l,type:"text",className:"flex-1 bg-transparent border-none p-0 text-sm font-medium focus:ring-0 placeholder:text-muted-foreground/70",placeholder:"Type a task name...",value:n,onChange:x=>i(x.target.value),onKeyDown:o,onBlur:d,disabled:r}),r&&e.jsx(ie,{className:"w-3 H-3 animate-spin text-brand-500"}),e.jsx("span",{className:"text-[10px] text-muted-foreground font-medium uppercase tracking-wider hidden sm:block",children:"Enter to save â€¢ Esc to cancel"})]})};_a.propTypes={onCommit:b.func.isRequired,onCancel:b.func.isRequired,loading:b.bool,level:b.number};const Ze=({task:t,level:s=0,onTaskClick:r,selectedTaskId:a,onAddChildTask:n,onInviteMember:i,onStatusChange:l,dragHandleProps:o={},forceShowChevron:d=!1,onToggleExpand:c,onEdit:x=null,onDelete:p=null,hideExpansion:h=!1,disableDrag:m=!1,isAddingInline:f=!1,onInlineCommit:j,onInlineCancel:N})=>{const g=t.children&&t.children.length>0,v=s*20,y=a===t.id,k=s<4,D=!!t.isExpanded,T=!h&&k&&(g||d),{setNodeRef:A,isOver:S}=Xe({id:`child-context-${t.id}`,data:{type:"container",parentId:t.id,origin:t.origin}}),O=M=>{M.target.closest(".expand-button")||M.target.closest("select")||M.target.closest("button")||M.target.closest("input")||r&&r(t)},q=M=>{M.stopPropagation(),c&&c(t,!D)},E=t.is_locked||!1;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:w("relative flex flex-col min-w-0 py-4 px-5 mb-3 rounded-xl border transition-all duration-200 shadow-sm","bg-card text-card-foreground",S&&"ring-2 ring-brand-400 bg-brand-50 dark:bg-brand-900/40 z-10",y&&!S?"bg-brand-50 border-brand-500 ring-2 ring-brand-100 dark:bg-brand-900/40 dark:border-brand-400 dark:ring-brand-900/50":!S&&"border-border hover:border-brand-300 dark:hover:border-brand-700",E&&"opacity-70 bg-muted/30 dark:bg-slate-900/50",s===0&&"border-l-4 border-l-brand-600 dark:border-l-brand-500"),style:{marginLeft:`${v}px`},onClick:E?void 0:O,"data-testid":`task-row-${t.id}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 flex items-center min-w-0 overflow-hidden",children:[!m&&e.jsx("button",{className:w("mr-2 p-1 rounded transition-colors flex-shrink-0 cursor-grab active:cursor-grabbing",E?"cursor-not-allowed opacity-30 text-slate-400":"text-slate-400 hover:bg-slate-100 hover:text-slate-600"),type:"button","aria-label":"Reorder task",ref:E?void 0:o?.ref,...E?{}:o,disabled:E,children:E?e.jsx(rs,{className:"w-3 h-3"}):e.jsx(or,{className:"w-4 h-4"})}),T?e.jsx("button",{onClick:q,className:"expand-button p-1 mr-2 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-900 transition-colors flex-shrink-0","aria-label":D?"Collapse":"Expand",children:e.jsx("svg",{className:w("transition-transform duration-200",D?"rotate-90":""),width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})}):e.jsx("div",{className:"w-6 mr-2 flex-shrink-0"}),e.jsxs("div",{className:"flex items-center gap-3 min-w-0 overflow-hidden",children:[e.jsx("span",{className:"font-semibold text-slate-900 dark:text-slate-100 text-sm truncate",title:t.title,dangerouslySetInnerHTML:{__html:xt(t.title)}}),t.duration&&e.jsx("span",{className:"text-xs bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-500 dark:text-slate-400 whitespace-nowrap flex-shrink-0",children:t.duration}),t.resource_type&&e.jsxs("span",{className:"px-2.5 py-1 text-xs uppercase font-bold tracking-wider rounded bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 border border-brand-100 dark:border-brand-800 whitespace-nowrap flex-shrink-0 flex items-center gap-1",children:[e.jsx(ir,{className:"w-3 h-3"}),t.resource_type]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-shrink-0",children:[t.membership_role&&e.jsx(Ms,{role:t.membership_role}),e.jsx(Ei,{status:t.status,taskId:t.id,onStatusChange:l}),e.jsx(Di,{task:t,onEdit:x,onAddChild:n,onInvite:i,onDelete:p,canHaveChildren:k})]})]})}),k&&D&&e.jsx("div",{className:"pl-0 min-h-[40px]",ref:A,children:e.jsxs(js,{items:t.children?t.children.map(M=>M.id):[],strategy:ys,id:`sortable-context-${t.id}`,children:[f&&e.jsx("div",{className:"ml-6 mb-2",children:e.jsx(_a,{onCommit:M=>j(t.id,M),onCancel:N,level:s+1})}),t.children&&t.children.length>0?t.children.map(M=>e.jsx(os,{task:M,level:s+1,onTaskClick:r,selectedTaskId:a,onAddChildTask:n,onInviteMember:i,onStatusChange:l,onToggleExpand:c,onEdit:x,onDelete:p,isAddingInline:M.isAddingInline,onInlineCommit:j,onInlineCancel:N},M.id)):!f&&e.jsx("div",{className:"py-2 px-4 text-xs text-slate-400 italic border-2 border-dashed border-slate-100 rounded-lg ml-6",children:"Drop subtasks here"})]})})]})},os=function({task:s,level:r,...a}){const{attributes:n,listeners:i,setNodeRef:l,setActivatorNodeRef:o,transform:d,transition:c,isDragging:x}=hr({id:s.id,data:{type:"Task",origin:s.origin,parentId:s.parent_task_id??null}}),p={transform:pr.Translate.toString(d),transition:c,opacity:x?.8:1,position:"relative",zIndex:x?999:"auto",scale:x?1.02:1};return e.jsx("div",{ref:l,style:p,className:w("transition-shadow duration-200",x&&"shadow-xl rounded-xl z-50"),children:e.jsx(ds,{FallbackComponent:ws,onReset:()=>window.location.reload(),children:e.jsx(Ze,{task:s,level:r,dragHandleProps:{...n,...i,ref:o},...a})})})};Ze.displayName="@features/tasks/components/TaskItem";const Mi=50,Ca=({project:t,childrenTasks:s,taskItemProps:r,disableDrag:a})=>{const{setNodeRef:n}=Xe({id:`project-view-${t.id}-list`,data:{type:"container",parentId:t.id,origin:t.origin,view:"list"},disabled:a}),i=u.useCallback(o=>{const d=s[o];return d?a?e.jsx(Ze,{task:d,level:0,...r},d.id):e.jsx(os,{task:d,level:0,...r},d.id):null},[s,a,r]);return s.length>Mi&&a?e.jsx("div",{ref:n,className:"task-cards-container h-full",children:e.jsx(co,{style:{height:"100%"},totalCount:s.length,itemContent:i,className:"space-y-2",components:{Item:({children:o,...d})=>e.jsx("div",{...d,className:"mb-2",children:o})}})}):a?e.jsx("div",{ref:n,className:"task-cards-container space-y-2",children:s.map(o=>e.jsx(Ze,{task:o,level:0,...r},o.id))}):e.jsx(js,{items:s.map(o=>o.id),strategy:ys,id:`sortable-project-${t.id}`,children:e.jsx("div",{ref:n,className:"task-cards-container space-y-2",children:s.map(o=>e.jsx(os,{task:o,level:0,...r},o.id))})})};Ca.propTypes={project:b.object.isRequired,childrenTasks:b.array.isRequired,taskItemProps:b.object.isRequired,disableDrag:b.bool};const Ri=t=>{if(!t)return null;try{const s=new Date(t);return isNaN(s.getTime())?null:Ne(s,"MMM d")}catch{return null}},Ii=t=>{if(!t)return"text-slate-400 dark:text-slate-500";try{const s=new Date(t);return isNaN(s.getTime())?"text-slate-400 dark:text-slate-500":lo(s)&&!As(s)?"text-rose-600 dark:text-rose-400":As(s)?"text-amber-600 dark:text-amber-400":"text-slate-500 dark:text-slate-400"}catch{return"text-slate-400 dark:text-slate-500"}},Rs=u.memo(({task:t,onClick:s,dragHandleProps:r,style:a,isDragging:n})=>{const i=Ri(t.due_date),l=Ii(t.due_date);return e.jsxs("div",{className:`bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md dark:hover:shadow-slate-900/50 transition-shadow cursor-pointer group mb-2 ${n?"opacity-50 ring-2 ring-brand-500":""}`,style:a,onClick:()=>s(t),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("button",{className:"cursor-grab active:cursor-grabbing text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 p-0.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700",...r,children:e.jsx(or,{className:"w-4 h-4"})}),t.resource_type&&e.jsx("span",{className:"p-1 rounded bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300",children:e.jsx(ir,{className:"w-3 h-3"})})]}),t.breadcrumbs&&e.jsx("div",{className:"mb-0.5 text-xs text-slate-400 dark:text-slate-500 font-medium truncate",title:t.breadcrumbs,children:t.breadcrumbs}),e.jsx("h4",{className:"text-sm font-medium text-slate-800 dark:text-slate-100 line-clamp-3 leading-snug",children:t.title})]}),t.membership_role&&e.jsx(Ms,{role:t.membership_role,size:"sm"})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-between text-xs",children:[t.children&&t.children.length>0?e.jsxs("div",{className:"text-slate-400 dark:text-slate-500 flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:t.children.length})," subtasks"]}):e.jsx("div",{}),i&&e.jsxs("div",{className:`flex items-center gap-1 ${l}`,children:[e.jsx(Ie,{className:"w-3 h-3"}),e.jsx("span",{children:i})]})]})]})});Rs.displayName="BoardTaskCard";Rs.propTypes={task:b.object.isRequired,onClick:b.func,dragHandleProps:b.object,style:b.object,isDragging:b.bool};const Is=u.memo(({task:t,onClick:s})=>{const{attributes:r,listeners:a,setNodeRef:n,transform:i,transition:l,isDragging:o}=hr({id:t.id,data:{type:"Task",origin:t.origin,parentId:t.parent_task_id??null,status:t.status}}),d={transform:pr.Translate.toString(i),transition:l};return e.jsx("div",{ref:n,style:d,className:"touch-none",children:e.jsx(Rs,{task:t,onClick:s,dragHandleProps:{...r,...a},isDragging:o})})});Is.displayName="SortableBoardTaskCard";Is.propTypes={task:b.object.isRequired,onClick:b.func};const Ta=({id:t,title:s,tasks:r,onTaskClick:a,className:n,parentId:i})=>{const{setNodeRef:l,isOver:o}=Xe({id:`column-${t}`,data:{type:"container",status:t,isColumn:!0,parentId:i}});return e.jsxs("div",{className:w("flex flex-col min-w-[280px] w-[280px] rounded-xl bg-slate-50/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 h-full max-h-full",n),children:[e.jsxs("div",{className:w("p-3 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm rounded-t-xl z-10",o&&"bg-brand-50/50 dark:bg-brand-900/30"),children:[e.jsx("h3",{className:"font-semibold text-sm text-slate-700 dark:text-slate-200 uppercase tracking-wide",children:s}),e.jsx("span",{className:"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs py-0.5 px-2 rounded-full font-medium",children:r.length})]}),e.jsx("div",{ref:l,className:"flex-1 p-2 overflow-y-auto min-h-0 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600 scrollbar-track-transparent",children:e.jsx(js,{items:r.map(d=>d.id),strategy:ys,children:e.jsx("div",{className:"flex flex-col gap-2 min-h-[50px]",children:r.map(d=>e.jsx(Is,{task:d,onClick:a},d.id))})})})]})};Ta.propTypes={id:b.string.isRequired,title:b.string.isRequired,tasks:b.array.isRequired,onTaskClick:b.func.isRequired,className:b.string,parentId:b.string};const Ai=[{id:R.TODO,title:"To Do"},{id:R.IN_PROGRESS,title:"In Progress"},{id:R.BLOCKED,title:"Blocked"},{id:R.COMPLETED,title:"Complete"}],Sa=({project:t,childrenTasks:s,handleTaskClick:r})=>{const a=u.useMemo(()=>{const n=new Map(s.map(o=>[o.id,o])),i=o=>{const d=[];let c=o,x=0;for(;c&&c.parent_task_id&&x<5;){const p=n.get(c.parent_task_id);if(p)d.unshift(p.title),c=p;else break;x++}return d.join(" > ")},l={[R.TODO]:[],[R.IN_PROGRESS]:[],[R.BLOCKED]:[],[R.COMPLETED]:[]};return s.forEach(o=>{const d=o.status||R.TODO,c={...o,breadcrumbs:i(o)};l[d]?l[d].push(c):l[R.TODO].push(c)}),Object.keys(l).forEach(o=>{l[o].sort((d,c)=>(d.position||0)-(c.position||0))}),l},[s]);return e.jsx("div",{className:"flex h-full gap-4 overflow-x-auto pb-4 items-start px-2",children:Ai.map(n=>e.jsx(Ta,{id:n.id,title:n.title,tasks:a[n.id],onTaskClick:r,parentId:t.id},n.id))})},Pa=({project:t,handleTaskClick:s,handleAddChildTask:r,handleEditTask:a,handleDeleteById:n,selectedTaskId:i,onToggleExpand:l,disableDrag:o=!1,hydrationError:d=null,onInviteMember:c,onStatusChange:x})=>{const[p,h]=u.useState("list"),{setNodeRef:m}=Xe({id:`project-view-${t.id}`,data:{type:"container",parentId:t.id,origin:t.origin},disabled:o}),f=t.children||[],j={onTaskClick:s,selectedTaskId:i,onAddChildTask:r,onEdit:a,onDelete:n,hideExpansion:!1,onToggleExpand:l,onStatusChange:x};return e.jsxs("div",{className:"project-view-container px-4 sm:px-8 py-6 w-full h-full flex flex-col bg-background/30",children:[e.jsxs("div",{className:"flex-none mb-6",children:[e.jsx(Ut,{project:t,onInviteMember:c,onStatusChange:N=>x(t.id,N)}),e.jsxs("div",{className:"mt-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 border-b border-border pb-4",children:[e.jsxs("button",{onClick:()=>r(t),className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 text-sm font-medium flex items-center transition-all shadow-sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v16m8-8H4"})}),"Add Task"]}),e.jsxs("div",{className:"flex bg-muted p-1 rounded-lg border border-border",children:[e.jsxs("button",{onClick:()=>h("list"),className:`p-2 rounded-md transition-all flex items-center gap-2 text-sm font-medium ${p==="list"?"bg-card text-card-foreground shadow-sm":"text-muted-foreground hover:text-card-foreground hover:bg-muted/50"}`,title:"List View",children:[e.jsx(yn,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"List"})]}),e.jsxs("button",{onClick:()=>h("board"),className:`p-2 rounded-md transition-all flex items-center gap-2 text-sm font-medium ${p==="board"?"bg-card text-card-foreground shadow-sm":"text-muted-foreground hover:text-card-foreground hover:bg-muted/50"}`,title:"Board View",children:[e.jsx(vn,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Board"})]})]})]})]}),d&&e.jsx("div",{className:"flex-none mb-4 p-4 bg-rose-50 border border-rose-200 rounded-lg text-rose-700 text-sm",children:d}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:f.length>0?p==="board"?e.jsx(Sa,{project:t,childrenTasks:f,handleTaskClick:s}):e.jsx(Ca,{project:t,childrenTasks:f,taskItemProps:j,disableDrag:o,setNodeRef:m}):e.jsxs("div",{ref:m,className:"text-center py-12 border-2 border-dashed border-border rounded-xl bg-muted/30 h-full flex flex-col items-center justify-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"No tasks in this project yet."}),e.jsx("button",{onClick:()=>r(t),className:"px-4 py-2 bg-card border border-border rounded-lg text-card-foreground hover:bg-muted text-sm font-medium",children:"Create First Task"})]})})]})};Pa.propTypes={project:b.object.isRequired,handleTaskClick:b.func.isRequired,handleAddChildTask:b.func.isRequired,handleEditTask:b.func.isRequired,handleDeleteById:b.func.isRequired,selectedTaskId:b.string,onToggleExpand:b.func,disableDrag:b.bool,hydrationError:b.string,onInviteMember:b.func,onStatusChange:b.func};const kt=to,_t=so,Li=u.forwardRef(({className:t,inset:s,children:r,...a},n)=>e.jsxs(Rr,{ref:n,className:w("flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s&&"pl-8",t),...a,children:[r,e.jsx(ze,{className:"ml-auto"})]}));Li.displayName=Rr.displayName;const Oi=u.forwardRef(({className:t,...s},r)=>e.jsx(Ir,{ref:r,className:w("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s}));Oi.displayName=Ir.displayName;const at=u.forwardRef(({className:t,sideOffset:s=4,...r},a)=>e.jsx(eo,{children:e.jsx(Ar,{ref:a,sideOffset:s,className:w("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})}));at.displayName=Ar.displayName;const be=u.forwardRef(({className:t,inset:s,...r},a)=>e.jsx(Lr,{ref:a,className:w("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",s&&"pl-8",t),...r}));be.displayName=Lr.displayName;const $i=u.forwardRef(({className:t,children:s,checked:r,...a},n)=>e.jsxs(Or,{ref:n,className:w("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:r,...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx($r,{children:e.jsx(ht,{className:"h-4 w-4"})})}),s]}));$i.displayName=Or.displayName;const qi=u.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(qr,{ref:a,className:w("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx($r,{children:e.jsx(gs,{className:"h-2 w-2 fill-current"})})}),s]}));qi.displayName=qr.displayName;const Fi=u.forwardRef(({className:t,inset:s,...r},a)=>e.jsx(Fr,{ref:a,className:w("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",t),...r}));Fi.displayName=Fr.displayName;const bt=u.forwardRef(({className:t,...s},r)=>e.jsx(Ur,{ref:r,className:w("-mx-1 my-1 h-px bg-muted",t),...s}));bt.displayName=Ur.displayName;const Ea=u.forwardRef(({className:t,...s},r)=>e.jsx(Br,{ref:r,className:w("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...s}));Ea.displayName=Br.displayName;const Ui=u.forwardRef(({className:t,...s},r)=>e.jsx(Vr,{ref:r,className:w("aspect-square h-full w-full",t),...s}));Ui.displayName=Vr.displayName;const Da=u.forwardRef(({className:t,...s},r)=>e.jsx(zr,{ref:r,className:w("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...s}));Da.displayName=zr.displayName;function Bi(){return de({queryKey:["currentUser"],queryFn:()=>I.auth.me(),staleTime:1e3*60*5,retry:!1})}function Vi(){const{actualRole:t,viewingAs:s,effectiveRole:r,canViewAs:a,availableRoles:n,setViewingAs:i,resetViewAs:l}=Mo();if(!a)return null;const o=s!==null,d=n.find(c=>c.value===r)?.label||r;return e.jsxs(kt,{children:[e.jsx(_t,{asChild:!0,children:e.jsxs(P,{variant:o?"default":"ghost",size:"sm",className:`
            flex items-center gap-2 text-sm font-medium
            ${o?"bg-amber-100 text-amber-800 hover:bg-amber-200 dark:bg-amber-900/50 dark:text-amber-200 dark:hover:bg-amber-800/50":"text-slate-700 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200"}
          `,children:[e.jsx(Nn,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:o?`Viewing as ${d}`:"View As"}),e.jsx(us,{className:"w-3 h-3"})]})}),e.jsxs(at,{align:"end",className:"w-48",children:[e.jsx("div",{className:"px-2 py-1.5 text-xs text-slate-500 dark:text-slate-400 font-medium",children:"Preview as role"}),e.jsx(bt,{}),e.jsx(be,{onClick:l,className:o?"":"bg-slate-100 dark:bg-slate-700",children:e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsxs("span",{className:"flex-1",children:[t.charAt(0).toUpperCase()+t.slice(1),e.jsx("span",{className:"text-xs text-slate-400 ml-1",children:"(You)"})]}),!o&&e.jsx(ht,{className:"w-4 h-4 text-brand-600"})]})}),e.jsx(bt,{}),n.filter(c=>c.value!==t).map(c=>e.jsx(be,{onClick:()=>i(c.value),className:s===c.value?"bg-amber-50 dark:bg-amber-900/30":"",children:e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx("span",{className:"flex-1",children:c.label}),s===c.value&&e.jsx(ht,{className:"w-4 h-4 text-amber-600"})]})},c.value))]})]})}function zi({onMenuToggle:t,showMenuButton:s=!1}){const{data:r}=Bi(),a=tr(),{resolvedTheme:n,toggleTheme:i}=Po(),l=a.pathname.split("/").filter(Boolean),o=l[0]?l[0].charAt(0).toUpperCase()+l[0].slice(1):"Home",d=we(),{signOut:c}=ce(),x=async()=>{await c(),d("/auth/login")},p=h=>h?h.split(" ").map(m=>m[0]).join("").toUpperCase().slice(0,2):"U";return e.jsx("nav",{className:"bg-card text-card-foreground border-b border-border sticky top-0 z-50 shadow-sm",children:e.jsx("div",{className:"px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s&&e.jsx(P,{variant:"ghost",size:"icon",onClick:t,className:"lg:hidden","aria-label":"Menu",children:e.jsx(wn,{className:"w-5 h-5"})}),e.jsxs(he,{to:Ce("Dashboard"),className:"flex items-center gap-2","aria-label":"PlanterPlan Home",children:[e.jsx("div",{className:"w-9 h-9 bg-orange-500 rounded-lg flex items-center justify-center shadow-sm",children:e.jsx(Ue,{className:"w-5 h-5 text-white"})}),e.jsx("span",{className:"font-bold text-orange-600 dark:text-orange-500 text-lg hidden sm:block",children:"PlanterPlan"})]}),r&&e.jsxs("div",{className:"hidden md:flex items-center gap-2 ml-2 text-slate-400",children:[e.jsx(ze,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium text-orange-600 dark:text-orange-500",children:o})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx(Vi,{}),e.jsx(P,{variant:"ghost",size:"icon",onClick:i,"aria-label":n==="dark"?"Switch to light mode":"Switch to dark mode",className:"text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200",children:n==="dark"?e.jsx(kn,{className:"w-5 h-5"}):e.jsx(_n,{className:"w-5 h-5"})}),r&&e.jsxs(kt,{children:[e.jsx(_t,{asChild:!0,children:e.jsx(P,{variant:"ghost",className:"relative h-9 w-9 rounded-full",children:e.jsx(Ea,{className:"h-9 w-9 border-2 border-slate-200 dark:border-slate-600",children:e.jsx(Da,{className:"bg-orange-100 text-orange-700 font-semibold text-sm dark:bg-orange-900 dark:text-orange-200",children:p(r.full_name||r.email)})})})}),e.jsxs(at,{className:"w-56",align:"end",children:[e.jsx("div",{className:"flex items-center justify-start gap-2 p-2",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:r.full_name||"User"}),e.jsx("p",{className:"text-xs leading-none text-slate-500 dark:text-slate-400",children:r.email})]})}),e.jsx(bt,{}),e.jsxs(be,{children:[e.jsx(lr,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Profile"})]}),e.jsx(he,{to:Ce("Settings"),children:e.jsxs(be,{children:[e.jsx(Mt,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Settings"})]})}),e.jsx(bt,{}),e.jsxs(be,{onClick:x,className:"text-red-600 dark:text-red-400",children:[e.jsx(Cn,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Log out"})]})]})]})]})]})})})}const Ws=20,Ki=(t,s)=>{const r=new Set(t.map(n=>n.id)),a=s.filter(n=>!r.has(n.id));return[...t,...a]},Hi=()=>{const[t,s]=u.useState([]),[r,a]=u.useState({}),[n,i]=u.useState([]),[l,o]=u.useState(!0),[d,c]=u.useState(null),[x,p]=u.useState(null),[h,m]=u.useState(null),[f,j]=u.useState(1),[N,g]=u.useState(!1),[v,y]=u.useState(!1),k=u.useRef(!1),D=u.useCallback(async(K=1)=>{if(k.current){K===1?o(!0):y(!0),c(null);try{const{data:{user:U}}=await Q.auth.getUser();if(!k.current)return;if(!U){c("User not authenticated"),s([]);return}m(U.id);const{data:_,error:F}=await pa(U.id,K,Ws);let H=[];try{const{data:ee}=await Q.from("tasks_with_primary_resource").select("*").eq("creator",U.id).eq("origin","template").is("parent_task_id",null).order("title",{ascending:!0});H=ee||[]}catch(ee){ee.name!=="AbortError"&&console.error("Template fetch error",ee)}const Pe=null;if(F)throw F;if(!k.current)return;const X=_||[],Z=H||[];if(s(ee=>K===1?[...X,...Z]:Ki(ee,X)),j(K),g(X.length===Ws),K===1){const{data:ee,error:ve}=await fa(U.id);k.current&&(ve&&p("Failed to load joined projects"),i(ee||[]))}}catch(U){if(!k.current)return;U.name==="AbortError"?console.warn("Fetch projects aborted (harmless)"):(console.error("Fetch projects exception:",U),c("Failed to fetch projects"))}finally{k.current&&(o(!1),y(!1))}}},[]),T=u.useCallback(()=>{N&&!v&&D(f+1)},[N,v,f,D]),A=u.useCallback(async K=>{if(!r[K])try{const{data:U,error:_}=await Hs(K);if(_)throw _;const F=U.filter(H=>H.id!==K);return a(H=>({...H,[K]:F})),F}catch(U){console.error("Failed to hydrate project:",U)}},[r]),S=u.useCallback(async K=>{try{const{data:U,error:_}=await Hs(K);if(_)throw _;const F=U.filter(H=>H.id!==K);a(H=>({...H,[K]:F}))}catch(U){console.error("Failed to refresh project:",U)}},[]),O=u.useCallback(()=>D(1),[D]),q=u.useCallback(K=>{if(!K)return null;const U=t.find(_=>_.id===K)||n.find(_=>_.id===K);if(U)return U;for(const _ of Object.values(r)){const F=_.find(H=>H.id===K);if(F)return F}return null},[t,n,r]),{user:E,loading:M}=ce();u.useEffect(()=>{if(k.current=!0,!M&&E){if(E.id===h)return;m(E.id),D(1)}return()=>{k.current=!1}},[D,M,E,h]);const z=u.useCallback(async K=>{const U=q(K);if(U){const _=U.root_id||(U.parent_task_id?q(U.parent_task_id)?.root_id:null);if(_){await S(_);return}}await D(f)},[q,S,D,f]);return{tasks:t,setTasks:s,joinedProjects:n,hydratedProjects:r,setHydratedProjects:a,loading:l,error:d,joinedError:x,currentUserId:h,fetchTasks:O,fetchProjects:D,fetchProjectDetails:A,refreshProjectDetails:S,findTask:q,hasMore:N,isFetchingMore:v,loadMoreProjects:T,page:f,commitOptimisticUpdate:z}},Ma=({tasks:t,fetchTasks:s,fetchProjects:r,refreshProjectDetails:a,findTask:n,joinedProjects:i,hydratedProjects:l,commitOptimisticUpdate:o})=>{const d=u.useCallback(async h=>{if(h){const m=h.root_id||(h.parent_task_id?n(h.parent_task_id)?.root_id:null);if(m){await a(m);return}}await s()},[n,a,s]),c=u.useCallback(async(h,m)=>{try{const{data:{user:f}}=await Q.auth.getUser();if(!f)throw new Error("User not authenticated");const j=m.origin||"instance",N=m.parentId??null,g=h.days_from_start,v=g===""||g===null||g===void 0?null:Number(g);if(v!==null&&Number.isNaN(v))throw new Error("Invalid days_from_start");const y=ge(h.start_date),k=ge(h.due_date),D=!!(y||k);let T=t,A=null;if(N){const E=n(N);if(E&&(A=E.root_id||E.id,A)){T=l[A]||[];const M=t.find(z=>z.id===A)||i.find(z=>z.id===A);M&&(T=[...T,M])}}else T=t;if(m.mode==="edit"&&m.taskId){let E={};j==="instance"&&(v!==null&&(E=ts(T,m.parentId,v)),D&&(E={start_date:y,due_date:k||y||E.due_date||null}),!D&&v===null&&(E={}));const M={title:h.title,description:h.description??null,notes:h.notes??null,purpose:h.purpose??null,actions:h.actions??null,days_from_start:v,updated_at:new Date().toISOString(),...E},{error:z}=await I.entities.Task.update(m.taskId,M);if(z)throw z;A?await a(A):await r(1),N&&j==="instance"&&(await qe(N),A&&await a(A));return}const S=T.filter(E=>E.origin===j&&(E.parent_task_id||null)===N),O=S.length>0?Math.max(...S.map(E=>E.position??0)):0,q={title:h.title,description:h.description??null,notes:h.notes??null,purpose:h.purpose??null,actions:h.actions??null,days_from_start:v,origin:j,creator:f.id,parent_task_id:N,position:O+ea,is_complete:!1,root_id:A};if(j==="instance"&&(v!==null&&Object.assign(q,ts(T,N,v)),D&&(q.start_date=y,q.due_date=k||y||q.due_date||null)),h.templateId){const{data:E,error:M}=await ua(h.templateId,N,j,f.id,{title:h.title,description:h.description,start_date:D?y:null,due_date:D?k||y:null});if(M)throw M;if(E&&E.new_root_id&&v!==null){const z={days_from_start:v,updated_at:new Date().toISOString()};j==="instance"&&v!==null&&Object.assign(z,ts(T,N,v));const{error:K}=await I.entities.Task.update(E.new_root_id,z);K&&console.error("Error updating cloned root schedule",K)}}else{const{error:E}=await I.entities.Task.create(q);if(E)throw E}A?await a(A):await r(1),N&&j==="instance"&&(await qe(N),A&&await a(A))}catch(f){throw console.error("Error saving task:",f),o&&m?.taskId&&o(m.taskId),f}},[t,i,l,r,a,n]),x=u.useCallback(async h=>{try{const m=typeof h=="object"?h.id:h,f=typeof h=="object"?h:n(m),j=f?f.parent_task_id:null,{error:N}=await I.entities.Task.delete(m);if(N)throw N;await d(f),j&&f&&f.origin==="instance"&&(await qe(j),await d(n(j)))}catch(m){if(console.error("Error deleting task:",m),o){const f=typeof h=="object"?h.id:h;o(f)}throw m}},[n,d]),p=u.useCallback(async(h,m)=>{try{const f=n(h),j=f?f.parent_task_id:null,{error:N}=await I.entities.Task.update(h,m);if(N)throw N;await d(f),f&&f.origin==="instance"&&((m.start_date!==void 0||m.due_date!==void 0)&&f.parent_task_id&&await qe(f.parent_task_id),m.parent_task_id!==void 0&&m.parent_task_id!==j&&(j&&await qe(j),m.parent_task_id&&await qe(m.parent_task_id)),await d(f))}catch(f){throw console.error("Error updating task:",f),o&&o(h),f}},[n,d]);return{createTaskOrUpdate:c,deleteTask:x,updateTask:p}},Ra=({projectId:t,refreshProjectDetails:s})=>{const r=Te(),a=u.useRef(0);u.useEffect(()=>{if(!t)return;const n=Q.channel(`project-tasks:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"tasks"},i=>{const l=Date.now();if(l-a.current<500)return;a.current=l;const o=i.new||i.old;(o.id===t||o.root_id===t||o.parent_task_id===t)&&(r.invalidateQueries({queryKey:["projectHierarchy",t]}),(o.id===t||!o.root_id)&&(r.invalidateQueries({queryKey:["project",t]}),s&&s(t)))}).subscribe((i,l)=>{l&&console.error("[useTaskSubscription] Channel error:",l)});return()=>{Q.removeChannel(n)}},[t,r,s])},Gs=t=>{const s={},r=[];return t.forEach(a=>{s[a.id]={...a,children:[]}}),t.forEach(a=>{a.parent_task_id&&s[a.parent_task_id]?s[a.parent_task_id].children.push(s[a.id]):r.push(s[a.id])}),Object.values(s).forEach(a=>{a.children.sort((n,i)=>(n.position??0)-(i.position??0))}),r.sort((a,n)=>(a.position??0)-(n.position??0))},Ia=t=>{const s=t.filter(a=>a.origin==="instance"),r=t.filter(a=>a.origin==="template");return{instanceTasks:Gs(s),templateTasks:Gs(r)}},Aa=()=>{const t=Hi(),{instanceTasks:s,templateTasks:r}=u.useMemo(()=>Ia(t.tasks||[]),[t.tasks]),a=Ma({tasks:t.tasks,fetchTasks:t.fetchTasks,fetchProjects:t.fetchProjects,refreshProjectDetails:t.refreshProjectDetails,findTask:t.findTask,joinedProjects:t.joinedProjects,hydratedProjects:t.hydratedProjects,commitOptimisticUpdate:t.commitOptimisticUpdate});Ra({refreshProjectDetails:t.refreshProjectDetails});const n=wa({tasks:t.tasks,fetchTasks:t.fetchTasks});return{...t,instanceTasks:s,templateTasks:r,...a,...n,handleOptimisticUpdate:t.handleOptimisticUpdate,commitOptimisticUpdate:t.commitOptimisticUpdate}};function La(){const{user:t}=ce();return de({queryKey:["userProjects",t?.id],queryFn:async()=>{if(!t)return[];const{data:s}=await pa(t.id),{data:r}=await fa(t.id),a=new Map;return s&&s.forEach(n=>a.set(n.id,n)),r&&r.forEach(n=>a.set(n.id,n)),Array.from(a.values())},enabled:!!t})}function Wi({onNavClick:t,selectedTaskId:s}){const r=we(),{data:a,isLoading:n}=La(),{templateTasks:i=[],loading:l,error:o,joinedError:d,loadMoreProjects:c,hasMore:x,isFetchingMore:p}=Aa(),{user:h}=ce(),m=a?.filter(v=>v.creator===h?.id||v.owner_id===h?.id)||[],f=a?.filter(v=>v.creator!==h?.id&&v.owner_id!==h?.id)||[],j=v=>{r(`/project/${v.id}`)},N=()=>{r("/dashboard?action=new-project")},g=()=>{r("/dashboard?action=new-template")};return e.jsx(Ft,{instanceTasks:m,joinedProjects:f,templateTasks:i,loading:n||l,error:o,joinedError:d,handleSelectProject:j,selectedTaskId:s,onNewProjectClick:N,onNewTemplateClick:g,onNavClick:t,onLoadMore:c,hasMore:x,isFetchingMore:p})}function Gi({projects:t=[]}){const[s,r]=u.useState(!1),a=we();u.useEffect(()=>{const l=o=>{o.key==="k"&&(o.metaKey||o.ctrlKey)&&(o.preventDefault(),r(d=>!d))};return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[]);const n=u.useCallback(l=>{r(!1),l()},[]),i=u.useMemo(()=>t.map(l=>e.jsxs(He,{onSelect:()=>n(()=>a(`/projects/${l.id}`)),children:[e.jsx(Tn,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:l.title})]},l.id)),[t,a,n]);return e.jsx(e.Fragment,{children:e.jsxs(gi,{open:s,onOpenChange:r,children:[e.jsx(Ps,{placeholder:"Type a command or search..."}),e.jsxs(Es,{children:[e.jsx(Ds,{children:"No results found."}),e.jsxs(mt,{heading:"Suggestions",children:[e.jsxs(He,{onSelect:()=>n(()=>a("/dashboard")),children:[e.jsx(rr,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Dashboard"})]}),e.jsxs(He,{onSelect:()=>n(()=>a("/settings")),children:[e.jsx(Mt,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Settings"}),e.jsx(ma,{children:"âŒ˜S"})]})]}),e.jsx(ns,{}),e.jsx(mt,{heading:"Projects",children:i}),e.jsx(ns,{}),e.jsx(mt,{heading:"Actions",children:e.jsxs(He,{onSelect:()=>n(()=>a("/team")),children:[e.jsx(lr,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Team"})]})})]})]})})}function Qi({onAddTask:t}){const s=we();return e.jsx("div",{className:"fixed bottom-6 right-6 md:hidden z-50",children:e.jsxs(kt,{children:[e.jsx(_t,{asChild:!0,children:e.jsx(P,{size:"icon",className:"w-14 h-14 rounded-full shadow-xl bg-brand-600 hover:bg-brand-700 text-white","aria-label":"Add Task",children:e.jsx(Re,{className:"w-8 h-8"})})}),e.jsxs(at,{align:"end",className:"mb-2",children:[e.jsx(be,{onClick:t,className:"cursor-pointer",children:"New Task"}),e.jsx(be,{onClick:()=>s("/projects/new"),className:"cursor-pointer",children:"New Project"})]})]})})}function pe({children:t,sidebar:s,selectedTaskId:r}){const[a,n]=u.useState(!1),{user:i}=ce(),{data:l}=La(i?.id);return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Gi,{projects:l||[]}),e.jsx(zi,{onMenuToggle:()=>n(!a),showMenuButton:!0}),e.jsx("div",{className:w("fixed top-16 left-0 bottom-0 w-64 bg-card border-r border-border z-40 transition-transform duration-300 lg:translate-x-0 shadow-lg lg:shadow-none",a?"translate-x-0":"-translate-x-full"),children:s||e.jsx(Wi,{onNavClick:()=>n(!1),selectedTaskId:r})}),a&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/50 dark:bg-black/60 z-40 lg:hidden",onClick:()=>n(!1)}),e.jsx("main",{className:"lg:pl-64 pt-6 h-[calc(100vh-4rem)]",children:t}),e.jsx(Qi,{onAddTask:()=>{}})]})}const Ji=(t,s,r,a,n)=>t?"New Project":s?s.mode==="edit"?r?`Edit ${r.title}`:"Edit Task":s.origin==="template"?n?`New Template Task in ${n.title}`:"New Template Task":n?`New Task in ${n.title}`:"New Task":a?a.title:"Details";function Oa({showForm:t,taskFormState:s,selectedTask:r,taskBeingEdited:a,parentTaskForForm:n,onClose:i,handleProjectSubmit:l,handleTaskSubmit:o,setTaskFormState:d,handleAddChildTask:c,handleEditTask:x,onDeleteTaskWrapper:p,fetchTasks:h}){const m=u.useMemo(()=>Ji(t,s,a,r,n),[t,s,a,n,r]),f=!!s;return e.jsxs("aside",{className:"w-1/3 min-w-96 bg-white dark:bg-card border-l border-slate-200 dark:border-border flex flex-col flex-shrink-0 shadow-2xl z-30 h-full overflow-hidden transition-all duration-300",children:[e.jsxs("div",{className:"pt-8 px-6 pb-6 border-b border-slate-100 dark:border-border flex justify-between items-start bg-white dark:bg-card sticky top-0 z-20",children:[e.jsx("h2",{className:"font-bold text-xl text-slate-800 dark:text-foreground truncate pr-4",title:m,children:m}),e.jsx("button",{onClick:i,className:"text-slate-400 dark:text-muted-foreground hover:text-slate-700 dark:hover:text-foreground p-2 rounded-full hover:bg-slate-100 dark:hover:bg-muted transition-colors focus:outline-none focus:ring-2 focus:ring-brand-500/20","aria-label":"Close panel",children:e.jsx(vt,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 custom-scrollbar bg-white dark:bg-card",children:t?e.jsx(Zo,{onSubmit:l,onCancel:i}):f?e.jsx(ti,{parentTask:n,initialTask:a,origin:s?.origin,enableLibrarySearch:s?.mode!=="edit",submitLabel:s?.mode==="edit"?"Save Changes":"Add Task",onSubmit:o,onCancel:()=>d(null)}):r?e.jsx(xa,{task:r,onAddChildTask:c,onEditTask:x,onDeleteTask:p,onTaskUpdated:h}):null})]})}Oa.propTypes={showForm:b.bool.isRequired,taskFormState:b.object,selectedTask:b.object,taskBeingEdited:b.object,parentTaskForForm:b.object,onClose:b.func.isRequired,handleProjectSubmit:b.func.isRequired,handleTaskSubmit:b.func.isRequired,setTaskFormState:b.func.isRequired,handleAddChildTask:b.func.isRequired,handleEditTask:b.func.isRequired,onDeleteTaskWrapper:b.func.isRequired,fetchTasks:b.func.isRequired};function $a({onCreateProject:t}){return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-500 py-20",children:[e.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(Sn,{className:"w-8 h-8 text-slate-400"})}),e.jsx("h2",{className:"text-xl font-semibold mb-2 text-slate-700",children:"No Project Selected"}),e.jsx("p",{className:"max-w-md text-center mb-6",children:"Select a project to view tasks."}),e.jsxs("button",{onClick:t,className:"flex items-center space-x-2 px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 shadow-sm font-medium transition-colors",children:[e.jsx(sr,{className:"w-5 h-5"}),e.jsx("span",{children:"Create New Project"})]})]})}$a.propTypes={onCreateProject:b.func.isRequired};const Yi=2,Zi=(t,s)=>{const r=Number(t??0),n=s!=null?Number(s):r+ea*2;return n-r<Yi?null:Math.floor((r+n)/2)},Xi=async t=>{if(!(!t||t.length===0))try{const s=t.map(({id:r,...a})=>I.entities.Task.update(r,a));await Promise.all(s)}catch(s){throw console.error("Failed to batch update tasks:",s),s}},el=(t,s,r,a)=>{const n=s.id,i=r.id;if(!t.find(y=>y.id===n))return{isValid:!1};let o=null,d=null;const c=r.data?.current||{};if(c.type==="container")o=c.parentId??null,d=c.origin,o&&t.find(y=>y.id===o);else{const y=t.find(k=>k.id===i);if(y)o=y.parent_task_id??null,d=y.origin;else return{isValid:!1}}if(o){let y=o,k=0;for(;y&&k<100;){if(y===n)return console.warn("Cannot drop a parent into its own child (Circular dependency detected)"),{isValid:!1};const D=t.find(T=>T.id===y);y=D&&D.parent_task_id||null,k++}}if(a!==d)return{isValid:!1};const x=t.filter(y=>(y.parent_task_id??null)===o&&y.origin===a).sort((y,k)=>(y.position??0)-(k.position??0)),p=x.findIndex(y=>y.id===n),h=x.findIndex(y=>y.id===i);let m,f;c.type==="container"?x.length>0?(m=x[x.length-1],f=null):(m=null,f=null):p!==-1&&p<h?(m=x[h],f=x[h+1]):(m=x[h-1],f=x[h]);const N=m?m.position??0:0,g=f?f.position??0:null;return{isValid:!0,newPos:Zi(N,g),newParentId:o}},tl=(t,s)=>{const r=new Map;for(const i of t){const l=i.parent_task_id;l&&(r.has(l)||r.set(l,[]),r.get(l).push(i))}const a=[],n=[s];for(;n.length;){const i=n.shift(),l=r.get(i)||[];for(const o of l)a.push(o),n.push(o.id)}return a},sl=(t,s,r,a)=>{if(!r||!a)return[];const n=typeof r=="string"?Ge(r):r,i=typeof a=="string"?Ge(a):a;if(!Qe(n)||!Qe(i))return[];const l=Wr(i,n);if(l===0)return[];const o=tl(t,s),d=[];for(const c of o)if(c.start_date){const x=typeof c.start_date=="string"?Ge(c.start_date):c.start_date;if(Qe(x)){const p=Gr(x,l);d.push({id:c.id,start_date:Ne(p,"yyyy-MM-dd")})}}return d},rl=({tasks:t,setTasks:s,fetchTasks:r,updateTaskStatus:a,handleOptimisticUpdate:n,commitOptimisticUpdate:i})=>{const[l,o]=u.useState(null),d=Rt(Je(It),Je(gr,{coordinateGetter:fr})),c=u.useCallback(async x=>{try{const{active:p,over:h}=x;if(!h||p.id===h.id)return;const m=t.find(S=>S.id===p.id);if(!m)return;const f=h.data?.current||{};let j=null;if((f.isColumn||f.status)&&(j=f.status),j&&j!==m.status&&a){const S=m.status;n?n(p.id,{status:j}):s(O=>O.map(q=>q.id===p.id?{...q,status:j}:q));try{await a(p.id,j)}catch(O){console.error("Failed to update status",O),i?i(p.id):n?n(p.id,{status:S}):s(q=>q.map(E=>E.id===p.id?{...E,status:S}:E));return}}let g=el(t,p,h,m.origin);if(!g.isValid)return;let{newPos:v,newParentId:y}=g;if(v===null){console.warn("Position collision, simple dnd aborting for safety.");return}const k=[];let D=null;if(y!==m.parent_task_id){const S=t.find(q=>q.id===m.parent_task_id),O=t.find(q=>q.id===y);if(S?.start_date&&O?.start_date&&m.start_date){const q=Ge(S.start_date),E=Ge(O.start_date),M=Ge(m.start_date);if(Qe(q)&&Qe(E)&&Qe(M)){const z=Wr(E,q);if(z!==0){const K=Gr(M,z);D=Ne(K,"yyyy-MM-dd");const U=sl(t,p.id,m.start_date,D);k.push(...U)}}}}const T=[],A={id:p.id,position:v,parent_task_id:y};D&&(A.start_date=D),T.push(A),T.push(...k),n?T.forEach(S=>{n(S.id,S)}):s(S=>S.map(O=>{const q=T.find(E=>E.id===O.id);return q?{...O,...q}:O}));try{await Xi(T),k.length>0?as({title:"Task Moved & Dates Updated",description:`Moved "${m.title}" and updated dates for ${k.length} subtasks.`,variant:"success"}):y!==m.parent_task_id&&as({title:"Task Moved",description:`Moved "${m.title}" to new parent.`}),await r()}catch(S){console.error("Failed to persist move",S),i&&i(p.id),r(),o("Failed to move task. Reverting changes...")}}catch(p){console.error("Unexpected error in handleDragEnd:",p),r()}},[t,r,s,a,n,i]);return{sensors:d,handleDragEnd:c,moveError:l,setMoveError:o}},al=(t,s)=>{const r=new Map;t.forEach(n=>r.set(n.id,{...n,children:[]}));const a=[];return t.forEach(n=>{n.parent_task_id===s?a.push(r.get(n.id)):r.has(n.parent_task_id)&&r.get(n.parent_task_id).children.push(r.get(n.id))}),r.forEach(n=>{n.children.sort((i,l)=>(i.position??0)-(l.position??0))}),a.sort((n,i)=>(n.position??0)-(i.position??0))},qa=()=>{const{tasks:t,setTasks:s,joinedProjects:r,hydratedProjects:a,loading:n,error:i,joinedError:l,currentUserId:o,fetchTasks:d,createProject:c,createTaskOrUpdate:x,deleteTask:p,updateTask:h,fetchProjectDetails:m,refreshProjectDetails:f,findTask:j,hasMore:N,isFetchingMore:g,loadMoreProjects:v,...y}=Aa(),{addToast:k}=Co(),D=u.useMemo(()=>{const L=Object.values(a).flat();return[...t,...L]},[t,a]),{sensors:T,handleDragEnd:A}=rl({tasks:D,setTasks:s,fetchTasks:d,currentUserId:o,updateTaskStatus:(L,G)=>h(L,{status:G}),handleOptimisticUpdate:y.handleOptimisticUpdate,commitOptimisticUpdate:y.commitOptimisticUpdate}),[S,O]=u.useState(!1),[q,E]=u.useState(null),[M,z]=u.useState(null),[K,U]=u.useState(null),[_,F]=u.useState(!1),[H,Pe]=u.useState(new Set),[X,Z]=u.useState(null),[ee,ve]=u.useState(null),{instanceTasks:te,templateTasks:ae}=u.useMemo(()=>Ia(t),[t]),Vt=u.useMemo(()=>{if(!X)return null;const L=te.find(Oe=>Oe.id===X)||ae.find(Oe=>Oe.id===X)||r.find(Oe=>Oe.id===X);if(!L)return null;const G=a[X];let Le=[];G&&(Le=al(G,X));const Ke=Oe=>Oe.map(Qt=>({...Qt,isExpanded:H.has(Qt.id),children:Ke(Qt.children||[])}));return{...L,children:Ke(Le),isExpanded:H.has(L.id)}},[X,te,ae,r,a,H]),Ct=u.useCallback(async L=>{if(Z(L.id),E(null),O(!1),ve(null),!a[L.id])try{await m(L.id)}catch(G){console.error("[TaskList] Failed to hydrate project:",G),ve("Failed to load project tasks.")}},[a,m]),zt=L=>{E(L),O(!1),z(null)},Kt=u.useCallback(L=>j(L),[j]),Ht=u.useCallback((L,G)=>{Pe(Le=>{const Ke=new Set(Le);return G?Ke.add(L.id):Ke.delete(L.id),Ke})},[]),Wt=L=>{z({mode:"create",origin:L.origin,parentId:L.id}),O(!1),E(null)},Gt=L=>{z({mode:"edit",origin:L.origin,parentId:L.parent_task_id||null,taskId:L.id}),O(!1),E(L)},ot=u.useCallback(async L=>{window.confirm(`Delete "${L.title}" and its subtasks? This action cannot be undone.`)&&(await p(L),L.root_id&&L.root_id!==L.id&&f(L.root_id),q?.id===L.id&&E(null),M?.taskId===L.id&&z(null))},[p,q,M,f]),C=u.useCallback(L=>{const G=j(L);G&&ot(G)},[j,ot]);return{joinedProjects:r,instanceTasks:te,templateTasks:ae,loading:n,error:i,joinedError:l,activeProjectId:X,activeProject:Vt,hydrationError:ee,hasMore:N,isFetchingMore:g,loadMoreProjects:v,showForm:S,setShowForm:O,selectedTask:q,setSelectedTask:E,taskFormState:M,setTaskFormState:z,inviteModalProject:K,setInviteModalProject:U,isSaving:_,handleSelectProject:Ct,handleTaskClick:zt,handleToggleExpand:Ht,handleAddChildTask:Wt,handleEditTask:Gt,onDeleteTaskWrapper:ot,handleDeleteById:C,handleOpenInvite:L=>{U(L)},handleProjectSubmit:async L=>{F(!0);try{const G=await c(L);if(G){const Le=G.new_root_id||G.id;Le&&o&&await ha(Le,o,$.OWNER)}k("Project created successfully!","success"),O(!1)}catch(G){console.error("Failed to create project:",G),k("Failed to create project. Please try again.","error")}finally{F(!1)}},handleTaskSubmit:async L=>{F(!0);try{if(await x(L,M),X)f(X);else if(M?.parentId){const G=j(M.parentId);G&&(G.root_id||G.id)&&f(G.root_id||G.id)}z(null),k("Task saved successfully","success")}catch(G){console.error("Failed to save task:",G),k("Failed to save task. Please try again.","error")}finally{F(!1)}},getTaskById:Kt,fetchTasks:d,updateTask:h,sensors:T,handleDragEnd:A}},nl=()=>{const{projectId:t}=cs(),s=we(),{joinedProjects:r,instanceTasks:a,templateTasks:n,loading:i,error:l,joinedError:o,activeProjectId:d,activeProject:c,hydrationError:x,hasMore:p,isFetchingMore:h,loadMoreProjects:m,showForm:f,setShowForm:j,selectedTask:N,setSelectedTask:g,taskFormState:v,setTaskFormState:y,inviteModalProject:k,setInviteModalProject:D,handleSelectProject:T,handleTaskClick:A,handleToggleExpand:S,handleAddChildTask:O,handleEditTask:q,handleDeleteById:E,handleOpenInvite:M,handleProjectSubmit:z,handleTaskSubmit:K,getTaskById:U,fetchTasks:_,onDeleteTaskWrapper:F,updateTask:H,sensors:Pe,handleDragEnd:X}=qa();u.useEffect(()=>{if(t&&t!==d&&!i){const te=a.find(ae=>ae.id===t)||n.find(ae=>ae.id===t)||r.find(ae=>ae.id===t);te&&T(te)}},[t,d,i,a,n,r,T]);const Z=v?.parentId?U(v.parentId):null,ee=v?.mode==="edit"&&v.taskId?U(v.taskId):null;u.useMemo(()=>f?"New Project":v?v.mode==="edit"?ee?`Edit ${ee.title}`:"Edit Task":v.origin==="template"?Z?`New Template Task in ${Z.title}`:"New Template Task":Z?`New Task in ${Z.title}`:"New Task":N?N.title:"Details",[f,v,ee,Z,N]);const ve=e.jsx(Ft,{joinedProjects:r,instanceTasks:a,templateTasks:n,joinedError:o,error:l,handleSelectProject:te=>{T(te),s(`/project/${te.id}`)},selectedTaskId:d,loading:i&&a.length===0,hasMore:p,isFetchingMore:h,onLoadMore:m,handleOpenInvite:M,handleAddChildTask:O,onNewProjectClick:()=>{j(!0),g(null),y(null),s("/dashboard")},onNewTemplateClick:()=>{y({mode:"create",origin:"template",parentId:null}),j(!1),g(null),s("/dashboard")}});return l?e.jsx(pe,{sidebar:ve,children:e.jsx("div",{className:"mt-8 mx-auto max-w-2xl",children:e.jsx(Ns,{title:"Error loading projects",description:l,variant:"error"})})}):e.jsx(At,{sensors:Pe,collisionDetection:Lt,onDragEnd:X,children:e.jsxs(pe,{sidebar:ve,children:[e.jsxs("div",{className:"flex h-full gap-8",children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:c?e.jsx(Pa,{project:c,handleTaskClick:A,handleAddChildTask:O,handleEditTask:q,handleDeleteById:E,selectedTaskId:N?.id,onToggleExpand:S,disableDrag:r.some(te=>te.id===d),hydrationError:x,onInviteMember:()=>M(c),onStatusChange:(te,ae)=>H(te,{status:ae,is_complete:ae==="completed"})}):e.jsx($a,{onCreateProject:()=>{j(!0),g(null)}})}),(f||N||v)&&e.jsx(Oa,{showForm:f,taskFormState:v,selectedTask:N,taskBeingEdited:ee,parentTaskForForm:Z,onClose:()=>{j(!1),y(null),g(null)},handleProjectSubmit:z,handleTaskSubmit:K,setTaskFormState:y,handleAddChildTask:O,handleEditTask:q,onDeleteTaskWrapper:F,fetchTasks:_})]}),k&&e.jsx(ba,{project:k,onClose:()=>D(null),onInviteSuccess:()=>{D(null)}})]})})},ol=t=>e.jsx(ds,{FallbackComponent:ws,onReset:()=>window.location.reload(),children:e.jsx(nl,{...t})}),il={light:"",dark:".dark"},Fa=u.createContext(null);function Ua(){const t=u.useContext(Fa);if(!t)throw new Error("useChart must be used within a <ChartContainer />");return t}const Ba=u.forwardRef(({id:t,className:s,children:r,config:a,...n},i)=>{const l=u.useId(),o=`chart-${t||l.replace(/:/g,"")}`;return e.jsx(Fa.Provider,{value:{config:a},children:e.jsxs("div",{"data-chart":o,ref:i,className:w("flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='var(--color-border)']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='var(--color-card)']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='var(--color-border)']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='var(--color-border)']]:stroke-border [&_.recharts-sector[stroke='var(--color-card)']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",s),...n,children:[e.jsx(ll,{id:o,config:a}),e.jsx(uo,{children:r})]})})});Ba.displayName="Chart";const ll=({id:t,config:s})=>{const r=u.useMemo(()=>Object.entries(s).filter(([,i])=>i.theme||i.color),[s]),a=t.replace(/[^a-zA-Z0-9-_]/g,""),n=u.useMemo(()=>Object.entries(il).map(([i,l])=>`
${l} [data-chart=${a}] {
${r.map(([o,d])=>{const c=d.theme?.[i]||d.color,x=o.replace(/[^a-zA-Z0-9-_]/g,""),p=c?c.replace(/;/g,""):null;return p?`  --color-${x}: ${p};`:null}).join(`
`)}
}
`).join(`
`),[a,r]);return r.length?e.jsx("style",{dangerouslySetInnerHTML:{__html:n}}):null},dl=mo,Va=u.forwardRef(({active:t,payload:s,className:r,indicator:a="dot",hideLabel:n=!1,hideIndicator:i=!1,label:l,labelFormatter:o,labelClassName:d,formatter:c,color:x,nameKey:p,labelKey:h},m)=>{const{config:f}=Ua(),j=u.useMemo(()=>{if(n||!s?.length)return null;const[g]=s,v=`${h||g.dataKey||g.name||"value"}`,y=is(f,g,v),k=!h&&typeof l=="string"?f[l]?.label||l:y?.label;return o?e.jsx("div",{className:w("font-medium",d),children:o(k,s)}):k?e.jsx("div",{className:w("font-medium",d),children:k}):null},[l,o,s,n,d,f,h]);if(!t||!s?.length)return null;const N=s.length===1&&a!=="dot";return e.jsxs("div",{ref:m,className:w("grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",r),children:[N?null:j,e.jsx("div",{className:"grid gap-1.5",children:s.map((g,v)=>{const y=`${p||g.name||g.dataKey||"value"}`,k=is(f,g,y),D=x||g.payload.fill||g.color;return e.jsx("div",{className:w("flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",a==="dot"&&"items-center"),children:c&&g?.value!==void 0&&g.name?c(g.value,g.name,g,v,g.payload):e.jsxs(e.Fragment,{children:[k?.icon?e.jsx(k.icon,{}):!i&&e.jsx("div",{className:w("shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",{"h-2.5 w-2.5":a==="dot","w-1":a==="line","w-0 border-[1.5px] border-dashed bg-transparent":a==="dashed","my-0.5":N&&a==="dashed"}),style:{"--color-bg":D,"--color-border":D}}),e.jsxs("div",{className:w("flex flex-1 justify-between leading-none",N?"items-end":"items-center"),children:[e.jsxs("div",{className:"grid gap-1.5",children:[N?j:null,e.jsx("span",{className:"text-muted-foreground",children:k?.label||g.name})]}),g.value&&e.jsx("span",{className:"font-mono font-medium tabular-nums text-foreground",children:g.value.toLocaleString()})]})]})},g.dataKey)})})]})});Va.displayName="ChartTooltip";const cl=xo,za=u.forwardRef(({className:t,hideIcon:s=!1,payload:r,verticalAlign:a="bottom",nameKey:n},i)=>{const{config:l}=Ua();return r?.length?e.jsx("div",{ref:i,className:w("flex items-center justify-center gap-4",a==="top"?"pb-3":"pt-3",t),children:r.map(o=>{const d=`${n||o.dataKey||"value"}`,c=is(l,o,d);return e.jsxs("div",{className:w("flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"),children:[c?.icon&&!s?e.jsx(c.icon,{}):e.jsx("div",{className:"h-2 w-2 shrink-0 rounded-[2px]",style:{backgroundColor:o.color}}),c?.label]},o.value)})}):null});za.displayName="ChartLegend";function is(t,s,r){if(typeof s!="object"||s===null)return;const a="payload"in s&&typeof s.payload=="object"&&s.payload!==null?s.payload:void 0;let n=r;return r in s&&typeof s[r]=="string"?n=s[r]:a&&r in a&&typeof a[r]=="string"&&(n=a[r]),n in t?t[n]:t[r]}const Ka=({tasks:t})=>{const s=u.useMemo(()=>[{name:"To Do",count:t.filter(a=>a.status===R.TODO||!a.status).length,fill:Ee[R.TODO]},{name:"In Progress",count:t.filter(a=>a.status===R.IN_PROGRESS).length,fill:Ee[R.IN_PROGRESS]},{name:"Blocked",count:t.filter(a=>a.status===R.BLOCKED).length,fill:Ee[R.BLOCKED]},{name:"Completed",count:t.filter(a=>a.status===R.COMPLETED).length,fill:Ee[R.COMPLETED]}],[t]),r=u.useMemo(()=>({[R.TODO]:{label:"To Do",color:Ee[R.TODO]},[R.IN_PROGRESS]:{label:"In Progress",color:Ee[R.IN_PROGRESS]},[R.BLOCKED]:{label:"Blocked",color:Ee[R.BLOCKED]},[R.COMPLETED]:{label:"Completed",color:Ee[R.COMPLETED]}}),[]);return e.jsx("div",{className:"w-full h-full pb-6",children:e.jsx(Ba,{config:r,className:"h-full w-full",children:e.jsxs(ho,{children:[e.jsx(po,{data:s,cx:"50%",cy:"50%",innerRadius:60,outerRadius:90,paddingAngle:2,dataKey:"count",nameKey:"name",children:s.map((a,n)=>e.jsx(fo,{fill:a.fill},`cell-${n}`))}),e.jsx(dl,{content:e.jsx(Va,{indicator:"dot"})}),e.jsx(cl,{content:e.jsx(za,{})})]})})})};Ka.propTypes={tasks:b.array.isRequired};const ul=()=>{const{projectId:t}=cs(),s=we(),{joinedProjects:r,instanceTasks:a,templateTasks:n,loading:i,error:l,joinedError:o,hasMore:d,isFetchingMore:c,loadMoreProjects:x,handleOpenInvite:p,handleAddChildTask:h}=qa(),[m,f]=u.useState(null);u.useEffect(()=>{(async()=>{if(!t)return;const{data:v,error:y}=await yi(t);v?f(v):y&&console.error("Error fetching project report:",y)})()},[t]);const j=g=>{s(`/project/${g.id}`)},N=e.jsx(Ft,{joinedProjects:r,instanceTasks:a,templateTasks:n,handleSelectProject:j,selectedTaskId:t,loading:i,error:l,joinedError:o,hasMore:d,isFetchingMore:c,onLoadMore:x,handleOpenInvite:p,handleAddChildTask:h,onNewProjectClick:()=>s("/dashboard"),onNewTemplateClick:()=>s("/dashboard")});return e.jsx(pe,{sidebar:N,children:e.jsx("div",{className:"project-view-container w-full h-full flex flex-col",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-card px-8 border-b border-border",children:e.jsx(Ut,{project:m})}),e.jsx("div",{className:"flex-1 px-8 pb-12 max-w-6xl w-full mx-auto overflow-x-visible pt-8",children:e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-card-foreground",children:"Project Performance"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"p-4 bg-muted/40 rounded-lg border border-border/50",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Total Tasks"}),e.jsx("div",{className:"text-2xl font-bold text-card-foreground",children:m.children?.length||0})]}),e.jsxs("div",{className:"p-4 bg-muted/40 rounded-lg border border-border/50",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Completed"}),e.jsx("div",{className:"text-2xl font-bold text-emerald-600 dark:text-emerald-400",children:m.children?.filter(g=>g.is_complete).length||0})]}),e.jsxs("div",{className:"p-4 bg-muted/40 rounded-lg border border-border/50",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Pending"}),e.jsx("div",{className:"text-2xl font-bold text-amber-600 dark:text-amber-400",children:m.children?.filter(g=>!g.is_complete).length||0})]})]}),e.jsxs("div",{className:"h-80 bg-muted/30 rounded-lg p-6 border border-border/50",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground mb-4 uppercase tracking-wider",children:"Status Distribution"}),e.jsx("div",{className:"w-full h-full pb-6",children:e.jsx(Ka,{tasks:m.children||[]})})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-slate-400",children:e.jsx(ie,{className:"animate-spin h-8 w-8 text-brand-500"})})})})};function ml(){const t=Te(),{data:s=[],isLoading:r}=de({queryKey:["tasks"],queryFn:()=>I.entities.Task.list()}),a=u.useCallback(x=>s.find(p=>p.id===x),[s]),[n,i]=u.useState("list"),{updateTask:l}=Ma({tasks:s,fetchTasks:()=>t.invalidateQueries({queryKey:["tasks"]}),refreshProjectDetails:()=>t.invalidateQueries({queryKey:["tasks"]}),findTask:a}),o=s.filter(x=>x.parent_task_id!==null&&x.origin==="instance"),d=Rt(Je(It,{activationConstraint:{distance:5}}),Je(gr,{coordinateGetter:fr})),c=x=>{const{active:p,over:h}=x;if(!h)return;const m=p.id,f=h.data.current;if(f&&f.status){const j=f.status,N=a(m);N&&N.status!==j&&l(m,{status:j})}};return r?e.jsx(pe,{children:e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ie,{className:"w-8 h-8 animate-spin text-orange-500"})})}):e.jsx(pe,{children:e.jsx(At,{sensors:d,collisionDetection:Lt,onDragEnd:c,children:e.jsxs("div",{className:"flex-1 flex flex-col min-w-0 bg-background h-full overflow-hidden",children:[e.jsx("div",{className:"flex-none max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full",children:e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900 dark:text-white tracking-tight",children:"My Tasks"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Review and manage your assignments across all projects"})]}),e.jsxs("div",{className:"bg-muted p-1 rounded-lg flex items-center space-x-1",children:[e.jsx("button",{onClick:()=>i("list"),className:`p-2 rounded-md transition-all ${n==="list"?"bg-card shadow text-card-foreground":"text-muted-foreground hover:text-card-foreground"}`,"aria-label":"List View",children:e.jsx(Pn,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>i("board"),className:`p-2 rounded-md transition-all ${n==="board"?"bg-card shadow text-card-foreground":"text-muted-foreground hover:text-card-foreground"}`,"aria-label":"Board View",children:e.jsx(dr,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx("div",{className:"h-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8 w-full",children:o.length===0?e.jsx("div",{className:"bg-card rounded-xl border border-border shadow-sm p-12 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No tasks found across your projects."})}):n==="list"?e.jsx("div",{className:"space-y-6 overflow-y-auto h-full pb-20",children:e.jsx("div",{className:"flex flex-col gap-2",children:o.map(x=>e.jsx(Ze,{task:x,level:0,onStatusChange:(p,h)=>l(p,{status:h}),hideExpansion:!0,disableDrag:!0,onTaskClick:()=>{},onAddChildTask:()=>{},onInviteMember:()=>{}},x.id))})}):e.jsx("div",{className:"h-full",children:e.jsx(Sa,{project:{id:"my-tasks-root"},childrenTasks:o,handleTaskClick:()=>{}})})})})]})})})}function Qs(){const t=[{icon:Dn,title:"Phase-Based Planning",description:"Break down your church plant into 6 manageable phases with clear milestones and actionable tasks."},{icon:Me,title:"Team Collaboration",description:"Invite team members, delegate tasks, and keep everyone aligned on the mission."},{icon:Ie,title:"Smart Scheduling",description:"Set your launch date and let the system calculate optimal timelines for each task."},{icon:Mn,title:"Progress Tracking",description:"Visual reports and dashboards help you see exactly where you stand at any moment."}],s=[{name:"Launch Large",description:"For traditional church plants aiming for significant launch day attendance",tasks:"200+ tasks"},{name:"Multisite",description:"Perfect for churches expanding with new campus locations",tasks:"150+ tasks"},{name:"Multiplication",description:"Focus on reproducing and multiplying new congregations",tasks:"180+ tasks"}];return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-slate-50 to-white",children:[e.jsxs("section",{className:"relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:[e.jsx("div",{className:"absolute inset-0 opacity-10",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Ccircle cx='40' cy='8' r='2'/%3E%3Ccircle cx='40' cy='40' r='3'/%3E%3Ccircle cx='8' cy='40' r='2'/%3E%3Ccircle cx='72' cy='40' r='2'/%3E%3Ccircle cx='20' cy='20' r='1.5'/%3E%3Ccircle cx='60' cy='20' r='1.5'/%3E%3Ccircle cx='20' cy='60' r='1.5'/%3E%3Ccircle cx='60' cy='60' r='1.5'/%3E%3Cpath d='M40 40L20 20M40 40L60 20M40 40L20 60M40 40L60 60M40 40L8 40M40 40L72 40M40 40L40 8' stroke='%23ffffff' stroke-width='0.5' stroke-opacity='0.3'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`}}),e.jsx("div",{className:"relative max-w-6xl mx-auto px-4 py-24 md:py-32",children:e.jsxs(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 bg-orange-500/20 text-orange-300 px-4 py-2 rounded-full text-sm font-medium mb-8",children:[e.jsx(En,{className:"w-4 h-4"}),e.jsx("span",{children:"Church Planting Made Simple"})]}),e.jsxs("h1",{className:"text-4xl md:text-6xl lg:text-7xl font-bold text-white mb-6 tracking-tight",children:["Manage church planting",e.jsx("span",{className:"block text-orange-400",children:"without going crazy"})]}),e.jsx("p",{className:"text-lg md:text-xl text-slate-300 max-w-2xl mx-auto mb-10 leading-relaxed",children:"Focus on what matters most â€” people. Let PlanterPlan handle the details, timelines, and tasks so you can lead with clarity and purpose."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(he,{to:Ce("Dashboard"),children:e.jsxs(P,{size:"lg",className:"bg-orange-500 hover:bg-orange-600 text-white px-8 py-6 text-lg rounded-xl shadow-lg shadow-orange-500/25 transition-all hover:shadow-xl hover:shadow-orange-500/30",children:["Get Started Free",e.jsx(Dt,{className:"ml-2 w-5 h-5"})]})}),e.jsx(P,{size:"lg",variant:"outline",className:"border-slate-600 text-slate-300 hover:bg-slate-800 px-8 py-6 text-lg rounded-xl",children:"Watch Demo"})]})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0",children:e.jsx("svg",{viewBox:"0 0 1440 120",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M0 120L60 110C120 100 240 80 360 70C480 60 600 60 720 65C840 70 960 80 1080 85C1200 90 1320 90 1380 90L1440 90V120H1380C1320 120 1200 120 1080 120C960 120 840 120 720 120C600 120 480 120 360 120C240 120 120 120 60 120H0Z",fill:"var(--color-slate-50)"})})})]}),e.jsx("section",{className:"py-20 md:py-28 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs(J.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"text-center mb-16",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold text-slate-900 mb-4",children:"Everything you need to plant with confidence"}),e.jsx("p",{className:"text-lg text-slate-600 max-w-2xl mx-auto",children:"Built by planters, for planters. Every feature designed to keep you focused on ministry."})]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6 lg:gap-8",children:t.map((r,a)=>e.jsxs(J.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{delay:a*.1},className:"group p-8 bg-white rounded-2xl border border-slate-200 hover:border-orange-200 hover:shadow-xl hover:shadow-orange-500/5 transition-all duration-300",children:[e.jsx("div",{className:"w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform",children:e.jsx(r.icon,{className:"w-7 h-7 text-white"})}),e.jsx("h3",{className:"text-xl font-semibold text-slate-900 mb-3",children:r.title}),e.jsx("p",{className:"text-slate-600 leading-relaxed",children:r.description})]},r.title))})]})}),e.jsx("section",{className:"py-20 md:py-28 px-4 bg-slate-50",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs(J.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"text-center mb-16",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold text-slate-900 mb-4",children:"Start with proven templates"}),e.jsx("p",{className:"text-lg text-slate-600 max-w-2xl mx-auto",children:"Choose a template that fits your vision. Each one is based on real-world church planting experience."})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-6",children:s.map((r,a)=>e.jsxs(J.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{delay:a*.1},className:"bg-card rounded-2xl p-8 border border-border hover:border-brand-200 transition-all hover:shadow-lg group",children:[e.jsx("div",{className:"w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mb-6 group-hover:bg-orange-500 transition-colors",children:e.jsx(Ue,{className:"w-6 h-6 text-orange-500 group-hover:text-white transition-colors"})}),e.jsx("h3",{className:"text-xl font-semibold text-slate-900 mb-2",children:r.name}),e.jsx("p",{className:"text-slate-600 mb-4 leading-relaxed",children:r.description}),e.jsxs("span",{className:"inline-flex items-center gap-2 text-sm text-orange-600 font-medium",children:[e.jsx(cr,{className:"w-4 h-4"}),r.tasks]})]},r.name))})]})}),e.jsx("section",{className:"py-20 md:py-28 px-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(J.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-10 md:p-16 text-center relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 opacity-10",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fff' fill-opacity='1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E")`}}),e.jsxs("div",{className:"relative",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold text-white mb-4",children:"Ready to plant with clarity?"}),e.jsx("p",{className:"text-lg text-slate-300 mb-8 max-w-xl mx-auto",children:"Join hundreds of church planters who use PlanterPlan to stay organized and focused on people."}),e.jsx(he,{to:Ce("Dashboard"),children:e.jsxs(P,{size:"lg",className:"bg-orange-500 hover:bg-orange-600 text-white px-10 py-6 text-lg rounded-xl",children:["Start Your Project",e.jsx(Dt,{className:"ml-2 w-5 h-5"})]})})]})]})})}),e.jsx("footer",{className:"border-t border-slate-200 py-12 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-4",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center",children:e.jsx(Ue,{className:"w-6 h-6 text-white"})}),e.jsx("span",{className:"text-xl font-bold text-slate-900",children:"PlanterPlan"})]}),e.jsx("p",{className:"text-slate-500",children:"Helping church planters focus on what matters most."})]})})]})}const Se=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("rounded-xl border bg-card text-card-foreground shadow-sm",t),...s}));Se.displayName="Card";const Ha=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("flex flex-col space-y-1.5 p-6",t),...s}));Ha.displayName="CardHeader";const Wa=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("font-semibold leading-none tracking-tight",t),...s}));Wa.displayName="CardTitle";const Ga=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("text-sm text-muted-foreground",t),...s}));Ga.displayName="CardDescription";const Qa=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("p-6 pt-0",t),...s}));Qa.displayName="CardContent";const Ja=u.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:w("flex items-center p-6 pt-0",t),...s}));Ja.displayName="CardFooter";const nt={className:b.string,children:b.node};Se.propTypes=nt;Ha.propTypes=nt;Ja.propTypes=nt;Wa.propTypes=nt;Ga.propTypes=nt;Qa.propTypes=nt;const xl={launch_large:pt,multisite:fs,multiplication:ps},jt=({project:t,tasks:s=[],teamMembers:r=[]})=>{const a=xl[t.template_id]||bs,n=me[t.status]||me[W.PLANNING],i=s.length,l=s.filter(d=>d.status===R.DONE).length,o=i===0?0:Math.round(l/i*100);return e.jsx(J.div,{whileHover:{y:-4},transition:{duration:.2},className:"h-full",children:e.jsx(he,{to:Ce(`project/${t.id}`),className:"h-full block",children:e.jsxs(Se,{className:"p-4 sm:p-6 hover:shadow-xl transition-all duration-300 border border-border hover:border-brand-300 cursor-pointer group bg-card h-full flex flex-col justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0",children:[e.jsx("div",{className:"w-12 h-12 flex-shrink-0 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-md shadow-orange-500/20",children:e.jsx(a,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg text-card-foreground group-hover:text-brand-600 transition-colors truncate",dangerouslySetInnerHTML:{__html:xt(t.name)}}),e.jsx(Ye,{variant:"secondary",className:`${n.bg} ${n.text} ${n.border} border text-[10px] font-bold mt-1 uppercase tracking-wider`,children:t.status?.replace("_"," ")})]})]}),e.jsx(ze,{className:"w-5 h-5 flex-shrink-0 text-muted-foreground group-hover:text-brand-500 group-hover:translate-x-1 transition-all"})]}),t.description&&e.jsx("p",{className:"text-muted-foreground text-sm mb-4 line-clamp-2",dangerouslySetInnerHTML:{__html:xt(t.description)}}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground mb-5",children:[t.location&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(nr,{className:"w-4 h-4"}),e.jsx("span",{dangerouslySetInnerHTML:{__html:xt(t.location)}})]}),t.launch_date&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ie,{className:"w-4 h-4"}),e.jsx("span",{children:Ne(new Date(t.launch_date),"MMM d, yyyy")})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsxs("span",{children:[r.length," member",r.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsxs("span",{className:"font-medium text-card-foreground",children:[o,"%"]})]}),e.jsx(rt,{value:o,className:"h-2 bg-muted"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[l," of ",i," tasks completed"]})]})]})})})};function Bt({className:t,classNames:s,showOutsideDays:r=!0,...a}){return e.jsx(go,{showOutsideDays:r,className:w("p-3",t),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",month_caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",button_previous:w(Et({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 absolute left-1"),button_next:w(Et({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 absolute right-1"),month_grid:"w-full border-collapse space-y-1",weekdays:"flex",weekday:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",week:"flex w-full mt-2",day:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day_button:w(Et({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),range_end:"day-range-end",selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",today:"bg-accent text-accent-foreground",outside:"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",disabled:"text-muted-foreground opacity-50",range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",hidden:"invisible",...s},components:{IconLeft:({className:n,...i})=>e.jsx(Rn,{className:w("h-4 w-4",n),...i}),IconRight:({className:n,...i})=>e.jsx(ze,{className:w("h-4 w-4",n),...i})},...a})}Bt.displayName="Calendar";const hl=bo({title:lt().min(3,"Project name must be at least 3 characters"),description:lt().optional(),template:lt().min(1,"Please select a template"),launch_date:jo({required_error:"Target launch date is required",invalid_type_error:"That is not a valid date"}),location:lt().optional(),status:lt().default(W?.PLANNING)}),pl=[{id:"launch_large",name:"Launch Large",description:"Traditional church plant with significant launch day",icon:pt},{id:"multisite",name:"Multisite",description:"New campus location expansion",icon:fs},{id:"multiplication",name:"Multiplication",description:"Reproducing and multiplying congregations",icon:ps},{id:"blank",name:"Start from scratch",description:"Empty project with no predefined tasks",icon:pt}];function fl({open:t,onClose:s,onCreate:r}){const[a,n]=u.useState(1),[i,l]=u.useState(!1),[o,d]=u.useState({}),[c,x]=u.useState({title:"",description:"",template:"",launch_date:null,location:"",status:W.PLANNING}),p=j=>{x({...c,template:j}),d(N=>({...N,template:null})),n(2)},h=()=>{try{return hl.parse(c),d({}),!0}catch(j){if(j instanceof yo){const N={};j.errors?.forEach(g=>{N[g.path[0]]=g.message}),d(N)}return!1}},m=async j=>{if(j&&j.preventDefault(),!!h()){l(!0);try{await r({...c,templateId:c.template}),n(1),x({title:"",description:"",template:"",launch_date:null,location:"",status:W.PLANNING}),d({}),s()}catch(N){console.error("[CreateProjectModal] Failed to create project:",N),d({root:N.message||"Failed to create project."})}finally{l(!1)}}},f=()=>{n(1),d({}),s()};return e.jsx(ke,{open:t,onOpenChange:f,children:e.jsxs(fe,{className:"sm:max-w-lg bg-card text-card-foreground",children:[e.jsxs(je,{children:[e.jsx(ye,{className:"text-xl",children:a===1?"Choose a Template":"Project Details"}),e.jsx(et,{className:"text-muted-foreground",children:a===1?"Select a template that fits your church planting vision":"Fill in the details for your new project"})]}),o.root&&e.jsx("div",{className:"bg-red-50 text-red-600 p-3 rounded-md text-sm mb-4",children:o.root}),e.jsx(yt,{mode:"wait",children:a===1?e.jsx(J.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},className:"grid gap-3 py-4",children:pl.map(j=>e.jsxs("button",{onClick:()=>p(j.id),className:w("flex items-center gap-4 p-4 rounded-xl border-2 transition-all text-left bg-card group","hover:border-brand-300 hover:bg-brand-50/50 dark:hover:bg-brand-900/20 hover:shadow-md cursor-pointer",c.template===j.id?"border-brand-500 bg-brand-50 dark:bg-brand-900/40 ring-1 ring-brand-500/20":"border-border"),children:[e.jsx("div",{className:w("w-12 h-12 rounded-xl flex items-center justify-center transition-all",c.template===j.id?"bg-gradient-to-br from-brand-500 to-brand-600 shadow-md shadow-brand-500/20 scale-110":"bg-muted group-hover:bg-brand-100 dark:group-hover:bg-brand-900/50 group-hover:scale-105"),children:e.jsx(j.icon,{className:w("w-6 h-6",c.template===j.id?"text-white":"text-muted-foreground group-hover:text-brand-600 dark:group-hover:text-brand-400")})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-card-foreground",children:j.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:j.description})]}),c.template===j.id&&e.jsx(Ue,{className:"w-5 h-5 text-orange-500 ml-auto"})]},j.id))},"step1"):e.jsxs(J.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"grid gap-5 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"title",className:w(o.title&&"text-red-500"),children:"Project Name *"}),e.jsx(Y,{id:"title",placeholder:"e.g., Grace Community Church",value:c.title,onChange:j=>{x({...c,title:j.target.value}),o.title&&d(N=>({...N,title:null}))},className:w("h-11",o.title&&"border-red-500 focus-visible:ring-red-500")}),o.title&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:o.title})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"description",children:"Description"}),e.jsx(Ae,{id:"description",placeholder:"Brief description of your church plant...",value:c.description,onChange:j=>x({...c,description:j.target.value}),className:"resize-none h-20"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:w(o.launch_date&&"text-red-500"),children:"Target Launch Date *"}),e.jsxs($t,{children:[e.jsx(qt,{asChild:!0,children:e.jsxs(P,{variant:"outline",className:w("w-full justify-start text-left font-normal h-11",!c.launch_date&&"text-muted-foreground",o.launch_date&&"border-red-500 text-red-500"),children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),c.launch_date?Ne(c.launch_date,"PPP"):"Pick a date"]})}),e.jsx(wt,{className:"w-auto p-0",align:"start",children:e.jsx(Bt,{mode:"single",selected:c.launch_date,onSelect:j=>{x({...c,launch_date:j}),o.launch_date&&d(N=>({...N,launch_date:null}))},defaultMonth:new Date(new Date().setMonth(new Date().getMonth()+3)),startMonth:new Date,endMonth:new Date(new Date().setFullYear(new Date().getFullYear()+5)),disabled:{before:new Date},captionLayout:"dropdown",initialFocus:!0})})]}),o.launch_date&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:o.launch_date})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"location",children:"Location"}),e.jsx(Y,{id:"location",placeholder:"City, State",value:c.location,onChange:j=>x({...c,location:j.target.value}),className:"h-11"})]})]}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx(P,{variant:"outline",onClick:()=>n(1),children:"Back"}),e.jsx(P,{onClick:m,disabled:i,className:"bg-orange-500 hover:bg-orange-600",children:i?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):"Create Project"})]})]},"step2")})]})})}const gl=[{id:"checklist",name:"Task Checklist",description:"A reusable set of tasks for recurring activities",icon:ms},{id:"workflow",name:"Workflow Template",description:"Multi-phase process with dependencies and milestones",icon:In},{id:"blueprint",name:"Project Blueprint",description:"Full project structure to clone into new instances",icon:An}];function bl({open:t,onClose:s,onCreate:r}){const[a,n]=u.useState(!1),[i,l]=u.useState({}),[o,d]=u.useState({title:"",description:"",template:""}),c=async p=>{p&&p.preventDefault();const h={};if(o.title.trim()||(h.title="Template name is required"),Object.keys(h).length>0){l(h);return}n(!0);try{await r({title:o.title.trim(),description:o.description.trim(),template:o.template||"checklist",origin:"template"}),d({title:"",description:"",template:""}),l({}),s()}catch(m){console.error("[CreateTemplateModal] Failed to create template:",m),l({root:m.message||"Failed to create template."})}finally{n(!1)}},x=()=>{l({}),d({title:"",description:"",template:""}),s()};return e.jsx(ke,{open:t,onOpenChange:x,children:e.jsxs(fe,{className:"sm:max-w-lg bg-card text-card-foreground",children:[e.jsxs(je,{children:[e.jsx(ye,{className:"text-xl",children:"Create New Template"}),e.jsx(et,{className:"text-muted-foreground",children:"Build a reusable template for future projects and tasks"})]}),i.root&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-3 rounded-md text-sm mb-4",children:i.root}),e.jsxs(J.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"grid gap-5 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Category"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:gl.map(p=>e.jsxs("button",{type:"button",onClick:()=>{d({...o,template:p.id})},className:w("flex flex-col items-center gap-2 p-3 rounded-lg border-2 transition-all text-center group cursor-pointer","hover:border-brand-300 hover:bg-brand-50/50 dark:hover:bg-brand-900/20",o.template===p.id?"border-brand-500 bg-brand-50 dark:bg-brand-900/40 ring-1 ring-brand-500/20":"border-border bg-card"),children:[e.jsx("div",{className:w("w-10 h-10 rounded-lg flex items-center justify-center transition-all",o.template===p.id?"bg-gradient-to-br from-brand-500 to-brand-600 shadow-md shadow-brand-500/20":"bg-muted group-hover:bg-brand-100 dark:group-hover:bg-brand-900/50"),children:e.jsx(p.icon,{className:w("w-5 h-5",o.template===p.id?"text-white":"text-muted-foreground group-hover:text-brand-600 dark:group-hover:text-brand-400")})}),e.jsx("span",{className:"text-xs font-medium text-card-foreground leading-tight",children:p.name})]},p.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"template-title",className:w(i.title&&"text-red-500"),children:"Template Name *"}),e.jsx(Y,{id:"template-title",placeholder:"e.g., Sunday Service Prep, Outreach Campaign",value:o.title,onChange:p=>{d({...o,title:p.target.value}),i.title&&l(h=>({...h,title:null}))},className:w("h-11",i.title&&"border-red-500 focus-visible:ring-red-500"),autoFocus:!0}),i.title&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:i.title})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"template-description",children:"Description"}),e.jsx(Ae,{id:"template-description",placeholder:"What is this template used for?",value:o.description,onChange:p=>d({...o,description:p.target.value}),className:"resize-none h-20"})]}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsx(P,{onClick:c,disabled:a,className:"bg-orange-500 hover:bg-orange-600",children:a?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):"Create Template"})})]})]})})}function Ya({projects:t,tasks:s,teamMembers:r}){const{totalProjects:a,completedTasks:n,totalTasks:i,pendingTasks:l}=u.useMemo(()=>({totalProjects:t.length,totalTasks:s.length,completedTasks:s.reduce((d,c)=>c.status===R.COMPLETED?d+1:d,0),pendingTasks:s.reduce((d,c)=>c.status===R.TODO||c.status===R.IN_PROGRESS?d+1:d,0)}),[t.length,s]),o=[{label:"Total Projects",value:a,icon:bs,bgColor:"bg-brand-50 dark:bg-brand-900/20",textColor:"text-brand-600 dark:text-brand-400",borderColor:"group-hover:border-brand-300 dark:group-hover:border-brand-700",href:"/reports"},{label:"Completed Tasks",value:n,icon:Ue,bgColor:"bg-emerald-50 dark:bg-emerald-900/20",textColor:"text-emerald-600 dark:text-emerald-400",borderColor:"group-hover:border-emerald-300 dark:group-hover:border-emerald-700",suffix:`/ ${i}`,href:"/tasks"},{label:"Pending Tasks",value:l,icon:cr,bgColor:"bg-amber-50 dark:bg-amber-900/20",textColor:"text-amber-600 dark:text-amber-400",borderColor:"group-hover:border-amber-300 dark:group-hover:border-amber-700",href:"/tasks"},{label:"Team Members",value:r.length,icon:Me,bgColor:"bg-slate-100 dark:bg-slate-800",textColor:"text-slate-700 dark:text-slate-200",borderColor:"group-hover:border-slate-300 dark:group-hover:border-slate-600",href:"/team"}];return e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:o.map((d,c)=>e.jsx(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:c*.1},className:"h-full",children:e.jsx(he,{to:d.href,className:"block h-full group",children:e.jsx(Se,{className:w("p-5 border border-border bg-card text-card-foreground shadow-sm transition-all duration-300 hover:shadow-md h-full relative overflow-hidden",d.borderColor),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:w("w-12 h-12 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110",d.bgColor),children:e.jsx(d.icon,{className:w("w-6 h-6",d.textColor)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground font-medium",children:d.label}),e.jsxs("p",{className:"text-2xl font-bold text-card-foreground mt-0.5",children:[d.value,d.suffix&&e.jsx("span",{className:"text-sm font-normal text-muted-foreground ml-1",children:d.suffix})]})]})]})})})},d.label))})}Ya.propTypes={projects:b.array.isRequired,tasks:b.array.isRequired,teamMembers:b.array.isRequired};const jl=(t=null)=>{const s=Te();u.useEffect(()=>{const r=t?`db-changes:project-${t}`:"db-changes:global",a=Q.channel(r).on("postgres_changes",{event:"*",schema:"public",table:"tasks",filter:t?`root_id=eq.${t}`:void 0},n=>{console.log("[Realtime] Task Change detected:",n),s.invalidateQueries({queryKey:["tasks"]}),s.invalidateQueries({queryKey:["projects"]}),t&&s.invalidateQueries({queryKey:["project",t]})}).subscribe();return()=>{Q.removeChannel(a)}},[s,t])},yl=[{id:W.PLANNING,title:"Planning",...me[W.PLANNING]},{id:W.IN_PROGRESS,title:"In Progress",...me[W.IN_PROGRESS]},{id:W.LAUNCHED,title:"Launched",...me[W.LAUNCHED]},{id:W.PAUSED,title:"Paused",...me[W.PAUSED]}];function Za({projects:t,tasks:s,teamMembers:r,onStatusChange:a}){jl();const[n,i]=u.useState(null),l=u.useMemo(()=>{const x=t.reduce((p,h)=>{const m=h.status||W.PLANNING;return p[m]||(p[m]=[]),p[m].push(h),p},{});return yl.map(p=>({...p,projects:x[p.id]||[]}))},[t]),o=Rt(Je(It,{activationConstraint:{distance:8}})),d=x=>{const{active:p}=x,h=t.find(m=>m.id===p.id);i(h)},c=x=>{const{active:p,over:h}=x;if(i(null),!h)return;const m=p.id;let f=null;if(Object.values(W).includes(h.id))f=h.id;else{const j=t.find(N=>N.id===h.id);j&&(f=j.status||W.PLANNING)}if(f){const j=t.find(N=>N.id===m);j&&(j.status||W.PLANNING)!==f&&a(m,f)}};return e.jsx("div",{className:"h-full overflow-x-auto pb-4 no-scrollbar",children:e.jsxs(At,{sensors:o,collisionDetection:Lt,onDragStart:d,onDragEnd:c,accessibility:{screenReaderInstructions:{draggable:"To pick up a project, press space or enter. Use arrow keys to move between columns."}},children:[e.jsx("section",{className:"flex gap-4 h-full w-full overflow-x-hidden pb-4 no-scrollbar",children:l.map(x=>e.jsx(Xa,{column:x,tasks:s,teamMembers:r},x.id))}),er.createPortal(e.jsx(br,{"aria-hidden":"true",children:n&&e.jsx("div",{className:"w-[350px] rotate-2 cursor-grabbing",children:e.jsx(jt,{project:n,tasks:s.filter(x=>x.project_id===n.id),teamMembers:r.filter(x=>x.project_id===n.id),isOverlay:!0})})}),document.body)]})})}Za.propTypes={projects:b.array.isRequired,tasks:b.array.isRequired,teamMembers:b.array.isRequired,onStatusChange:b.func.isRequired};function Xa({column:t,tasks:s,teamMembers:r}){const{setNodeRef:a}=Xe({id:t.id,data:{type:"Column",status:t.id}});return e.jsxs("div",{ref:a,className:`flex-1 w-0 min-w-0 flex flex-col h-full rounded-xl bg-gradient-to-br ${t.gradient} border border-brand-100/50 dark:border-slate-800`,children:[e.jsx("div",{className:`p-4 border-b border-transparent rounded-t-xl ${t.headerBg}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:`font-bold text-sm uppercase tracking-wider ${t.headerContent}`,children:t.title}),e.jsx("span",{className:"text-xs font-bold px-2 py-0.5 rounded-full bg-white/20 text-white",children:t.projects.length})]})}),e.jsxs("div",{className:"p-3 flex-1 overflow-y-auto space-y-3 no-scrollbar",children:[t.projects.map(n=>e.jsx(en,{project:n,tasks:s,teamMembers:r},n.id)),t.projects.length===0&&e.jsx("div",{className:"h-24 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-lg flex items-center justify-center text-slate-400 dark:text-slate-600 text-sm",children:"Drop Project Here"})]})]})}Xa.propTypes={column:b.object.isRequired,tasks:b.array.isRequired,teamMembers:b.array.isRequired};function en({project:t,tasks:s,teamMembers:r}){const{attributes:a,listeners:n,setNodeRef:i,transform:l,isDragging:o}=xr({id:t.id,data:{type:"Project",project:t}}),d=l?{transform:`translate3d(${l.x}px, ${l.y}px, 0)`}:void 0;return o?e.jsx("div",{ref:i,style:d,className:"opacity-30 grayscale",children:e.jsx(jt,{project:t,tasks:s.filter(c=>c.project_id===t.id),teamMembers:r.filter(c=>c.project_id===t.id)})}):e.jsx("div",{ref:i,style:d,...n,...a,className:"cursor-grab active:cursor-grabbing touch-none focus:outline-none focus:ring-2 focus:ring-brand-500 rounded-xl","aria-label":`Move project ${t.name}`,children:e.jsx(jt,{project:t,tasks:s.filter(c=>c.project_id===t.id),teamMembers:r.filter(c=>c.project_id===t.id)})})}en.propTypes={project:b.object.isRequired,tasks:b.array.isRequired,teamMembers:b.array.isRequired};const tn=u.forwardRef(({className:t,...s},r)=>e.jsx(Kr,{className:w("grid gap-2",t),...s,ref:r}));tn.displayName=Kr.displayName;const ls=u.forwardRef(({className:t,...s},r)=>e.jsx(Hr,{ref:r,className:w("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(ro,{className:"flex items-center justify-center",children:e.jsx(gs,{className:"h-3.5 w-3.5 fill-primary"})})}));ls.displayName=Hr.displayName;function vl({open:t,onCreateProject:s,onDismiss:r}){const[a,n]=u.useState(1),[i,l]=u.useState(!1),[o,d]=u.useState({name:"",launchDate:null,template:"launch_large"}),c=()=>{n(a+1)},x=async p=>{p&&p.preventDefault(),l(!0);try{await s({title:o.name,launch_date:o.launchDate,template:o.template,status:"planning"})}catch(h){console.error(h)}finally{l(!1)}};return e.jsx(ke,{open:t,onOpenChange:p=>!p&&r&&r(),children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsxs("button",{onClick:r,className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(vt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]}),e.jsxs(je,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs(ye,{className:"text-xl",children:[a===1&&"Welcome to PlanterPlan",a===2&&"When is the big day?",a===3&&"Choose your path"]}),e.jsxs("span",{className:"text-sm text-slate-400 font-medium",children:["Step ",a," of 3"]})]}),e.jsxs(et,{children:[a===1&&"Let's get your first church planting project set up in seconds.",a===2&&"We'll build your timeline backwards from your launch date.",a===3&&"Select a template based on your church model."]})]}),e.jsxs("div",{className:"py-6 min-h-[200px]",children:[a===1&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"What is the name of your new church?"}),e.jsx(Y,{placeholder:"e.g., Grace Community Church",value:o.name,onChange:p=>d({...o,name:p.target.value}),autoFocus:!0,className:"h-11"})]})}),a===2&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Projected Launch Date"}),e.jsxs($t,{children:[e.jsx(qt,{asChild:!0,children:e.jsxs(P,{type:"button",variant:"outline",className:w("w-full justify-start text-left font-normal h-11",!o.launchDate&&"text-muted-foreground"),children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),o.launchDate?Ne(o.launchDate,"PPP"):"Pick a date"]})}),e.jsx(wt,{className:"w-auto p-0",align:"start",children:e.jsx(Bt,{mode:"single",selected:o.launchDate,onSelect:p=>d({...o,launchDate:p}),initialFocus:!0})})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Don't worry, you can change this later."})]})}),a===3&&e.jsx("div",{className:"space-y-4",children:e.jsxs(tn,{value:o.template,onValueChange:p=>d({...o,template:p}),children:[e.jsxs("div",{className:w("flex items-start space-x-3 p-4 rounded-lg border cursor-pointer transition-all",o.template==="launch_large"?"border-brand-500 bg-brand-50 dark:bg-brand-900/40 ring-1 ring-brand-500/20":"border-border hover:border-brand-300 hover:bg-slate-50 dark:hover:bg-slate-900/50"),children:[e.jsx(ls,{value:"launch_large",id:"t1",className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(V,{htmlFor:"t1",className:"font-semibold cursor-pointer text-slate-900 dark:text-slate-100",children:"Launch Large"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mt-1",children:"Standard ARC/CMN model. 6 phases, ~200 tasks focusing on a strong day-one launch."})]})]}),e.jsxs("div",{className:w("flex items-start space-x-3 p-4 rounded-lg border cursor-pointer transition-all",o.template==="multiplication"?"border-brand-500 bg-brand-50 dark:bg-brand-900/40 ring-1 ring-brand-500/20":"border-border hover:border-brand-300 hover:bg-slate-50 dark:hover:bg-slate-900/50"),children:[e.jsx(ls,{value:"multiplication",id:"t2",className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(V,{htmlFor:"t2",className:"font-semibold cursor-pointer text-slate-900 dark:text-slate-100",children:"Simple / House Church"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mt-1",children:"Simplified flow for smaller, gathering-based plants."})]})]})]})})]}),e.jsxs(Ot,{className:"flex justify-between sm:justify-between items-center w-full",children:[a>1?e.jsx(P,{type:"button",variant:"ghost",onClick:()=>n(a-1),children:"Back"}):e.jsx(P,{type:"button",variant:"ghost",onClick:r,className:"text-muted-foreground hover:text-foreground",children:"Skip"}),a<3?e.jsxs(P,{type:"button",onClick:c,disabled:!o.name&&a===1,children:["Next ",e.jsx(Dt,{className:"w-4 h-4 ml-2"})]}):e.jsxs(P,{type:"button",onClick:x,disabled:i,className:"bg-orange-500 hover:bg-orange-600 text-white",children:[i&&e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),"Create Project"]})]})]})})}function Nl({project:t,teamMembers:s,onDismiss:r}){const[a,n]=u.useState(!0);if(!t)return null;const i=[{label:"Create your Project",completed:!0},{label:"Set a Launch Date",completed:!!t.launch_date,action:"Settings",link:`/project/${t.id}/settings`},{label:"Invite a Team Member",completed:s&&s.length>0,action:"Invite",link:`/project/${t.id}/team`},{label:"Explore Phases",completed:!1,action:"View",link:`/project/${t.id}`}],o=i.filter(c=>c.completed).length/i.length*100,d=()=>{n(!1),r&&setTimeout(r,300)};return e.jsx(yt,{children:a&&e.jsx(J.div,{initial:{opacity:1,height:"auto",marginBottom:32},exit:{opacity:0,height:0,marginBottom:0},transition:{duration:.3},children:e.jsxs(Se,{className:"p-6 border-brand-100 dark:border-brand-900/50 bg-gradient-to-br from-orange-200/40 via-orange-50/20 to-transparent dark:from-orange-900/20 dark:to-transparent relative group",children:[e.jsx("button",{onClick:d,className:"absolute top-4 right-4 p-1 text-muted-foreground/50 hover:text-muted-foreground hover:bg-black/5 dark:hover:bg-white/10 rounded-full transition-colors opacity-0 group-hover:opacity-100","aria-label":"Dismiss getting started",children:e.jsx(vt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-card-foreground",children:"Getting Started"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete these steps to set up your project for success."})]}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-sm font-bold text-brand-600 dark:text-brand-400",children:[Math.round(o),"%"]})})]}),e.jsx(rt,{value:o,className:"h-2 bg-brand-100 dark:bg-brand-950/40 mb-6",indicatorClassName:"bg-brand-500"}),e.jsx("div",{className:"grid sm:grid-cols-2 md:grid-cols-4 gap-4",children:i.map((c,x)=>e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg border ${c.completed?"bg-card border-border shadow-sm":"bg-muted/40 border-border/60"}`,children:[c.completed?e.jsx(Ue,{className:"w-5 h-5 text-emerald-500 flex-shrink-0"}):e.jsx(gs,{className:"w-5 h-5 text-muted-foreground/50 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:`text-sm font-medium ${c.completed?"text-muted-foreground":"text-card-foreground"}`,children:c.label}),!c.completed&&c.link&&e.jsxs(he,{to:c.link,className:"text-xs text-brand-600 dark:text-brand-400 hover:underline flex items-center mt-1",children:[c.action," ",e.jsx(Dt,{className:"w-3 h-3 ml-1"})]})]})]},x))})]})})})}function wl({tasks:t=[]}){const s=we(),r=new Date;r.setHours(23,59,59,999);const a=t.filter(n=>n.status===R.COMPLETED||!n.due_date?!1:new Date(n.due_date)<=r).slice(0,3);return a.length===0?null:e.jsx("div",{className:"md:hidden mb-6",children:e.jsx(Se,{className:"bg-gradient-to-br from-brand-600 to-brand-700 text-white border-none shadow-lg",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"w-5 h-5 opacity-80"}),e.jsx("h3",{className:"font-semibold",children:"Focused Today"})]}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-1 rounded-full",children:[a.length," Due"]})]}),e.jsx("div",{className:"space-y-3",children:a.map(n=>e.jsxs("div",{className:"bg-white/10 rounded-lg p-3 flex items-center justify-between cursor-pointer active:bg-white/20 transition-colors",onClick:()=>s(`/projects/${n.root_id}`),children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm line-clamp-1",children:n.title}),e.jsx("p",{className:"text-xs text-brand-100",children:n.due_date?Ne(new Date(n.due_date),"MMM d"):"Today"})]}),e.jsx(ze,{className:"w-4 h-4 opacity-50"})]},n.id))}),e.jsx(P,{className:"w-full mt-4 bg-white text-brand-700 hover:bg-brand-50",size:"sm",onClick:()=>s("/tasks"),children:"View All Tasks"})]})})})}const kl={hidden:{opacity:0,y:20},show:{opacity:1,y:0}};function _l(){const[t,s]=u.useState(!1),[r,a]=u.useState(!1),[n,i]=u.useState("grid"),[l,o]=u.useState(()=>localStorage.getItem("gettingStartedDismissed")==="true"),d=Te(),c=we(),{user:x,loading:p}=ce(),{toast:h}=Nt(),[m,f]=u.useState(null),[j,N]=u.useState(""),[g,v]=on();u.useEffect(()=>{const _=g.get("action");_==="new-project"?(s(!0),g.delete("action"),v(g,{replace:!0})):_==="new-template"&&(a(!0),g.delete("action"),v(g,{replace:!0}))},[g,v]);const{data:y=[],isLoading:k,isError:D,error:T}=de({queryKey:["projects"],queryFn:()=>I.entities.Project.list("-created_date"),enabled:!!x}),{data:A=[]}=de({queryKey:["allTasks"],queryFn:()=>I.entities.Task.listByCreator(x?.id),enabled:!!x});u.useMemo(()=>Array.isArray(y)?y.filter(_=>_.status==="active"):[],[y]);const S=u.useMemo(()=>{if(!Array.isArray(A))return[];let _=m?A.filter(F=>F.project_id===m):A;if(j){const F=j.toLowerCase();_=_.filter(H=>H.title.toLowerCase().includes(F)||H.description?.toLowerCase().includes(F))}return _},[A,m,j]),{data:O=[]}=de({queryKey:["teamMembers"],queryFn:()=>I.entities.TeamMember.list(),enabled:!!x}),q=oe({mutationFn:ga,onSuccess:()=>{d.invalidateQueries({queryKey:["projects"]}),d.invalidateQueries({queryKey:["tasks"]}),d.invalidateQueries({queryKey:["userProjects"]})},onError:_=>{h({title:"Failed to create project",description:_.message,variant:"destructive"})}}),E=oe({mutationFn:({projectId:_,status:F})=>vi(_,F),onSuccess:()=>{d.invalidateQueries({queryKey:["projects"]}),d.invalidateQueries({queryKey:["userProjects"]})},onError:_=>{h({title:"Failed to move project",description:_.message,variant:"destructive"})}}),M=oe({mutationFn:_=>I.entities.Task.create({..._,creator:x?.id,origin:"template",parent_task_id:null}),onSuccess:()=>{h({title:"Template created",description:"Your new template is ready."}),d.invalidateQueries({queryKey:["userProjects"]})},onError:_=>{h({title:"Failed to create template",description:_.message,variant:"destructive"})}}),z=async _=>{try{const F=await q.mutateAsync({..._,creator:x?.id});F?.id&&c(`/project/${F.id}`)}catch{}},K=async _=>{try{await M.mutateAsync({..._,creator:x?.id})}catch{}},U=async(_,F)=>{try{await E.mutateAsync({projectId:_,status:F})}catch{d.invalidateQueries({queryKey:["projects"]})}};return k||p?(console.log("[Dashboard] Rendering Loader"),e.jsx(pe,{children:e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ie,{className:"w-8 h-8 animate-spin text-orange-500"})})})):(console.log("[Dashboard] Rendering Content"),D?e.jsx(pe,{children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[e.jsx("p",{className:"text-destructive font-medium",children:"Failed to load projects"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:T?.message}),e.jsx(P,{variant:"outline",onClick:()=>d.invalidateQueries({queryKey:["projects"]}),children:"Retry"})]})}):e.jsx(pe,{children:e.jsxs("div",{className:"w-full px-4 py-8 h-[calc(100vh-64px)] flex flex-col",children:[e.jsxs(J.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-card-foreground",children:"Dashboard"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage your church planting projects"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"bg-card border border-border rounded-lg p-1 flex items-center",children:[e.jsx("button",{onClick:()=>i("grid"),className:`p-1.5 rounded-md transition-colors ${n==="grid"?"bg-muted text-card-foreground":"text-muted-foreground hover:text-card-foreground"}`,title:"Grid View",children:e.jsx(dr,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>i("pipeline"),className:`p-1.5 rounded-md transition-colors ${n==="pipeline"?"bg-muted text-card-foreground":"text-muted-foreground hover:text-card-foreground"}`,title:"Pipeline View",children:e.jsx(Ln,{className:"w-4 h-4"})})]}),e.jsxs(P,{onClick:()=>s(!0),className:"bg-orange-500 hover:bg-orange-600 shadow-lg shadow-orange-500/20 dark:shadow-orange-500/10",children:[e.jsx(Re,{className:"w-5 h-5 mr-2"}),"New Project"]})]})]}),n==="grid"&&e.jsxs("div",{className:"mb-8 flex-shrink-0",children:[y.length>0&&e.jsx(Nl,{project:y[0],teamMembers:O.filter(_=>_.project_id===y[0].id),onDismiss:()=>{o(!0),localStorage.setItem("gettingStartedDismissed","true")}}),e.jsx(wl,{tasks:S}),e.jsx(Ya,{projects:y,tasks:S,teamMembers:O})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto no-scrollbar",children:y.length===0?e.jsxs(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-card rounded-2xl border border-border shadow-sm p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-2xl flex items-center justify-center mx-auto mb-6",children:e.jsx(bs,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-xl font-semibold text-card-foreground mb-2",children:"No projects yet"}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-sm mx-auto",children:"Start your church planting journey by creating your first project"}),e.jsxs(P,{onClick:()=>s(!0),className:"bg-orange-500 hover:bg-orange-600",children:[e.jsx(Re,{className:"w-5 h-5 mr-2"}),"Create Your First Project"]})]}):n==="pipeline"?e.jsx(Za,{projects:y,tasks:S,teamMembers:O,onStatusChange:U}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold text-card-foreground mb-4",children:"Primary Projects"}),e.jsx(J.div,{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6",initial:{opacity:0},animate:{opacity:1},children:y.filter(_=>_.project_type==="primary"||!_.project_type).map((_,F)=>e.jsx(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:F*.1},variants:kl,children:e.jsx(jt,{project:_,tasks:S.filter(H=>H.project_id===_.id),teamMembers:O.filter(H=>H.project_id===_.id)})},_.id))})]}),y.filter(_=>_.project_type==="secondary").length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-card-foreground mb-4",children:"Secondary Projects"}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:y.filter(_=>_.project_type==="secondary").map((_,F)=>e.jsx(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:F*.1},children:e.jsx(jt,{project:_,tasks:S.filter(H=>H.project_id===_.id),teamMembers:O.filter(H=>H.project_id===_.id)})},_.id))})]})]})}),e.jsx(fl,{open:t,onClose:()=>s(!1),onCreate:z}),e.jsx(bl,{open:r,onClose:()=>a(!1),onCreate:K}),e.jsx(vl,{open:!k&&y.length===0&&!l,onCreateProject:z,onDismiss:()=>o(!0)})]})}))}const We={BOARD:"board",PEOPLE:"people"},Js={[We.BOARD]:"Tasks & Board",[We.PEOPLE]:"People"},Cl=u.memo(function({activeTab:s,onTabChange:r}){const a=[{id:We.BOARD,label:Js[We.BOARD]},{id:We.PEOPLE,label:Js[We.PEOPLE]}];return e.jsx("nav",{"aria-label":"Project Sections",className:"flex items-center space-x-1 border-b border-slate-200 mb-6 overflow-x-auto",children:a.map(n=>{const i=s===n.id;return e.jsx("button",{role:"tab","aria-selected":i,"aria-controls":`${n.id}-panel`,id:`${n.id}-tab`,onClick:()=>r(n.id),className:`px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${i?"border-brand-600 text-brand-600":"border-transparent text-slate-500 hover:text-slate-700"}`,children:n.label},n.id)})})});function Tl(t){const{data:s,isLoading:r}=de({queryKey:["project",t],queryFn:()=>I.entities.Project.filter({id:t}).then(d=>d[0]),enabled:!!t}),{data:a=[]}=de({queryKey:["projectHierarchy",t],queryFn:()=>I.entities.Task.filter({root_id:t}),enabled:!!t}),{phases:n,milestones:i,tasks:l}=u.useMemo(()=>{const d=a.filter(p=>p.parent_task_id===t),c=a.filter(p=>d.some(h=>h.id===p.parent_task_id)),x=a.filter(p=>!d.some(h=>h.id===p.id)&&!c.some(h=>h.id===p.id)&&p.parent_task_id!==t);return{phases:d,milestones:c,tasks:x}},[a,t]),{data:o=[]}=de({queryKey:["teamMembers",t],queryFn:()=>I.entities.TeamMember.filter({project_id:t}),enabled:!!t});return{project:s,loadingProject:r,projectHierarchy:a,phases:n,milestones:i,tasks:l,teamMembers:o}}const Tt={async getPeople(t){if(!t)throw new Error("projectId is required");const{data:s,error:r}=await Q.from("people").select("*").eq("project_id",t).order("created_at",{ascending:!1});if(r)throw r;return s},async addPerson(t){if(!t||!t.project_id)throw new Error("person with project_id is required");const{data:s,error:r}=await Q.from("people").insert([t]).select().single();if(r)throw r;return s},async updatePerson(t,s){if(!t)throw new Error("id is required");const{data:r,error:a}=await Q.from("people").update(s).eq("id",t).select().single();if(a)throw a;return r},async deletePerson(t){if(!t)throw new Error("id is required");const{error:s}=await Q.from("people").delete().eq("id",t);if(s)throw s;return!0}};function Sl({open:t,onClose:s,onSave:r,initialData:a=null}){const[n,i]=u.useState(!1),[l,o]=u.useState(a||{first_name:"",last_name:"",email:"",phone:"",role:"Volunteer",status:"New",notes:""}),d=["Volunteer","Core Team","Donor","Staff","Planter"],c=["New","Contacted","Meeting Scheduled","Joined","Not Interested"],x=async p=>{p.preventDefault(),i(!0);try{await r(l),s()}catch(h){console.error(h)}finally{i(!1)}};return e.jsx(ke,{open:t,onOpenChange:s,children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsx(je,{children:e.jsx(ye,{children:a?"Edit Person":"Add Person"})}),e.jsxs("form",{onSubmit:x,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{children:["First Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(Y,{value:l.first_name,onChange:p=>o({...l,first_name:p.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Last Name"}),e.jsx(Y,{value:l.last_name,onChange:p=>o({...l,last_name:p.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Email"}),e.jsx(Y,{type:"email",value:l.email,onChange:p=>o({...l,email:p.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Phone"}),e.jsx(Y,{type:"tel",value:l.phone,onChange:p=>o({...l,phone:p.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Role"}),e.jsxs(ft,{value:l.role,onValueChange:p=>o({...l,role:p}),children:[e.jsx(Be,{children:e.jsx(gt,{})}),e.jsx(Ve,{children:d.map(p=>e.jsx(xe,{value:p,children:p},p))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Status"}),e.jsxs(ft,{value:l.status,onValueChange:p=>o({...l,status:p}),children:[e.jsx(Be,{children:e.jsx(gt,{})}),e.jsx(Ve,{children:c.map(p=>e.jsx(xe,{value:p,children:p},p))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Notes"}),e.jsx(Ae,{value:l.notes||"",onChange:p=>o({...l,notes:p.target.value}),placeholder:"Key details about this person..."})]}),e.jsxs(Ot,{children:[e.jsx(P,{type:"button",variant:"ghost",onClick:s,children:"Cancel"}),e.jsxs(P,{type:"submit",disabled:n,className:"bg-brand-600 hover:bg-brand-700 text-white",children:[n&&e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),a?"Save Changes":"Add Person"]})]})]})]})})}const Ys={New:"bg-brand-100 text-brand-700",Contacted:"bg-indigo-100 text-indigo-700","Meeting Scheduled":"bg-purple-100 text-purple-700",Joined:"bg-emerald-100 text-emerald-700","Not Interested":"bg-slate-100 text-slate-500",default:"bg-slate-100 text-slate-700"};function sn({projectId:t,canEdit:s=!1}){const[r,a]=u.useState([]),[n,i]=u.useState(!0),[l,o]=u.useState(""),[d,c]=u.useState(!1),[x,p]=u.useState(null),{toast:h}=Nt(),m=u.useCallback(async()=>{try{const g=await Tt.getPeople(t);a(g)}catch(g){console.error(g),h({title:"Failed to load people",variant:"destructive"})}finally{i(!1)}},[t,h]);u.useEffect(()=>{m()},[m]);const f=async g=>{try{x?(await Tt.updatePerson(x.id,g),h({title:"Person updated"})):(await Tt.addPerson({...g,project_id:t}),h({title:"Person added"})),m(),p(null)}catch(v){throw h({title:"Error saving person",description:v.message,variant:"destructive"}),v}},j=async g=>{if(confirm("Are you sure you want to delete this person?"))try{await Tt.deletePerson(g),h({title:"Person deleted"}),m()}catch{h({title:"Error deleting",variant:"destructive"})}},N=u.useMemo(()=>r.filter(g=>(g.first_name+" "+g.last_name).toLowerCase().includes(l.toLowerCase())||g.email?.toLowerCase().includes(l.toLowerCase())),[r,l]);return n?e.jsx("div",{className:"flex justify-center p-8",children:e.jsx(ie,{className:"w-8 h-8 animate-spin text-brand-500"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"relative w-72",children:[e.jsx(hs,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx(Y,{placeholder:"Search people...",className:"pl-9",value:l,onChange:g=>o(g.target.value),"aria-label":"Search people"})]}),s&&e.jsxs(P,{onClick:()=>{p(null),c(!0)},children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Add Person"]})]}),e.jsx(Se,{className:"overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-500 font-medium border-b border-slate-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"Name"}),e.jsx("th",{className:"px-4 py-3",children:"Role"}),e.jsx("th",{className:"px-4 py-3",children:"Status"}),e.jsx("th",{className:"px-4 py-3",children:"Contact"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:N.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-4 py-8 text-center text-slate-500",children:"No people found. Add someone to get started!"})}):N.map(g=>e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors group",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-slate-900",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500",children:[g.first_name[0],g.last_name?g.last_name[0]:""]}),g.first_name," ",g.last_name]})}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:g.role}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(Ye,{className:`hover:bg-opacity-80 border-0 ${Ys[g.status]||Ys.default}`,children:g.status})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[g.email&&e.jsx(ur,{className:"w-4 h-4 hover:text-slate-600 cursor-pointer",title:g.email}),g.phone&&e.jsx(mr,{className:"w-4 h-4 hover:text-slate-600 cursor-pointer",title:g.phone})]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs(kt,{children:[e.jsx(_t,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 opacity-0 group-hover:opacity-100","aria-label":"Open menu",children:e.jsx(On,{className:"w-4 h-4"})})}),e.jsxs(at,{align:"end",children:[e.jsx(be,{onClick:()=>{p(g),c(!0)},children:"Edit Details"}),e.jsx(be,{className:"text-rose-600 focus:text-rose-700",onClick:()=>j(g.id),children:"Delete"})]})]})})]},g.id))})]})}),(d||x)&&e.jsx(Sl,{open:d||!!x,onClose:()=>{c(!1),p(null)},onSave:f,initialData:x})]})}sn.propTypes={projectId:b.string.isRequired};const Zs={1:{bg:"bg-brand-500",light:"bg-brand-50 dark:bg-brand-950/30",text:"text-brand-600 dark:text-brand-400",border:"border-brand-200 dark:border-brand-800"},2:{bg:"bg-purple-500",light:"bg-purple-50 dark:bg-purple-950/30",text:"text-purple-600 dark:text-purple-400",border:"border-purple-200 dark:border-purple-800"},3:{bg:"bg-indigo-500",light:"bg-indigo-50 dark:bg-indigo-950/30",text:"text-indigo-600 dark:text-indigo-400",border:"border-indigo-200 dark:border-indigo-800"},4:{bg:"bg-emerald-500",light:"bg-emerald-50 dark:bg-emerald-950/30",text:"text-emerald-600 dark:text-emerald-400",border:"border-emerald-200 dark:border-emerald-800"},5:{bg:"bg-amber-500",light:"bg-amber-50 dark:bg-amber-950/30",text:"text-amber-600 dark:text-amber-400",border:"border-amber-200 dark:border-amber-800"},6:{bg:"bg-rose-500",light:"bg-rose-50 dark:bg-rose-950/30",text:"text-rose-600 dark:text-rose-400",border:"border-rose-200 dark:border-rose-800"}};function Pl({phase:t,tasks:s=[],milestones:r=[],isActive:a,onClick:n}){const i=t.position||t.order,l=Zs[i]||Zs[1],o=t.is_locked,d=s.filter(m=>r.some(f=>f.id===m.parent_task_id&&f.parent_task_id===t.id)),c=d.filter(m=>m.status===R.COMPLETED).length,x=d.length,p=x>0?Math.round(c/x*100):0,h=p===100&&x>0;return e.jsx(J.div,{whileHover:{scale:o?1:1.02},whileTap:{scale:o?1:.98},className:"h-full",children:e.jsxs(Se,{onClick:o?void 0:n,"data-testid":`phase-card-${t.id}`,className:w("p-5 transition-all duration-300 border-2 bg-card text-card-foreground h-full flex flex-col",o?"opacity-75 cursor-not-allowed border-muted bg-muted/30 text-muted-foreground":w("cursor-pointer",a?`${l.border} ${l.light} shadow-lg dark:bg-slate-800/50`:"border-border hover:border-brand-300 hover:shadow-lg")),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:w("w-10 h-10 rounded-xl flex items-center justify-center font-bold text-white shadow-sm",o?"bg-muted dark:bg-slate-700":l.bg),children:o?e.jsx(rs,{className:"w-5 h-5"}):h?e.jsx(Ue,{className:"w-5 h-5"}):i}),e.jsxs("div",{children:[e.jsx("h3",{className:w("font-semibold",o?"text-muted-foreground":"text-card-foreground"),children:t.title||t.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.length," milestones"]})]})]}),e.jsx(ze,{className:w("w-5 h-5 transition-colors",a&&!o?l.text:"text-muted-foreground/50")})]}),e.jsx("div",{className:"flex-grow",children:t.description&&e.jsx("p",{className:"text-sm text-muted-foreground mb-4 line-clamp-2",dangerouslySetInnerHTML:{__html:xt(t.description)}})}),e.jsx("div",{className:"space-y-2",children:o?e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground bg-muted p-2 rounded justify-center",children:[e.jsx(rs,{className:"w-3 h-3"}),e.jsxs("span",{children:["Complete Phase ",i-1," to unlock"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsxs("span",{className:w("font-medium",l.text),children:[p,"%"]})]}),e.jsx(rt,{value:p,className:w("h-2",l.light)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[c," of ",x," tasks"]})]})})]})})}function El({milestone:t,tasks:s=[],onTaskUpdate:r,onAddTask:a,onAddChildTask:n,onTaskClick:i,onInlineCommit:l,onInlineCancel:o,canEdit:d=!0}){const[c,x]=u.useState(!0),{setNodeRef:p,isOver:h}=Xe({id:`milestone-context-${t.id}`,data:{type:"container",parentId:t.id,origin:"milestone"}}),m=s.filter(g=>g.parent_task_id===t.id),f=m.filter(g=>g.status===R.COMPLETED).length,j=m.length,N=j>0?Math.round(f/j*100):0;return e.jsxs("div",{ref:p,className:w("border rounded-xl overflow-hidden transition-all duration-200",h?"border-brand-400 bg-brand-50/50 dark:bg-brand-900/20 ring-2 ring-brand-200 dark:ring-brand-800":"border-slate-200 bg-white shadow-sm hover:shadow-md"),children:[e.jsxs("button",{onClick:()=>x(!c),className:"w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(J.div,{animate:{rotate:c?90:0},transition:{duration:.2},children:e.jsx(ze,{className:"w-5 h-5 text-slate-400"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-semibold text-slate-900",children:t.title||t.name}),t.description&&e.jsx("p",{className:"text-sm text-slate-500 mt-0.5",children:t.description})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"hidden sm:flex items-center gap-3",children:[e.jsx("div",{className:"w-32",children:e.jsx(rt,{value:N,className:"h-2 bg-slate-100"})}),e.jsxs("span",{className:"text-sm font-medium text-slate-600 w-12 text-right",children:[N,"%"]})]}),t.is_locked&&e.jsx(Ye,{variant:"outline",className:"text-xs px-1.5 h-5 bg-slate-50 text-slate-500 border-slate-200",children:"Locked"}),e.jsxs(Ye,{variant:"secondary",className:"bg-slate-100 text-slate-600",children:[f,"/",j]})]})]}),e.jsx(yt,{children:c&&e.jsx(J.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},children:e.jsx("div",{className:"px-5 pb-4 border-t border-slate-100",children:m.length===0?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("p",{className:"text-slate-500 mb-4",children:"No tasks yet"}),d&&e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>a(t),children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Add Task"]})]}):e.jsxs("div",{className:"space-y-2 pt-4",children:[m.sort((g,v)=>(g.order||0)-(v.order||0)).map(g=>e.jsx(Ze,{task:g,onTaskClick:i,onStatusChange:(v,y)=>r(v,{status:y}),onAddChildTask:n,isAddingInline:g.isAddingInline,onInlineCommit:l,onInlineCancel:o},g.id)),d&&e.jsxs(P,{variant:"ghost",size:"sm",className:"w-full text-slate-500 hover:text-slate-700 mt-2",onClick:()=>a(t),children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Add Task"]})]})})})})]})}function Dl({open:t,onClose:s,onAdd:r,milestone:a,parentTask:n,teamMembers:i=[]}){const[l,o]=u.useState(!1),d={title:"",description:"",priority:"medium",due_date:null,assignee_id:null},[c,x]=u.useState(d),p=async h=>{if(h.preventDefault(),!!c.title.trim()){o(!0);try{const m={title:c.title,description:c.description,priority:c.priority,due_date:c.due_date?Ne(c.due_date,"yyyy-MM-dd"):null,assignee_id:c.assignee_id||null};await r({...m,milestone:a}),x(d),s()}catch(m){console.error("Failed to create task",m)}finally{o(!1)}}};return e.jsx(ke,{open:t,onOpenChange:s,children:e.jsxs(fe,{className:"sm:max-w-lg max-h-[85vh] overflow-y-auto bg-card text-card-foreground",children:[e.jsxs(je,{children:[e.jsxs(ye,{children:["Add ",n?"Subtask":"Task"]}),a&&!n&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Adding to: ",a.title||a.name]}),n&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Subtask of: ",n.title]})]}),e.jsxs("form",{onSubmit:p,className:"space-y-5 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"title",children:"Task Title *"}),e.jsx(Y,{id:"title",placeholder:"What needs to be done?",value:c.title,onChange:h=>x({...c,title:h.target.value}),className:"h-11"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"description",children:"Description"}),e.jsx(Ae,{id:"description",placeholder:"Add details or instructions...",value:c.description,onChange:h=>x({...c,description:h.target.value}),className:"resize-none h-24"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Priority"}),e.jsxs(ft,{value:c.priority,onValueChange:h=>x({...c,priority:h}),children:[e.jsx(Be,{className:"h-11",children:e.jsx(gt,{})}),e.jsxs(Ve,{children:[e.jsx(xe,{value:"low",children:"Low"}),e.jsx(xe,{value:"medium",children:"Medium"}),e.jsx(xe,{value:"high",children:"High"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Due Date"}),e.jsxs($t,{children:[e.jsx(qt,{asChild:!0,children:e.jsxs(P,{variant:"outline",className:w("w-full justify-start text-left font-normal h-11",!c.due_date&&"text-muted-foreground"),children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),c.due_date?Ne(c.due_date,"PPP"):"Select date"]})}),e.jsx(wt,{className:"w-auto p-0",align:"start",children:e.jsx(Bt,{mode:"single",selected:c.due_date,onSelect:h=>x({...c,due_date:h}),initialFocus:!0})})]})]})]}),i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Assign To"}),e.jsxs(ft,{value:c.assignee_id||"unassigned",onValueChange:h=>x({...c,assignee_id:h==="unassigned"?null:h}),children:[e.jsx(Be,{className:"h-11",children:e.jsx(gt,{placeholder:"Select team member"})}),e.jsxs(Ve,{children:[e.jsx(xe,{value:"unassigned",children:"Unassigned"}),i.map(h=>e.jsx(xe,{value:h.user_id||h.id,children:h.name||h.email||"Unknown Member"},h.id))]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:s,children:"Cancel"}),e.jsx(P,{type:"submit",disabled:!c.title.trim()||l,className:"bg-orange-500 hover:bg-orange-600",children:l?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"mr-2 h-4 w-4 animate-spin"}),"Adding..."]}):"Add Task"})]})]})]})})}function Ml({task:t,isOpen:s,onClose:r,onAddChildTask:a,onEditTask:n,onDeleteTask:i,onTaskUpdated:l,allProjectTasks:o=[],canEdit:d=!0}){if(!t)return null;const c=o.find(x=>x.id===t.id)||t;return e.jsx(ke,{open:s,onOpenChange:r,children:e.jsxs(fe,{className:"max-w-2xl max-h-[85vh] overflow-y-auto p-0 gap-0 bg-card text-card-foreground",children:[e.jsx(je,{className:"px-6 py-4 border-b border-border sticky top-0 bg-card z-10",children:e.jsx(ye,{className:"text-lg font-bold text-card-foreground leading-snug pr-8",children:c.title})}),e.jsx("div",{className:"pt-2",children:e.jsx(xa,{task:c,onAddChildTask:a,onEditTask:n,onDeleteTask:i,onTaskUpdated:l,allProjectTasks:o,canEdit:d})})]})})}function Rl(t,s,r){if(!s)return null;if(t.data.current?.type==="User"){const a=t.data.current.member.userId||t.data.current.member.id,n=s.id;if(r.find(l=>l.id===n))return{taskId:n,userId:a}}return null}function Il(){const{id:t}=cs(),[s,r]=u.useState("board"),[a,n]=u.useState(null),[i,l]=u.useState(null),[o,d]=u.useState({open:!1,milestone:null}),[c,x]=u.useState(new Set),[p,h]=u.useState(null),[m,f]=u.useState(null),[j,N]=u.useState(!1),{toast:g}=Nt(),v=Te();Ra({projectId:t,refreshProjectDetails:()=>{v.invalidateQueries({queryKey:["projectHierarchy",t]})}});const{user:y}=ce(),{project:k,loadingProject:D,phases:T,milestones:A,tasks:S,teamMembers:O}=Tl(t),q=k?.owner_id===y?.id||k?.creator===y?.id,M=O?.find(C=>C.user_id===y?.id)?.role||(q?$.OWNER:$.VIEWER),z=M===$.OWNER||M===$.ADMIN||M===$.EDITOR,K=M===$.OWNER||M===$.ADMIN||M===$.EDITOR,U=M===$.OWNER||M===$.ADMIN,_=oe({mutationFn:({id:C,data:B})=>I.entities.Task.update(C,B),onSuccess:()=>{v.invalidateQueries({queryKey:["projectHierarchy",t]})},onError:C=>{g({title:"Failed to update task",description:C.message,variant:"destructive"})}}),F=oe({mutationFn:C=>I.entities.Task.delete(C),onSuccess:()=>{l(null),v.invalidateQueries({queryKey:["projectHierarchy",t]}),g({title:"Task deleted",variant:"default"})},onError:C=>{g({title:"Failed to delete task",description:C.message,variant:"destructive"})}}),H=oe({mutationFn:({taskId:C,userId:B})=>I.entities.Task.addMember(C,B,"viewer"),onSuccess:()=>{g({title:"Member assigned to task",variant:"default"}),v.invalidateQueries({queryKey:["projectHierarchy",t]})},onError:C=>{console.error(C),g({title:"Failed to assign member",description:C.message||"API might be missing",variant:"destructive"})}}),Pe=oe({mutationFn:C=>I.entities.Task.create(C),onSuccess:()=>{v.invalidateQueries({queryKey:["projectHierarchy",t]})},onError:C=>{g({title:"Failed to create task",description:C.message,variant:"destructive"})}}),X=[...T].sort((C,B)=>(C.position||0)-(B.position||0)),Z=a||X[0],ve=u.useMemo(()=>A?.sort((C,B)=>new Date(C.due_date)-new Date(B.due_date))||[],[A]).filter(C=>C.parent_task_id===Z?.id).sort((C,B)=>(C.position||0)-(B.position||0)),te=(C,B)=>{_.mutate({id:C,data:B})},ae=C=>{l(C)},Vt=(C,B)=>{const se=new Set(c);B?se.add(C.id):se.delete(C.id),x(se)},Ct=C=>({...C,isExpanded:c.has(C.id)||m===C.id,isAddingInline:m===C.id,children:S.filter(B=>B.parent_task_id===C.id).map(Ct).sort((B,se)=>(B.position||0)-(se.position||0))}),zt=async C=>{try{if(!o.milestone)return;const B={...C};delete B.milestone;const se=o.parentTask?.id||o.milestone?.id;await Pe.mutateAsync({...B,root_id:t,status:R.TODO,parent_task_id:se}),o.parentTask&&x(it=>{const L=new Set(it);return L.add(o.parentTask.id),L}),d({open:!1,milestone:null,parentTask:null}),g({title:"Task created successfully",variant:"default"})}catch(B){g({title:"Failed to create task",description:B.message,variant:"destructive"}),console.error(B)}},Kt=C=>{f(C.id),x(B=>{const se=new Set(B);return se.add(C.id),se})},Ht=async(C,B)=>{try{await Pe.mutateAsync({title:B,root_id:t,status:"todo",parent_task_id:C,origin:"instance",priority:"medium",description:""}),f(null)}catch(se){console.error("Inline create failed",se),g({title:"Failed to create task",variant:"destructive"})}},Wt=Rt(Je(It,{activationConstraint:{distance:8}})),Gt=C=>{C.active.data.current?.type==="User"&&h(C.active.data.current.member)},ot=C=>{h(null);const{active:B,over:se}=C,it=Rl(B,se,S);it&&H.mutate(it)};return D||!k?e.jsx(pe,{children:e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ie,{className:"w-8 h-8 animate-spin text-orange-500"})})}):e.jsxs(pe,{selectedTaskId:t,children:[e.jsxs(At,{sensors:Wt,collisionDetection:Lt,onDragStart:Gt,onDragEnd:ot,children:[e.jsx(Ut,{project:k,tasks:S,teamMembers:O,canInvite:K,canManageSettings:U,onInviteMember:()=>N(!0)}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx(Cl,{activeTab:s,onTabChange:r}),s==="board"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Phases"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:X.map(C=>e.jsx("div",{children:e.jsx(Pl,{phase:C,tasks:S,milestones:A.filter(B=>B.parent_task_id===C.id),isActive:Z?.id===C.id,onClick:()=>n(C)})},C.id))})]}),Z&&e.jsxs(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:["Phase ",Z.position,": ",Z.title||Z.name]}),Z.description&&e.jsx("p",{className:"text-slate-600 mt-1",children:Z.description})]})}),e.jsx("div",{className:"space-y-4",children:ve.length===0?e.jsx("div",{className:"bg-white dark:bg-card rounded-xl border border-slate-200 dark:border-border shadow-sm p-12 text-center",children:e.jsx("p",{className:"text-slate-500 dark:text-muted-foreground",children:"No milestones in this phase yet"})}):ve.map(C=>e.jsx(El,{milestone:C,tasks:S.map(Ct),onTaskUpdate:z?te:null,onToggleExpand:Vt,onAddTask:z?B=>d({open:!0,milestone:B}):null,onAddChildTask:z?Kt:null,onTaskClick:ae,phase:Z,onInlineCommit:z?Ht:null,onInlineCancel:()=>f(null),canEdit:z},C.id))})]})]}),s==="people"&&e.jsx(sn,{projectId:t,canEdit:z})]}),er.createPortal(e.jsx(br,{children:p&&e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full border-2 border-brand-200 bg-brand-100 text-xs font-medium text-brand-700 shadow-xl cursor-grabbing scale-110 z-50",children:p.avatar_url?e.jsx("img",{src:p.avatar_url,alt:"member",className:"w-full h-full rounded-full object-cover"}):e.jsx("span",{children:(p.first_name?.[0]||"")+(p.last_name?.[0]||"")})})}),document.body)]}),e.jsx(Dl,{open:o.open,onClose:()=>d({open:!1,milestone:null,parentTask:null}),onAdd:zt,milestone:o.milestone,parentTask:o.parentTask,teamMembers:O}),e.jsx(Ml,{task:i,isOpen:!!i,onClose:()=>l(null),onAddChildTask:()=>{},onEditTask:()=>{},onDeleteTask:C=>{window.confirm(`Delete "${C.title||"this task"}"? This cannot be undone.`)&&F.mutate(C.id)},onTaskUpdated:(C,B)=>_.mutate({id:C,data:B}),allProjectTasks:S,canEdit:z}),j&&e.jsx(ba,{project:k,onClose:()=>N(!1),onInviteSuccess:()=>{v.invalidateQueries({queryKey:["projectHierarchy",t]})}})]})}function Al(){const s=new URLSearchParams(window.location.search).get("project"),[r,a]=u.useState(!1),{toast:n}=Nt(),i=Te(),{data:l}=de({queryKey:["project",s],queryFn:()=>I.entities.Project.filter({id:s}).then(p=>p[0]),enabled:!!s}),{data:o=[],isLoading:d}=de({queryKey:["teamMembers",s||"all"],queryFn:()=>s?I.entities.TeamMember.filter({project_id:s}):I.entities.TeamMember.list()}),c=oe({mutationFn:p=>I.entities.TeamMember.delete(p),onSuccess:()=>{i.invalidateQueries({queryKey:["teamMembers",s||"all"]}),n({title:"Member removed successfully"})}}),x=oe({mutationFn:p=>I.entities.TeamMember.create(p),onSuccess:()=>{i.invalidateQueries({queryKey:["teamMembers",s||"all"]}),a(!1),n({title:"Member added successfully"})}});return d?e.jsx(pe,{children:e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ie,{className:"w-8 h-8 animate-spin text-brand-600"})})}):e.jsx(pe,{selectedTaskId:s,children:e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"bg-card border-b border-border",children:e.jsx("div",{className:"max-w-5xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[s&&e.jsx(he,{to:Ce(`Project?id=${s}`),children:e.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",children:e.jsx(ar,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:s?"Project Team":"All Team Members"}),l&&e.jsx("p",{className:"text-muted-foreground mt-1",children:l.name}),!s&&e.jsx("p",{className:"text-muted-foreground mt-1",children:"People collaborating across your projects"})]})]}),s&&e.jsxs(P,{onClick:()=>a(!0),className:"bg-brand-600 hover:bg-brand-700 text-white shadow-lg shadow-brand-500/20",children:[e.jsx(ss,{className:"w-5 h-5 mr-2"}),"Add Member"]})]})})}),e.jsx("div",{className:"max-w-5xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx(yt,{children:o.map((p,h)=>e.jsx(J.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{delay:h*.05},children:e.jsxs(Se,{className:"p-6 bg-card border border-border shadow-sm hover:shadow-md transition-all duration-300 group",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-muted/50 rounded-full flex items-center justify-center border-2 border-background shadow-sm ring-2 ring-muted",children:e.jsx(Me,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs(kt,{children:[e.jsx(_t,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-foreground",children:e.jsx($n,{className:"w-4 h-4"})})}),e.jsx(at,{align:"end",children:e.jsx(be,{className:"text-rose-600 focus:text-rose-700 focus:bg-rose-50 dark:focus:bg-rose-900/40",onClick:()=>c.mutate(p.id),children:"Remove from team"})})]})]}),e.jsx("h3",{className:"text-lg font-bold text-foreground mb-1",children:p.name||"Unknown Name"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsx("span",{className:"px-2.5 py-0.5 rounded-full text-xs font-semibold bg-white dark:bg-slate-950 border border-brand-200 dark:border-brand-800 text-brand-700 dark:text-brand-300",children:p.role||"Member"}),p.is_lead&&e.jsx("span",{className:"px-2.5 py-0.5 rounded-full text-xs font-semibold bg-white dark:bg-slate-950 border border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300",children:"Lead"})]}),e.jsxs("div",{className:"space-y-2 mt-4 pt-4 border-t border-border",children:[p.email&&e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ur,{className:"w-4 h-4 mr-2"}),p.email]}),p.phone&&e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(mr,{className:"w-4 h-4 mr-2"}),p.phone]})]})]})},p.id))}),o.length===0&&e.jsxs("div",{className:"col-span-full py-20 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-muted/30 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(Me,{className:"w-10 h-10 text-muted-foreground/50"})}),e.jsx("h3",{className:"text-xl font-bold text-foreground mb-2",children:"Build your team"}),e.jsx("p",{className:"text-muted-foreground mb-8 max-w-sm mx-auto",children:s?"Add members to collaborate on this project.":"No team members found across your projects."}),s&&e.jsxs(P,{onClick:()=>a(!0),className:"bg-brand-600 hover:bg-brand-700 text-white",children:[e.jsx(ss,{className:"w-5 h-5 mr-2"}),"Add First Member"]})]})]})}),e.jsx(ke,{open:r,onOpenChange:a,children:e.jsxs(fe,{className:"bg-card text-card-foreground border-border",children:[e.jsxs(je,{children:[e.jsx(ye,{children:"Add Team Member"}),e.jsx(et,{children:"Fill in the details below to add a new member."})]}),e.jsxs("form",{onSubmit:p=>{p.preventDefault();const h=new FormData(p.target);x.mutate({project_id:s,name:h.get("name"),email:h.get("email"),role:h.get("role")})},className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Full Name"}),e.jsx(Y,{name:"name",placeholder:"Enter name",required:!0,className:"bg-background border-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Email Address"}),e.jsx(Y,{name:"email",type:"email",placeholder:"Enter email",className:"bg-background border-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Role"}),e.jsx(Y,{name:"role",placeholder:"e.g. Lead, Coordinator, Volunteer",className:"bg-background border-input"})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(P,{type:"button",variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsx(P,{type:"submit",className:"bg-brand-600 hover:bg-brand-700 text-white",disabled:x.isPending,children:x.isPending?"Adding...":"Add Member"})]})]})]})})]})})}const Ll=Xs.lazy(()=>Jr(()=>import("./Reports-D6C0vpPD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58]))),Ol=Xs.lazy(()=>Jr(()=>import("./Settings-BTojFgnO.js"),__vite__mapDeps([59,1,2,42,43,40,44,45,46,47,48,49,6,7,50,19,4,32,33,34,36,37,38,39,35,41,51,8,52,53,3,54,55,56,5,9,10,11,12,13,14,15,16,17,18,20,21,22,23,24,25,26,27,28,29,30,31,57,58]))),De=({children:t})=>{const{user:s,loading:r}=ce();return r?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsx("div",{className:"text-center text-primary",children:"Loading..."})}):s?t:e.jsx(dt,{to:"/login"})},$l=()=>{const{user:t,loading:s}=ce();return s?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsx("div",{className:"text-center text-primary",children:"Loading..."})}):e.jsx(u.Suspense,{fallback:e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsx(sa,{})}),children:e.jsxs(ln,{children:[e.jsx(ue,{path:"/login",element:t?e.jsx(dt,{to:"/dashboard"}):e.jsx(qo,{})}),e.jsx(ue,{path:"/",element:t?e.jsx(dt,{to:"/dashboard",replace:!0}):e.jsx(Qs,{})}),e.jsx(ue,{path:"/about",element:t?e.jsx(dt,{to:"/dashboard",replace:!0}):e.jsx(Qs,{})}),e.jsx(ue,{path:"/dashboard",element:e.jsx(De,{children:e.jsx(_l,{})})}),e.jsx(ue,{path:"/project/:id",element:e.jsx(De,{children:e.jsx(Il,{})})}),e.jsx(ue,{path:"/reports",element:e.jsx(De,{children:e.jsx(Ll,{})})}),e.jsx(ue,{path:"/settings",element:e.jsx(De,{children:e.jsx(Ol,{})})}),e.jsx(ue,{path:"/team",element:e.jsx(De,{children:e.jsx(Al,{})})}),e.jsx(ue,{path:"/tasks",element:e.jsx(De,{children:e.jsx(ml,{})})}),e.jsx(ue,{path:"/board",element:e.jsx(De,{children:e.jsx(ol,{})})}),e.jsx(ue,{path:"/report/:projectId",element:e.jsx(De,{children:e.jsx(ul,{})})}),e.jsx(ue,{path:"*",element:e.jsx(dt,{to:"/",replace:!0})})]})})};function ql(){return e.jsx("div",{className:"App min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-200",children:e.jsx(So,{children:e.jsxs(_o,{children:[!1,e.jsx(Io,{children:e.jsx(To,{children:e.jsx(ds,{FallbackComponent:ws,onReset:()=>window.location.reload(),children:e.jsx($l,{})})})})]})})})}const Fl=new oo({defaultOptions:{queries:{staleTime:1e3*60*2,retry:1,refetchOnWindowFocus:!1},mutations:{retry:0}}});window.supabase=Q;const Ul=an.createRoot(document.getElementById("root"));Ul.render(e.jsx(u.StrictMode,{children:e.jsx(dn,{children:e.jsx(io,{client:Fl,children:e.jsx(ql,{})})})}));export{P as B,Se as C,pe as D,Y as I,V as L,rt as P,R as T,w as a,Nt as b,Ce as c,I as p,ce as u};
